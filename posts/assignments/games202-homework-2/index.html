<!doctype html><html lang=zh dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Assignment 5. GAMES202 Homework 2 | The Only Problem's Blog</title><meta name=keywords content="GAMES202"><meta name=description content="
(∩^o^)⊃━☆ﾟ.*･｡

0x00 To begin with
这篇文章将会包含以下内容：

 部分课程内容回顾
 GAMES202 作业 2

For reference👇：

📺B 站视频：







  
  GAMES202-高质量实时渲染


📦代码仓库：







  
  congyuxiaoyoudao/GAMES202_Homework at working


📃







  
  The rendering equation | ACM SIGGRAPH Computer Graphics


📃







  
  Precomputed radiance transfer for real-time rendering in dynamic, low-frequency lighting environments | ACM Transactions on Graphics




master 分支上是 202 全部作业汇总，working 分支用于提交代码。需要原始作业可下载 master 分支的包

0x01 前置准备 Warm Up
渲染方程 Render Equation
James T. Kajiya（没错就是那个提出 Kajiya-Kay 头发着色模型的 Kajiya）在 1986 年提出了渲染方程（The Render Equation），原论文里长这样：
$$
I(x,x')=g(x,x')\left[ \epsilon(x,x')+\int_{S}\rho(x,x',x'')I(x',x'')dx'' \right]
$$
当然现在看得更舒服的形式长这样："><meta name=author content="The Only Problem"><link rel=canonical href=https://congyuxiaoyoudao.github.io/posts/assignments/games202-homework-2/><link crossorigin=anonymous href=/assets/css/stylesheet.452758010f0b7fc9ad7fa528ffdfdd8eb9e830816fb8c8119f16f39583297db8.css integrity="sha256-RSdYAQ8Lf8mtf6Uo/9/djrnoMIFvuMgRnxbzlYMpfbg=" rel="preload stylesheet" as=style><link rel=icon href=https://congyuxiaoyoudao.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://congyuxiaoyoudao.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://congyuxiaoyoudao.github.io/favicon-32x32.png><link rel=apple-touch-icon href=https://congyuxiaoyoudao.github.io/apple-touch-icon.png><link rel=mask-icon href=https://congyuxiaoyoudao.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=zh href=https://congyuxiaoyoudao.github.io/posts/assignments/games202-homework-2/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.16.10/dist/katex.min.css integrity=sha384-wcIxkf4k558AjM3Yz3BBFQUbk/zgIYC2R0QpeeYb+TwlBVMrlgLqwRjRtGZiK7ww crossorigin=anonymous><script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.10/dist/katex.min.js integrity=sha384-hIoBPJpTUs74ddyc4bFZSM1TVlQDA60VBbJS0oA934VSz82sBx1X7kSx2ATBDIyd crossorigin=anonymous></script><script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.10/dist/contrib/auto-render.min.js integrity=sha384-43gviWU0YVjaDtb/GhzOouOXtZMP/7XUzwPTstBeZFe/+rCMvRwr4yROQP43s0Xk crossorigin=anonymous onload='window.addEventListener("DOMContentLoaded",function(){renderMathInElement(document.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1},{left:"\\$$",right:"\\\\$$",display:!1},{left:"\\$$",right:"\\\\$$",display:!0}]})})'></script><link rel=preconnect href=https://fonts.googleapis.com><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:ital,wght@0,100..800;1,100..800&display=swap" rel=stylesheet><link rel=stylesheet href=https://cdn.bootcdn.net/ajax/libs/lxgw-wenkai-screen-webfont/1.7.0/style.min.css><meta property="og:url" content="https://congyuxiaoyoudao.github.io/posts/assignments/games202-homework-2/"><meta property="og:site_name" content="The Only Problem's Blog"><meta property="og:title" content="Assignment 5. GAMES202 Homework 2"><meta property="og:description" content=" (∩^o^)⊃━☆ﾟ.*･｡
0x00 To begin with 这篇文章将会包含以下内容：
部分课程内容回顾 GAMES202 作业 2 For reference👇：
📺B 站视频： GAMES202-高质量实时渲染 📦代码仓库： congyuxiaoyoudao/GAMES202_Homework at working 📃 The rendering equation | ACM SIGGRAPH Computer Graphics 📃 Precomputed radiance transfer for real-time rendering in dynamic, low-frequency lighting environments | ACM Transactions on Graphics master 分支上是 202 全部作业汇总，working 分支用于提交代码。需要原始作业可下载 master 分支的包
0x01 前置准备 Warm Up 渲染方程 Render Equation James T. Kajiya（没错就是那个提出 Kajiya-Kay 头发着色模型的 Kajiya）在 1986 年提出了渲染方程（The Render Equation），原论文里长这样：
$$ I(x,x')=g(x,x')\left[ \epsilon(x,x')+\int_{S}\rho(x,x',x'')I(x',x'')dx'' \right] $$ 当然现在看得更舒服的形式长这样："><meta property="og:locale" content="zh"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2025-04-19T00:00:00+00:00"><meta property="article:modified_time" content="2025-04-19T00:00:00+00:00"><meta property="article:tag" content="GAMES202"><meta name=twitter:card content="summary"><meta name=twitter:title content="Assignment 5. GAMES202 Homework 2"><meta name=twitter:description content="
(∩^o^)⊃━☆ﾟ.*･｡

0x00 To begin with
这篇文章将会包含以下内容：

 部分课程内容回顾
 GAMES202 作业 2

For reference👇：

📺B 站视频：







  
  GAMES202-高质量实时渲染


📦代码仓库：







  
  congyuxiaoyoudao/GAMES202_Homework at working


📃







  
  The rendering equation | ACM SIGGRAPH Computer Graphics


📃







  
  Precomputed radiance transfer for real-time rendering in dynamic, low-frequency lighting environments | ACM Transactions on Graphics




master 分支上是 202 全部作业汇总，working 分支用于提交代码。需要原始作业可下载 master 分支的包

0x01 前置准备 Warm Up
渲染方程 Render Equation
James T. Kajiya（没错就是那个提出 Kajiya-Kay 头发着色模型的 Kajiya）在 1986 年提出了渲染方程（The Render Equation），原论文里长这样：
$$
I(x,x')=g(x,x')\left[ \epsilon(x,x')+\int_{S}\rho(x,x',x'')I(x',x'')dx'' \right]
$$
当然现在看得更舒服的形式长这样："><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://congyuxiaoyoudao.github.io/posts/"},{"@type":"ListItem","position":2,"name":"Assignments","item":"https://congyuxiaoyoudao.github.io/posts/assignments/"},{"@type":"ListItem","position":3,"name":"Assignment 5. GAMES202 Homework 2","item":"https://congyuxiaoyoudao.github.io/posts/assignments/games202-homework-2/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Assignment 5. GAMES202 Homework 2","name":"Assignment 5. GAMES202 Homework 2","description":" (∩^o^)⊃━☆ﾟ.*･｡\n0x00 To begin with 这篇文章将会包含以下内容：\n部分课程内容回顾 GAMES202 作业 2 For reference👇：\n📺B 站视频： GAMES202-高质量实时渲染 📦代码仓库： congyuxiaoyoudao/GAMES202_Homework at working 📃 The rendering equation | ACM SIGGRAPH Computer Graphics 📃 Precomputed radiance transfer for real-time rendering in dynamic, low-frequency lighting environments | ACM Transactions on Graphics master 分支上是 202 全部作业汇总，working 分支用于提交代码。需要原始作业可下载 master 分支的包\n0x01 前置准备 Warm Up 渲染方程 Render Equation James T. Kajiya（没错就是那个提出 Kajiya-Kay 头发着色模型的 Kajiya）在 1986 年提出了渲染方程（The Render Equation），原论文里长这样：\n$$ I(x,x')=g(x,x')\\left[ \\epsilon(x,x')+\\int_{S}\\rho(x,x',x'')I(x',x'')dx'' \\right] $$ 当然现在看得更舒服的形式长这样：\n","keywords":["GAMES202"],"articleBody":" (∩^o^)⊃━☆ﾟ.*･｡\n0x00 To begin with 这篇文章将会包含以下内容：\n部分课程内容回顾 GAMES202 作业 2 For reference👇：\n📺B 站视频： GAMES202-高质量实时渲染 📦代码仓库： congyuxiaoyoudao/GAMES202_Homework at working 📃 The rendering equation | ACM SIGGRAPH Computer Graphics 📃 Precomputed radiance transfer for real-time rendering in dynamic, low-frequency lighting environments | ACM Transactions on Graphics master 分支上是 202 全部作业汇总，working 分支用于提交代码。需要原始作业可下载 master 分支的包\n0x01 前置准备 Warm Up 渲染方程 Render Equation James T. Kajiya（没错就是那个提出 Kajiya-Kay 头发着色模型的 Kajiya）在 1986 年提出了渲染方程（The Render Equation），原论文里长这样：\n$$ I(x,x')=g(x,x')\\left[ \\epsilon(x,x')+\\int_{S}\\rho(x,x',x'')I(x',x'')dx'' \\right] $$ 当然现在看得更舒服的形式长这样：\n$$ L_{o}(p,\\omega_{o})=L_{e}(p,\\omega_{o})+\\int_{\\Omega^+}L_{i}(p,\\omega_{i})f_{r}(p,\\omega_{i},\\omega_{o})\\cos\\theta_{i}\\space d\\omega_{i} $$ 其中：\n$L_{o}(p,\\omega_{o})$：要求出射方向的辐射率（Radience） $L_{e}(p,\\omega_{o})$：自发光项 $\\Omega^+$：积分域，仅对表面正半球积分 $L_{i}(p,\\omega_{i})$：Lighting，某一入射方向的辐射率 $f_{r}(p,\\omega_{i},\\omega_{o})$：BRDF，描述某一入射方向的光线在出射方向的贡献 $\\cos \\theta_{i}$：表面法向与某一入射方向形成的夹角余弦 所以渲染方程其实就描述了在当前 Shading Point 上，给定入射光与出射方向（观察方向），在出射方向上能够接收到的 Radiance，任何在表面上进行的光线传播的 Shading 都需要解这个方程。\nSplit Sum 对于环境光，通常使用 CubeMap 或者等距柱形投影将图像投射到无限远的球面上，要获得环境光的 Shading（目前暂不考虑 Shadowing），就需要求解渲染方程，核心是对于 Lighting 部分的求解。\n先抛开渲染方程，想象一下当表面是理想镜面的情况：对于某个 Shading Point，其反射行为是镜面反射，那么我们可以很容易地求出射方向对应的入射方向，根据这个方向查询环境光的颜色。\n更 General 一点，当表面比较粗糙的情况，能够反射到出射方向的入射角在镜反射方向上会在某个角度 $\\phi$ 范围内抖动分布，最终反射到出射方向的 Lighting 受到这个范围内所有采样点颜色的影响。这个过程可以类比于对原始的环境贴图进行滤波，且粗糙度越大，滤波核越大，这样就可以仍使用镜反射方向查询滤波后的图像。这些滤波后的图像当然可以预计算，形成一个模糊层级，然后渲染时根据不同粗糙度使用不同图像。\n但是目前 Lighting 项在积分内部，也就是说我们要对整个半球面上的入射方向都进行一次查询，还是比较 Costy 的，有没有办法把 Lighting 从积分里独立出来？下面有一种近似方法：\n$$ \\int_{\\Omega}f(x)g(x)dx\\approx \\frac{\\int_{\\Omega_{G}}f(x)dx}{\\int_{\\Omega_{G}}dx} \\cdot \\int_{\\Omega}g(x)dx $$ 这个近似在 $g(x)$ 贡献比较小或者比较平滑（低频）时是相对准确的。漫反射 BRDF 就很好地满足这个性质，所以可以对渲染方程应用这个近似：\n$$ L_{o}(p,\\omega_{o})\\approx\\frac{\\int_{\\Omega_{f_{r}}}L_{i}(p,\\omega_{i})d\\omega_{i}}{\\int_{\\Omega_{f_{r}}}d\\omega_{i}}\\cdot \\int_{\\Omega^+}f_{r}(p,\\omega_{i},\\omega_{o})\\cos \\theta_{i} \\space d\\omega_{i} $$ 乘号左边的部分代表 Lighting 在 BRDF 范围内的平均 Radience，可以认为是对出射方向有贡献的入射方向范围内在环境贴图上采样颜色的平均值。通过对环境贴图的预滤波，可以通过一次查询得到这个值。\n球谐函数 Spherical Harmonics 球谐函数 维基百科上球谐函数是下面这个式子在 $m,l$ 不同取值时的解：\n$$ Y^m_{l}(\\theta, \\phi)=(-1)^m\\sqrt{ \\frac{2l+1}{4\\pi}\\frac{(l-|m|)!}{(l+|m|)!} }P^m_{l}(\\cos \\theta)e^{im\\phi} $$ 实数形式下可视化出来是长这样的：\n看上去是不是很像物理/量子化学里面的电子云啥的（这俩还真有关系），但在图形学里面，我们不需要理解其物理意义，可以简单将其理解为一组定义在球面上的两两正交的基函数，有了它我们可以使用傅里叶变换的思想去拟合任何的球面函数。\n基函数（Basis Function）：一组两两之间相互独立的函数，即在彼此之上的投影为 0，可以类比线性代数的基向量。一组基函数张成的空间是其经过线性组合能够表示的所有函数的集合\n$$ \\mathcal{F} = \\left\\{ f(x) = \\sum_{i=1}^n c_{i}B_{i}(x) \\,\\middle|\\, c_{i} \\in \\mathbb{R} \\right\\} $$ 可以通过将原函数投影到某个基函数上获取该基函数前的系数 $c_{i}$：\n$$ c_{i}=\\int_{\\Omega}f(x)B_{i}(x)\\,dx $$ 实际使用时需要把积分离散化为一系列求和的形式，给定一个函数 $f(\\omega_{i})$，可以通过投影求得其在 $Y^m_{l}(\\omega_{i})$ 上的系数：\n$$ c^m_{l}\\approx\\sum_{i=1}^Nf(\\omega_{i})\\cdot Y^m_{l}(\\omega_{i})\\cdot \\omega_{i} $$ 然后就可以用类似泰勒展开的样子用基函数表示原函数：\n$$ \\begin{aligned} f(x)=\u0026\\sum^{\\infty}_{l=0}\\sum^l_{m=-l}c^m_{l}\\cdot Y^m_{l}(\\omega_{i}) \\\\ =\u0026 \\, c^0_{0}Y^0_{0}(\\omega_{i})+c^1_{-1}Y^1_{-1}(\\omega_{i})+c^1_{0}Y^1_{0}(\\omega_{i})+\\,\\dots \\end{aligned} $$ 对于低频的函数，只取前几项进行近似，就能达到 Adequate 的效果。如果 BRDF 是粗糙的，就相当于一个低通滤波器，其和 Lighting 的乘积的积分仍然是低频的。\nPRT（Precomputerd Radience Transfer） 球谐函数用一组基函数拟合渲染方程中的 Lighting 项，解决了 Shading 的问题，如果需要 Shadowing，就需要加入可见性项 $V(p,\\omega_{i})$，渲染方程变为：\n$$ L_{o}(p,\\omega_{o})=\\int_{\\Omega} \\underbrace {L_{i}(p,\\omega_{i})}_{Lighting} \\, \\underbrace {f_{r}(p,\\omega_{i},\\omega_{o})}_{BRDF} \\, \\underbrace {V(p,\\omega_{i})}_{Visibility} \\, \\max(0,\\cos \\theta_{i})\\,d\\omega_{i} $$ 暴力算法就是朝各个方向分别对 Lighting，BRDF 和 Visibility 计算，然后再逐项相乘，开销太大。Sloan 在 2002 年提出了PRT（Precomputed Radience Transfer），将积分内部分为 Lighting 和 Light Transport（光线传输）两个部分：\n$$ L_{o}(p,\\omega_{o})=\\int_{\\Omega} \\underbrace {L_{i}(p,\\omega_{i})}_{Lighting} \\, \\underbrace {f_{r}(p,\\omega_{i},\\omega_{o}) \\, V(p,\\omega_{i}) \\, \\max(0,\\cos \\theta_{i})}_{Light \\,Transport} \\, d\\omega_{i} $$ 假设 BRDF 项是 Diffuse 的，BRDF 项是一个定值 $\\frac{\\rho}{\\pi}$，将 Lighting 表示为系数和基函数的形式，然后交换积分与求和的位置，就可以将积分内部再次表示为在基函数上的投影：\n$$ \\begin{aligned} L(p,\\omega_{o})=\u0026 \\frac{\\rho}{\\pi} \\int_{\\Omega}\\sum l_{i}B_{i}(\\omega_{i})V(p,\\omega_{i})\\max(0,\\cos \\theta_{i}) \\, d\\omega_{i} \\\\ \\approx\u0026 \\frac{\\rho}{\\pi} \\sum l_{i} \\underbrace{ \\int_{\\Omega}B_{i}(\\omega_{i})V(p,\\omega_{i})\\max(0,\\cos \\theta_{i}) }_{Precomputed} \\, d\\omega_{i} \\\\ \\approx\u0026 \\frac{\\rho}{\\pi} \\sum l_{i}T_{i} \\end{aligned} $$ 注意这里是对 $\\omega_{i}$ 进行积分，对每一个基函数上的投影进行求和\n其中 $l_{i}$ 是 Lighting 项在基函数上投影的一组系数，$T_{i}$ 是 Light Transport 项在基函数上投影的系数。这样就把多个函数乘积的积分转变为一个简单的点乘。\n然而这些预计算需要一些前提：\nVisibility 是固定的，即要求场景中的物体不能动 Lighting 是“固定”的，Lighting 的成分不能动态变化，但 Lighting 可以旋转（相当于对基函数张成的线性空间进行旋转） 很合理，就像烘焙的光照信息是静态的一样。\n0x02 预计算球谐系数 Precompute SH Coef 光照项系数 Lighting 要算 SH 系数，就要把环境光照投影到球谐函数上，球谐函数可以调用 sh::EvalSH 获取，Lighting 项可以通过预存的 images 数组获取，剩下一个立体角 $d\\omega_{i}$：\n$$ d\\omega_{i}=\\sin \\theta \\, d\\theta \\, d\\phi $$ 其中 $\\theta$ 是极角，$\\phi$ 是方位角。对于每一个环境贴图上的像素，需要计算其投影到单位球面的面积，框架给了 CalcArea 这个函数计算这个面积。\n先把 texel 从 $[0,res-1]$ 映射到以 CubeMap 当前面中心为原点的 $\\left[ \\frac{1}{res}-1,1-\\frac{1}{res} \\right]$ 坐标范围内。然后通过四个角点的差值计算面积，每个点所对应的面积可以使用一个公式求解：\n$$ A(x,y)=\\arctan\\left( \\frac{xy}{\\sqrt{ x^2+y^2+1 }} \\right) $$ 所以在 PrecomputeCubemapSH 中，只需要为每个 SH 基函数上累加每个 texel 的贡献，就可以得到 Lighting 项的球谐系数。\n无阴影传输项系数 UnShadowed 传输项球谐系数的计算在 preprocess 函数中，assignmet sheet 里给的计算传输项伪代码比较长，但框架里主要关注到 shFunc 这个 lambda 表达式，该表达式返回需要投影的函数在给定方向上的函数值，后续会传入 sh::ProjectFunction 进行计算。\n对于无阴影的情况，要投影的函数就是简单的 cos 项：\n$$ M_{DU}=\\max(N_{x}\\cdot \\omega_{i},0) $$ 这里 H 后来我放 if 外面了，免得下面再写一遍\n有阴影传输项系数 Shadowed $$ M_{DU}=V(\\omega_{i})\\max(N_{x}\\cdot \\omega_{i},0) $$ 要投影的函数再乘上一个 Visibility 项即可：\n如果想看这步的结果，就把 prt.xml 里改成 shadowed，然后运行下 nori.exe。\n1","wordCount":"2396","inLanguage":"zh","datePublished":"2025-04-19T00:00:00Z","dateModified":"2025-04-19T00:00:00Z","author":{"@type":"Person","name":"The Only Problem"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://congyuxiaoyoudao.github.io/posts/assignments/games202-homework-2/"},"publisher":{"@type":"Organization","name":"The Only Problem's Blog","logo":{"@type":"ImageObject","url":"https://congyuxiaoyoudao.github.io/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://congyuxiaoyoudao.github.io/ accesskey=h title="The Only Problem's Blog (Alt + H)">The Only Problem's Blog</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)" aria-label="Toggle theme">
<svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
<svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://congyuxiaoyoudao.github.io/archives/ title=Archive><span>Archive</span></a></li><li><a href=https://congyuxiaoyoudao.github.io/search/ title="Search (Alt + /)" accesskey=/><span>Search</span></a></li><li><a href=https://congyuxiaoyoudao.github.io/tags/ title=Tags><span>Tags</span></a></li><li><a href=https://congyuxiaoyoudao.github.io/about/ title=About><span>About</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://congyuxiaoyoudao.github.io/>主页</a>&nbsp;»&nbsp;<a href=https://congyuxiaoyoudao.github.io/posts/>Posts</a>&nbsp;»&nbsp;<a href=https://congyuxiaoyoudao.github.io/posts/assignments/>Assignments</a></div><h1 class="post-title entry-hint-parent">Assignment 5. GAMES202 Homework 2</h1><div class=post-meta><span title='2025-04-19 00:00:00 +0000 UTC'>四月 19, 2025</span>&nbsp;·&nbsp;12 分钟&nbsp;·&nbsp;The Only Problem</div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>目录</span></summary><div class=inner><ul><li><a href=#0x00-to-begin-with aria-label="0x00 To begin with">0x00 To begin with</a></li><li><a href=#0x01-%e5%89%8d%e7%bd%ae%e5%87%86%e5%a4%87-warm-up aria-label="0x01 前置准备 Warm Up">0x01 前置准备 Warm Up</a><ul><li><a href=#%e6%b8%b2%e6%9f%93%e6%96%b9%e7%a8%8b-render-equation aria-label="渲染方程 Render Equation">渲染方程 Render Equation</a></li><li><a href=#split-sum aria-label="Split Sum">Split Sum</a></li><li><a href=#%e7%90%83%e8%b0%90%e5%87%bd%e6%95%b0-spherical-harmonics aria-label="球谐函数 Spherical Harmonics">球谐函数 Spherical Harmonics</a></li><li><a href=#prtprecomputerd-radience-transfer aria-label="PRT（Precomputerd Radience Transfer）">PRT（Precomputerd Radience Transfer）</a></li></ul></li><li><a href=#0x02-%e9%a2%84%e8%ae%a1%e7%ae%97%e7%90%83%e8%b0%90%e7%b3%bb%e6%95%b0-precompute-sh-coef aria-label="0x02 预计算球谐系数 Precompute SH Coef">0x02 预计算球谐系数 Precompute SH Coef</a><ul><li><a href=#%e5%85%89%e7%85%a7%e9%a1%b9%e7%b3%bb%e6%95%b0-lighting aria-label="光照项系数 Lighting">光照项系数 Lighting</a></li><li><a href=#%e6%97%a0%e9%98%b4%e5%bd%b1%e4%bc%a0%e8%be%93%e9%a1%b9%e7%b3%bb%e6%95%b0-unshadowed aria-label="无阴影传输项系数 UnShadowed">无阴影传输项系数 UnShadowed</a></li><li><a href=#%e6%9c%89%e9%98%b4%e5%bd%b1%e4%bc%a0%e8%be%93%e9%a1%b9%e7%b3%bb%e6%95%b0-shadowed aria-label="有阴影传输项系数 Shadowed">有阴影传输项系数 Shadowed</a></li><li><a href=#%e5%8f%8d%e5%b0%84%e4%bc%a0%e8%be%93%e9%a1%b9%e7%b3%bb%e6%95%b0-inter-reflection aria-label="反射传输项系数 Inter-reflection">反射传输项系数 Inter-reflection</a></li></ul></li><li><a href=#0x03-%e5%ae%9e%e6%97%b6%e7%90%83%e8%b0%90%e5%85%89%e7%85%a7-realtime-sh-lighting aria-label="0x03 实时球谐光照 Realtime SH Lighting">0x03 实时球谐光照 Realtime SH Lighting</a><ul><li><a href=#%e6%96%b0%e5%bb%ba-prt-%e6%9d%90%e8%b4%a8-new-prt-material aria-label="新建 PRT 材质 New PRT Material">新建 PRT 材质 New PRT Material</a></li><li><a href=#%e7%bc%96%e5%86%99%e7%9d%80%e8%89%b2%e5%99%a8-write-shader aria-label="编写着色器 Write Shader">编写着色器 Write Shader</a></li><li><a href=#%e7%bb%93%e6%9e%9c-outcome aria-label="结果 Outcome">结果 Outcome</a></li></ul></li><li><a href=#0x04-%e7%90%83%e8%b0%90%e6%97%8b%e8%bd%ac-sh-rotation aria-label="0x04 球谐旋转 SH Rotation">0x04 球谐旋转 SH Rotation</a></li></ul></div></details></div><div class=post-content><blockquote><p>(∩^o^)⊃━☆ﾟ.*･｡</p></blockquote><hr><h2 id=0x00-to-begin-with>0x00 To begin with<a hidden class=anchor aria-hidden=true href=#0x00-to-begin-with>#</a></h2><p>这篇文章将会包含以下内容：</p><ul><li><input checked disabled type=checkbox> 部分课程内容回顾</li><li><input checked disabled type=checkbox> GAMES202 作业 2</li></ul><p><strong>For reference</strong>👇：</p><ul><li>📺B 站视频：
<a href="https://www.bilibili.com/video/BV1YK4y1T7yY/?spm_id_from=333.337.top_right_bar_window_custom_collection.content.click&amp;vd_source=b6584cebba3a7a1a34d2f60d63bdc868">GAMES202-高质量实时渲染</a></li><li>📦代码仓库：
<a href=https://github.com/congyuxiaoyoudao/GAMES202_Homework/tree/working>congyuxiaoyoudao/GAMES202_Homework at working</a></li><li>📃
<a href=https://dl.acm.org/doi/10.1145/15886.15902>The rendering equation | ACM SIGGRAPH Computer Graphics</a></li><li>📃
<a href=https://dl.acm.org/doi/10.1145/566654.566612>Precomputed radiance transfer for real-time rendering in dynamic, low-frequency lighting environments | ACM Transactions on Graphics</a></li></ul><blockquote><p>master 分支上是 202 全部作业汇总，working 分支用于提交代码。需要原始作业可下载 master 分支的包</p></blockquote><hr><h2 id=0x01-前置准备-warm-up>0x01 前置准备 Warm Up<a hidden class=anchor aria-hidden=true href=#0x01-前置准备-warm-up>#</a></h2><h3 id=渲染方程-render-equation>渲染方程 Render Equation<a hidden class=anchor aria-hidden=true href=#渲染方程-render-equation>#</a></h3><p>James T. Kajiya（没错就是那个提出 Kajiya-Kay 头发着色模型的 Kajiya）在 1986 年提出了渲染方程（The Render Equation），原论文里长这样：</p><div>$$
I(x,x')=g(x,x')\left[ \epsilon(x,x')+\int_{S}\rho(x,x',x'')I(x',x'')dx'' \right]
$$</div><p>当然现在看得更舒服的形式长这样：</p><div>$$
L_{o}(p,\omega_{o})=L_{e}(p,\omega_{o})+\int_{\Omega^+}L_{i}(p,\omega_{i})f_{r}(p,\omega_{i},\omega_{o})\cos\theta_{i}\space d\omega_{i}
$$</div><p>其中：</p><ul><li>$L_{o}(p,\omega_{o})$：要求出射方向的辐射率（Radience）</li><li>$L_{e}(p,\omega_{o})$：自发光项</li><li>$\Omega^+$：积分域，仅对表面正半球积分</li><li>$L_{i}(p,\omega_{i})$：Lighting，某一入射方向的辐射率</li><li>$f_{r}(p,\omega_{i},\omega_{o})$：BRDF，描述某一入射方向的光线在出射方向的贡献</li><li>$\cos \theta_{i}$：表面法向与某一入射方向形成的夹角余弦</li></ul><p>所以渲染方程其实就描述了在当前 Shading Point 上，给定入射光与出射方向（观察方向），在出射方向上能够接收到的 Radiance，任何在表面上进行的光线传播的 Shading 都需要解这个方程。</p><h3 id=split-sum>Split Sum<a hidden class=anchor aria-hidden=true href=#split-sum>#</a></h3><p>对于环境光，通常使用 CubeMap 或者等距柱形投影将图像投射到无限远的球面上，要获得环境光的 Shading（目前暂不考虑 Shadowing），就需要求解渲染方程，核心是对于 Lighting 部分的求解。</p><p>先抛开渲染方程，想象一下当表面是理想镜面的情况：对于某个 Shading Point，其反射行为是镜面反射，那么我们可以很容易地求出射方向对应的入射方向，根据这个方向查询环境光的颜色。</p><p><img loading=lazy src=https://raw.gitmirror.com/congyuxiaoyoudao/Picgo-ImageBed/main/Assignments/Assignment%205.GAMES202HW2/202504192355458.png#center></p><p>更 General 一点，当表面比较粗糙的情况，能够反射到出射方向的入射角在镜反射方向上会在某个角度 $\phi$ 范围内抖动分布，最终反射到出射方向的 Lighting 受到这个范围内所有采样点颜色的影响。这个过程可以类比于对原始的环境贴图进行滤波，且粗糙度越大，滤波核越大，这样就可以仍使用镜反射方向查询滤波后的图像。这些滤波后的图像当然可以预计算，形成一个模糊层级，然后渲染时根据不同粗糙度使用不同图像。</p><p><img loading=lazy src=https://raw.gitmirror.com/congyuxiaoyoudao/Picgo-ImageBed/main/Assignments/Assignment%205.GAMES202HW2/202504200006951.png#center></p><p>但是目前 Lighting 项在积分内部，也就是说我们要对整个半球面上的入射方向都进行一次查询，还是比较 Costy 的，有没有办法把 Lighting 从积分里独立出来？下面有一种近似方法：</p><div>$$
\int_{\Omega}f(x)g(x)dx\approx \frac{\int_{\Omega_{G}}f(x)dx}{\int_{\Omega_{G}}dx} \cdot \int_{\Omega}g(x)dx
$$</div><p>这个近似在 $g(x)$ 贡献比较小或者比较平滑（低频）时是相对准确的。漫反射 BRDF 就很好地满足这个性质，所以可以对渲染方程应用这个近似：</p><div>$$
L_{o}(p,\omega_{o})\approx\frac{\int_{\Omega_{f_{r}}}L_{i}(p,\omega_{i})d\omega_{i}}{\int_{\Omega_{f_{r}}}d\omega_{i}}\cdot \int_{\Omega^+}f_{r}(p,\omega_{i},\omega_{o})\cos \theta_{i} \space d\omega_{i}
$$</div><p>乘号左边的部分代表 Lighting 在 BRDF 范围内的平均 Radience，可以认为是对出射方向有贡献的入射方向范围内在环境贴图上采样颜色的平均值。通过对环境贴图的预滤波，可以通过一次查询得到这个值。</p><h3 id=球谐函数-spherical-harmonics>球谐函数 Spherical Harmonics<a hidden class=anchor aria-hidden=true href=#球谐函数-spherical-harmonics>#</a></h3><p><a href=https://zh.wikipedia.org/wiki/%E7%90%83%E8%B0%90%E5%87%BD%E6%95%B0>球谐函数</a></p><p>维基百科上球谐函数是下面这个式子在 $m,l$ 不同取值时的解：</p><div>$$
Y^m_{l}(\theta, \phi)=(-1)^m\sqrt{ \frac{2l+1}{4\pi}\frac{(l-|m|)!}{(l+|m|)!} }P^m_{l}(\cos \theta)e^{im\phi}
$$</div><p>实数形式下可视化出来是长这样的：</p><p><img loading=lazy src=https://raw.gitmirror.com/congyuxiaoyoudao/Picgo-ImageBed/main/Assignments/Assignment%205.GAMES202HW2/202504201716498.png#center></p><p>看上去是不是很像物理/量子化学里面的电子云啥的（这俩还真有关系），但在图形学里面，我们不需要理解其物理意义，可以简单将其理解为一组定义在球面上的两两正交的基函数，有了它我们可以使用傅里叶变换的思想去拟合任何的球面函数。</p><blockquote><p>基函数（Basis Function）：一组两两之间相互独立的函数，即在彼此之上的投影为 0，可以类比线性代数的基向量。一组基函数张成的空间是其经过线性组合能够表示的所有函数的集合</p></blockquote><div>$$
\mathcal{F} = \left\{ f(x) = \sum_{i=1}^n c_{i}B_{i}(x) \,\middle|\, c_{i} \in \mathbb{R} \right\}
$$</div><p>可以通过将原函数投影到某个基函数上获取该基函数前的系数 $c_{i}$：</p><div>$$
c_{i}=\int_{\Omega}f(x)B_{i}(x)\,dx
$$</div><p>实际使用时需要把积分离散化为一系列求和的形式，给定一个函数 $f(\omega_{i})$，可以通过投影求得其在 $Y^m_{l}(\omega_{i})$ 上的系数：</p><div>$$
c^m_{l}\approx\sum_{i=1}^Nf(\omega_{i})\cdot Y^m_{l}(\omega_{i})\cdot \omega_{i}
$$</div><p>然后就可以用类似泰勒展开的样子用基函数表示原函数：</p><div>$$
\begin{aligned}
f(x)=&\sum^{\infty}_{l=0}\sum^l_{m=-l}c^m_{l}\cdot Y^m_{l}(\omega_{i}) \\
=& \, c^0_{0}Y^0_{0}(\omega_{i})+c^1_{-1}Y^1_{-1}(\omega_{i})+c^1_{0}Y^1_{0}(\omega_{i})+\,\dots
\end{aligned}
$$</div><p>对于低频的函数，只取前几项进行近似，就能达到 Adequate 的效果。如果 BRDF 是粗糙的，就相当于一个低通滤波器，其和 Lighting 的乘积的积分仍然是低频的。</p><h3 id=prtprecomputerd-radience-transfer>PRT（Precomputerd Radience Transfer）<a hidden class=anchor aria-hidden=true href=#prtprecomputerd-radience-transfer>#</a></h3><p>球谐函数用一组基函数拟合渲染方程中的 Lighting 项，解决了 Shading 的问题，如果需要 Shadowing，就需要加入可见性项 $V(p,\omega_{i})$，渲染方程变为：</p><div>$$
L_{o}(p,\omega_{o})=\int_{\Omega}
\underbrace {L_{i}(p,\omega_{i})}_{Lighting} \,
\underbrace {f_{r}(p,\omega_{i},\omega_{o})}_{BRDF} \,
\underbrace {V(p,\omega_{i})}_{Visibility} \,
\max(0,\cos \theta_{i})\,d\omega_{i}
$$</div><p>暴力算法就是朝各个方向分别对 Lighting，BRDF 和 Visibility 计算，然后再逐项相乘，开销太大。Sloan 在 2002 年提出了PRT（Precomputed Radience Transfer），将积分内部分为 Lighting 和 Light Transport（光线传输）两个部分：</p><div>$$
L_{o}(p,\omega_{o})=\int_{\Omega}
\underbrace {L_{i}(p,\omega_{i})}_{Lighting} \,
\underbrace {f_{r}(p,\omega_{i},\omega_{o}) \,
V(p,\omega_{i}) \,
\max(0,\cos \theta_{i})}_{Light \,Transport} \,
d\omega_{i}
$$</div><p>假设 BRDF 项是 Diffuse 的，BRDF 项是一个定值 $\frac{\rho}{\pi}$，将 Lighting 表示为系数和基函数的形式，然后交换积分与求和的位置，就可以将积分内部再次表示为在基函数上的投影：</p><div>$$
\begin{aligned}
L(p,\omega_{o})=& \frac{\rho}{\pi} \int_{\Omega}\sum l_{i}B_{i}(\omega_{i})V(p,\omega_{i})\max(0,\cos \theta_{i}) \, d\omega_{i} \\
\approx& \frac{\rho}{\pi} \sum l_{i}
\underbrace{ \int_{\Omega}B_{i}(\omega_{i})V(p,\omega_{i})\max(0,\cos \theta_{i}) }_{Precomputed}
\, d\omega_{i} \\
\approx& \frac{\rho}{\pi} \sum l_{i}T_{i}
\end{aligned}
$$</div><blockquote><p>注意这里是对 $\omega_{i}$ 进行积分，对每一个基函数上的投影进行求和</p></blockquote><p>其中 $l_{i}$ 是 Lighting 项在基函数上投影的一组系数，$T_{i}$ 是 Light Transport 项在基函数上投影的系数。这样就把多个函数乘积的积分转变为一个简单的点乘。</p><p>然而这些预计算需要一些前提：</p><ul><li>Visibility 是固定的，即要求场景中的物体不能动</li><li>Lighting 是“固定”的，Lighting 的成分不能动态变化，但 Lighting 可以旋转（相当于对基函数张成的线性空间进行旋转）</li></ul><p>很合理，就像烘焙的光照信息是静态的一样。</p><hr><h2 id=0x02-预计算球谐系数-precompute-sh-coef>0x02 预计算球谐系数 Precompute SH Coef<a hidden class=anchor aria-hidden=true href=#0x02-预计算球谐系数-precompute-sh-coef>#</a></h2><h3 id=光照项系数-lighting>光照项系数 Lighting<a hidden class=anchor aria-hidden=true href=#光照项系数-lighting>#</a></h3><p>要算 SH 系数，就要把环境光照投影到球谐函数上，球谐函数可以调用 <code>sh::EvalSH</code> 获取，Lighting 项可以通过预存的 <code>images</code> 数组获取，剩下一个立体角 $d\omega_{i}$：</p><div>$$
d\omega_{i}=\sin \theta \, d\theta \, d\phi
$$</div><p>其中 $\theta$ 是极角，$\phi$ 是方位角。对于每一个环境贴图上的像素，需要计算其投影到单位球面的面积，框架给了 <code>CalcArea</code> 这个函数计算这个面积。</p><p><img loading=lazy src=https://raw.gitmirror.com/congyuxiaoyoudao/Picgo-ImageBed/main/Assignments/Assignment%205.GAMES202HW2/202504202247143.png#center></p><p>先把 texel 从 $[0,res-1]$ 映射到以 CubeMap 当前面中心为原点的 $\left[ \frac{1}{res}-1,1-\frac{1}{res} \right]$ 坐标范围内。然后通过四个角点的差值计算面积，每个点所对应的面积可以使用一个公式求解：</p><div>$$
A(x,y)=\arctan\left( \frac{xy}{\sqrt{ x^2+y^2+1 }} \right)
$$</div><p>所以在 <code>PrecomputeCubemapSH</code> 中，只需要为每个 SH 基函数上累加每个 texel 的贡献，就可以得到 Lighting 项的球谐系数。</p><p><img loading=lazy src=https://raw.gitmirror.com/congyuxiaoyoudao/Picgo-ImageBed/main/Assignments/Assignment%205.GAMES202HW2/202504202312530.png#center></p><h3 id=无阴影传输项系数-unshadowed>无阴影传输项系数 UnShadowed<a hidden class=anchor aria-hidden=true href=#无阴影传输项系数-unshadowed>#</a></h3><p>传输项球谐系数的计算在 <code>preprocess</code> 函数中，assignmet sheet 里给的计算传输项伪代码比较长，但框架里主要关注到 <code>shFunc</code> 这个 lambda 表达式，该表达式返回需要投影的函数在给定方向上的函数值，后续会传入 <code>sh::ProjectFunction</code> 进行计算。</p><p>对于无阴影的情况，要投影的函数就是简单的 cos 项：</p><div>$$
M_{DU}=\max(N_{x}\cdot \omega_{i},0)
$$</div><p><img loading=lazy src=https://raw.gitmirror.com/congyuxiaoyoudao/Picgo-ImageBed/main/Assignments/Assignment%205.GAMES202HW2/202504202329397.png#center></p><blockquote><p>这里 H 后来我放 if 外面了，免得下面再写一遍</p></blockquote><h3 id=有阴影传输项系数-shadowed>有阴影传输项系数 Shadowed<a hidden class=anchor aria-hidden=true href=#有阴影传输项系数-shadowed>#</a></h3><div>$$
M_{DU}=V(\omega_{i})\max(N_{x}\cdot \omega_{i},0)
$$</div><p>要投影的函数再乘上一个 Visibility 项即可：</p><p><img loading=lazy src=https://raw.gitmirror.com/congyuxiaoyoudao/Picgo-ImageBed/main/Assignments/Assignment%205.GAMES202HW2/202504232209586.png#center></p><p>如果想看这步的结果，就把 prt.xml 里改成 shadowed，然后运行下 nori.exe。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-xml data-lang=xml><span class=line><span class=ln>1</span><span class=cl><span class=nt>&lt;string</span> <span class=na>name=</span><span class=s>&#34;type&#34;</span> <span class=na>value=</span><span class=s>&#34;shadowed&#34;</span> <span class=nt>/&gt;</span>
</span></span></code></pre></div><blockquote><p>记得改完代码 build 一下，不然 .exe 还是上一次的结果</p></blockquote><h3 id=反射传输项系数-inter-reflection>反射传输项系数 Inter-reflection<a hidden class=anchor aria-hidden=true href=#反射传输项系数-inter-reflection>#</a></h3><p>对于具有相互反射的传输项，其方程变为：</p><div>$$
L_{DI}=L_{DS}+\frac{\rho}{\pi}\int_{S}\hat{L}(x',\omega_{i})(1-V(\omega_{i}))\max(N_{x}\cdot \omega_{i},0)\,d\omega_{i}
$$</div><p>我们已经计算了每个顶点的直接可见光源的 Lightning（$L_{DS}$），还需要计算间接光的 Lighting，其中：</p><ul><li>$\hat{L}(x&rsquo;,\omega_{i})$：从 $\omega_{i}$ 到点 $x&rsquo;$ 的 Radiance</li><li>$1-V(\omega_{i})$：被遮挡的部分</li></ul><p>所以这个式子对每个顶点计算来自直接可见光源的 Lighting，然后遍历所有可能的 $\omega_{i}$ 计算间接光的 Lighting，对于每个交点返回重心坐标插值后的球谐系数，然后以当前交点为原点，迭代计算传输项系数。</p><p>因为觉得 lambda 有点好玩，就拿 lambda 写了一个递归，其实也可以另外封装一个函数，图片太长不好截，直接放代码：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=ln> 1</span><span class=cl> <span class=k>if</span> <span class=p>(</span><span class=n>m_Type</span> <span class=o>==</span> <span class=n>Type</span><span class=o>::</span><span class=n>Interreflection</span><span class=p>)</span>
</span></span><span class=line><span class=ln> 2</span><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=ln> 3</span><span class=cl>            <span class=c1>// for each vertex cast a ray to the scene
</span></span></span><span class=line><span class=ln> 4</span><span class=cl><span class=c1></span>            <span class=c1>// if occluded return interpolated sh coef
</span></span></span><span class=line><span class=ln> 5</span><span class=cl><span class=c1></span>            <span class=c1>// then recursively call this function
</span></span></span><span class=line><span class=ln> 6</span><span class=cl><span class=c1></span>            <span class=k>for</span><span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span><span class=n>i</span> <span class=o>&lt;</span> <span class=n>mesh</span><span class=o>-&gt;</span><span class=n>getVertexCount</span><span class=p>();</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span>
</span></span><span class=line><span class=ln> 7</span><span class=cl>            <span class=p>{</span>
</span></span><span class=line><span class=ln> 8</span><span class=cl>                <span class=k>const</span> <span class=n>Point3f</span> <span class=o>&amp;</span><span class=n>v</span> <span class=o>=</span> <span class=n>mesh</span><span class=o>-&gt;</span><span class=n>getVertexPositions</span><span class=p>().</span><span class=n>col</span><span class=p>(</span><span class=n>i</span><span class=p>);</span>
</span></span><span class=line><span class=ln> 9</span><span class=cl>                <span class=k>const</span> <span class=n>Normal3f</span> <span class=o>&amp;</span><span class=n>n</span> <span class=o>=</span> <span class=n>mesh</span><span class=o>-&gt;</span><span class=n>getVertexNormals</span><span class=p>().</span><span class=n>col</span><span class=p>(</span><span class=n>i</span><span class=p>);</span>
</span></span><span class=line><span class=ln>10</span><span class=cl>
</span></span><span class=line><span class=ln>11</span><span class=cl>                <span class=c1>// iterate lambda
</span></span></span><span class=line><span class=ln>12</span><span class=cl><span class=c1></span>                <span class=c1>// need to pass pos, normal, scene, original coeff and current bounce
</span></span></span><span class=line><span class=ln>13</span><span class=cl><span class=c1></span>                <span class=n>std</span><span class=o>::</span><span class=n>function</span><span class=o>&lt;</span><span class=n>std</span><span class=o>::</span><span class=n>unique_ptr</span><span class=o>&lt;</span><span class=n>std</span><span class=o>::</span><span class=n>vector</span><span class=o>&lt;</span><span class=kt>double</span><span class=o>&gt;&gt;</span><span class=p>(</span><span class=n>Eigen</span><span class=o>::</span><span class=n>MatrixXf</span><span class=o>*</span><span class=p>,</span> <span class=k>const</span> <span class=n>Point3f</span><span class=o>&amp;</span><span class=p>,</span> <span class=k>const</span> <span class=n>Normal3f</span><span class=o>&amp;</span><span class=p>,</span> <span class=k>const</span> <span class=n>Scene</span><span class=o>*</span><span class=p>,</span> <span class=kt>int</span><span class=p>)</span><span class=o>&gt;</span> <span class=n>iterateSHFunc</span><span class=p>;</span>
</span></span><span class=line><span class=ln>14</span><span class=cl>                <span class=n>iterateSHFunc</span> <span class=o>=</span> <span class=p>[</span><span class=o>&amp;</span><span class=p>](</span><span class=n>Eigen</span><span class=o>::</span><span class=n>MatrixXf</span><span class=o>*</span> <span class=n>TransportSHCoeffs</span><span class=p>,</span> <span class=k>const</span> <span class=n>Point3f</span> <span class=o>&amp;</span><span class=n>pos</span><span class=p>,</span> <span class=k>const</span> <span class=n>Normal3f</span> <span class=o>&amp;</span><span class=n>normal</span><span class=p>,</span> <span class=k>const</span> <span class=n>Scene</span><span class=o>*</span> <span class=n>s</span><span class=p>,</span> <span class=kt>int</span> <span class=n>bounce</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>std</span><span class=o>::</span><span class=n>unique_ptr</span><span class=o>&lt;</span><span class=n>std</span><span class=o>::</span><span class=n>vector</span><span class=o>&lt;</span><span class=kt>double</span><span class=o>&gt;&gt;</span>
</span></span><span class=line><span class=ln>15</span><span class=cl>                <span class=p>{</span>
</span></span><span class=line><span class=ln>16</span><span class=cl>                    <span class=c1>// Step 1: allocate and assign 0 to coeffs
</span></span></span><span class=line><span class=ln>17</span><span class=cl><span class=c1></span>                    <span class=n>std</span><span class=o>::</span><span class=n>unique_ptr</span><span class=o>&lt;</span><span class=n>std</span><span class=o>::</span><span class=n>vector</span><span class=o>&lt;</span><span class=kt>double</span><span class=o>&gt;&gt;</span> <span class=n>coeffs</span><span class=p>(</span><span class=k>new</span> <span class=n>std</span><span class=o>::</span><span class=n>vector</span><span class=o>&lt;</span><span class=kt>double</span><span class=o>&gt;</span><span class=p>());</span>
</span></span><span class=line><span class=ln>18</span><span class=cl>                    <span class=n>coeffs</span><span class=o>-&gt;</span><span class=n>assign</span><span class=p>(</span><span class=n>SHCoeffLength</span><span class=p>,</span> <span class=mf>0.0</span><span class=p>);</span>
</span></span><span class=line><span class=ln>19</span><span class=cl>                
</span></span><span class=line><span class=ln>20</span><span class=cl>                    <span class=c1>// Step 2: judge by bounce to terminate
</span></span></span><span class=line><span class=ln>21</span><span class=cl><span class=c1></span>                    <span class=k>if</span> <span class=p>(</span><span class=n>bounce</span> <span class=o>&gt;</span> <span class=n>m_Bounce</span><span class=p>)</span>
</span></span><span class=line><span class=ln>22</span><span class=cl>                        <span class=k>return</span> <span class=n>coeffs</span><span class=p>;</span>
</span></span><span class=line><span class=ln>23</span><span class=cl>                
</span></span><span class=line><span class=ln>24</span><span class=cl>                    <span class=c1>// Step 3: generate sample_side^2 uniformly and stratified samples over the sphere
</span></span></span><span class=line><span class=ln>25</span><span class=cl><span class=c1></span>                    <span class=k>const</span> <span class=kt>int</span> <span class=n>sample_side</span> <span class=o>=</span> <span class=k>static_cast</span><span class=o>&lt;</span><span class=kt>int</span><span class=o>&gt;</span><span class=p>(</span><span class=n>floor</span><span class=p>(</span><span class=n>sqrt</span><span class=p>(</span><span class=n>m_SampleCount</span><span class=p>)));</span>
</span></span><span class=line><span class=ln>26</span><span class=cl>                    <span class=n>std</span><span class=o>::</span><span class=n>random_device</span> <span class=n>rd</span><span class=p>;</span>
</span></span><span class=line><span class=ln>27</span><span class=cl>                    <span class=n>std</span><span class=o>::</span><span class=n>mt19937</span> <span class=n>gen</span><span class=p>(</span><span class=n>rd</span><span class=p>());</span>
</span></span><span class=line><span class=ln>28</span><span class=cl>                    <span class=n>std</span><span class=o>::</span><span class=n>uniform_real_distribution</span><span class=o>&lt;&gt;</span> <span class=n>rng</span><span class=p>(</span><span class=mf>0.0</span><span class=p>,</span> <span class=mf>1.0</span><span class=p>);</span>
</span></span><span class=line><span class=ln>29</span><span class=cl>                    <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>t</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>t</span> <span class=o>&lt;</span> <span class=n>sample_side</span><span class=p>;</span> <span class=n>t</span><span class=o>++</span><span class=p>)</span>
</span></span><span class=line><span class=ln>30</span><span class=cl>                    <span class=p>{</span>
</span></span><span class=line><span class=ln>31</span><span class=cl>                        <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>p</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>p</span> <span class=o>&lt;</span> <span class=n>sample_side</span><span class=p>;</span> <span class=n>p</span><span class=o>++</span><span class=p>)</span>
</span></span><span class=line><span class=ln>32</span><span class=cl>                        <span class=p>{</span>
</span></span><span class=line><span class=ln>33</span><span class=cl>                            <span class=kt>double</span> <span class=n>alpha</span> <span class=o>=</span> <span class=p>(</span><span class=n>t</span> <span class=o>+</span> <span class=n>rng</span><span class=p>(</span><span class=n>gen</span><span class=p>))</span> <span class=o>/</span> <span class=n>sample_side</span><span class=p>;</span>
</span></span><span class=line><span class=ln>34</span><span class=cl>                            <span class=kt>double</span> <span class=n>beta</span> <span class=o>=</span> <span class=p>(</span><span class=n>p</span> <span class=o>+</span> <span class=n>rng</span><span class=p>(</span><span class=n>gen</span><span class=p>))</span> <span class=o>/</span> <span class=n>sample_side</span><span class=p>;</span>
</span></span><span class=line><span class=ln>35</span><span class=cl>                            <span class=kt>double</span> <span class=n>phi</span> <span class=o>=</span> <span class=mf>2.0</span> <span class=o>*</span> <span class=n>M_PI</span> <span class=o>*</span> <span class=n>beta</span><span class=p>;</span>
</span></span><span class=line><span class=ln>36</span><span class=cl>                            <span class=kt>double</span> <span class=n>theta</span> <span class=o>=</span> <span class=n>acos</span><span class=p>(</span><span class=mf>2.0</span> <span class=o>*</span> <span class=n>alpha</span> <span class=o>-</span> <span class=mf>1.0</span><span class=p>);</span>
</span></span><span class=line><span class=ln>37</span><span class=cl>                
</span></span><span class=line><span class=ln>38</span><span class=cl>                            <span class=c1>// Step 4: for each wi cast a ray to the scene
</span></span></span><span class=line><span class=ln>39</span><span class=cl><span class=c1></span>                            <span class=n>Eigen</span><span class=o>::</span><span class=n>Array3d</span> <span class=n>d</span> <span class=o>=</span> <span class=n>sh</span><span class=o>::</span><span class=n>ToVector</span><span class=p>(</span><span class=n>phi</span><span class=p>,</span> <span class=n>theta</span><span class=p>);</span>
</span></span><span class=line><span class=ln>40</span><span class=cl>                            <span class=k>const</span> <span class=k>auto</span> <span class=n>wi</span> <span class=o>=</span> <span class=n>Vector3f</span><span class=p>(</span><span class=n>d</span><span class=p>.</span><span class=n>x</span><span class=p>(),</span> <span class=n>d</span><span class=p>.</span><span class=n>y</span><span class=p>(),</span> <span class=n>d</span><span class=p>.</span><span class=n>z</span><span class=p>());</span>
</span></span><span class=line><span class=ln>41</span><span class=cl>                            <span class=kt>float</span> <span class=n>H</span> <span class=o>=</span> <span class=n>wi</span><span class=p>.</span><span class=n>dot</span><span class=p>(</span><span class=n>normal</span><span class=p>);</span> 
</span></span><span class=line><span class=ln>42</span><span class=cl>                
</span></span><span class=line><span class=ln>43</span><span class=cl>                            <span class=n>Ray3f</span> <span class=n>ray</span> <span class=o>=</span> <span class=n>Ray3f</span><span class=p>(</span><span class=n>pos</span><span class=p>,</span> <span class=n>wi</span><span class=p>);</span>
</span></span><span class=line><span class=ln>44</span><span class=cl>                            <span class=n>Intersection</span> <span class=n>its</span><span class=p>;</span>
</span></span><span class=line><span class=ln>45</span><span class=cl>                            <span class=k>if</span><span class=p>(</span><span class=n>H</span> <span class=o>&gt;</span> <span class=mf>0.0</span> <span class=o>&amp;&amp;</span> <span class=n>s</span><span class=o>-&gt;</span><span class=n>rayIntersect</span><span class=p>(</span><span class=n>ray</span><span class=p>,</span> <span class=n>its</span><span class=p>))</span>
</span></span><span class=line><span class=ln>46</span><span class=cl>                            <span class=p>{</span>
</span></span><span class=line><span class=ln>47</span><span class=cl>                                <span class=c1>// Step 5: if occluded, get the intersected point and its normal
</span></span></span><span class=line><span class=ln>48</span><span class=cl><span class=c1></span>                                <span class=n>Point3f</span> <span class=n>intersectPos</span> <span class=o>=</span> <span class=n>its</span><span class=p>.</span><span class=n>p</span><span class=p>;</span>
</span></span><span class=line><span class=ln>49</span><span class=cl>                                <span class=n>Vector3f</span> <span class=n>baryCoord</span> <span class=o>=</span> <span class=n>its</span><span class=p>.</span><span class=n>bary</span><span class=p>;</span>
</span></span><span class=line><span class=ln>50</span><span class=cl>                                <span class=n>Point3f</span> <span class=n>idx</span> <span class=o>=</span> <span class=n>its</span><span class=p>.</span><span class=n>tri_index</span><span class=p>;</span>
</span></span><span class=line><span class=ln>51</span><span class=cl>                                <span class=n>MatrixXf</span> <span class=n>normals</span> <span class=o>=</span> <span class=n>mesh</span><span class=o>-&gt;</span><span class=n>getVertexNormals</span><span class=p>();</span>
</span></span><span class=line><span class=ln>52</span><span class=cl>                                <span class=n>Normal3f</span> <span class=n>intersectNormal</span> <span class=o>=</span> <span class=n>Normal3f</span><span class=p>(</span><span class=n>normals</span><span class=p>.</span><span class=n>col</span><span class=p>(</span><span class=n>idx</span><span class=p>.</span><span class=n>x</span><span class=p>()).</span><span class=n>normalized</span><span class=p>()</span> <span class=o>*</span> <span class=n>baryCoord</span><span class=p>.</span><span class=n>x</span><span class=p>()</span> <span class=o>+</span>
</span></span><span class=line><span class=ln>53</span><span class=cl>                                                                        <span class=n>normals</span><span class=p>.</span><span class=n>col</span><span class=p>(</span><span class=n>idx</span><span class=p>.</span><span class=n>y</span><span class=p>()).</span><span class=n>normalized</span><span class=p>()</span> <span class=o>*</span> <span class=n>baryCoord</span><span class=p>.</span><span class=n>y</span><span class=p>()</span> <span class=o>+</span>
</span></span><span class=line><span class=ln>54</span><span class=cl>                                                                        <span class=n>normals</span><span class=p>.</span><span class=n>col</span><span class=p>(</span><span class=n>idx</span><span class=p>.</span><span class=n>z</span><span class=p>()).</span><span class=n>normalized</span><span class=p>()</span> <span class=o>*</span> <span class=n>baryCoord</span><span class=p>.</span><span class=n>z</span><span class=p>()).</span><span class=n>normalized</span><span class=p>();</span>
</span></span><span class=line><span class=ln>55</span><span class=cl>                                <span class=k>auto</span> <span class=n>nextBounceCoeffs</span> <span class=o>=</span> <span class=n>iterateSHFunc</span><span class=p>(</span><span class=n>TransportSHCoeffs</span><span class=p>,</span> <span class=n>intersectPos</span><span class=p>,</span> <span class=n>intersectNormal</span><span class=p>,</span> <span class=n>scene</span><span class=p>,</span> <span class=n>bounce</span> <span class=o>+</span> <span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=ln>56</span><span class=cl>                
</span></span><span class=line><span class=ln>57</span><span class=cl>                                <span class=c1>// Step 6: accumulate the coeffs
</span></span></span><span class=line><span class=ln>58</span><span class=cl><span class=c1></span>                                <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>k</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>k</span> <span class=o>&lt;</span> <span class=n>SHCoeffLength</span><span class=p>;</span> <span class=n>k</span><span class=o>++</span><span class=p>)</span>
</span></span><span class=line><span class=ln>59</span><span class=cl>                                <span class=p>{</span>
</span></span><span class=line><span class=ln>60</span><span class=cl>                                    <span class=k>auto</span> <span class=n>interpolateSH</span> <span class=o>=</span> <span class=p>(</span><span class=n>TransportSHCoeffs</span><span class=o>-&gt;</span><span class=n>col</span><span class=p>(</span><span class=n>idx</span><span class=p>.</span><span class=n>x</span><span class=p>()).</span><span class=n>coeffRef</span><span class=p>(</span><span class=n>k</span><span class=p>)</span> <span class=o>*</span> <span class=n>baryCoord</span><span class=p>.</span><span class=n>x</span><span class=p>()</span> <span class=o>+</span>
</span></span><span class=line><span class=ln>61</span><span class=cl>                                                                <span class=n>TransportSHCoeffs</span><span class=o>-&gt;</span><span class=n>col</span><span class=p>(</span><span class=n>idx</span><span class=p>.</span><span class=n>y</span><span class=p>()).</span><span class=n>coeffRef</span><span class=p>(</span><span class=n>k</span><span class=p>)</span> <span class=o>*</span> <span class=n>baryCoord</span><span class=p>.</span><span class=n>y</span><span class=p>()</span> <span class=o>+</span>
</span></span><span class=line><span class=ln>62</span><span class=cl>                                                                <span class=n>TransportSHCoeffs</span><span class=o>-&gt;</span><span class=n>col</span><span class=p>(</span><span class=n>idx</span><span class=p>.</span><span class=n>z</span><span class=p>()).</span><span class=n>coeffRef</span><span class=p>(</span><span class=n>k</span><span class=p>)</span> <span class=o>*</span> <span class=n>baryCoord</span><span class=p>.</span><span class=n>z</span><span class=p>());</span>
</span></span><span class=line><span class=ln>63</span><span class=cl>                
</span></span><span class=line><span class=ln>64</span><span class=cl>                                    <span class=p>(</span><span class=o>*</span><span class=n>coeffs</span><span class=p>)[</span><span class=n>k</span><span class=p>]</span> <span class=o>+=</span> <span class=p>(</span><span class=n>interpolateSH</span> <span class=o>+</span> <span class=p>(</span><span class=o>*</span><span class=n>nextBounceCoeffs</span><span class=p>)[</span><span class=n>k</span><span class=p>])</span> <span class=o>*</span> <span class=n>H</span><span class=p>;</span>
</span></span><span class=line><span class=ln>65</span><span class=cl>                                <span class=p>}</span>
</span></span><span class=line><span class=ln>66</span><span class=cl>                            <span class=p>}</span>
</span></span><span class=line><span class=ln>67</span><span class=cl>                        <span class=p>}</span>
</span></span><span class=line><span class=ln>68</span><span class=cl>                    <span class=p>}</span>
</span></span><span class=line><span class=ln>69</span><span class=cl>                    <span class=c1>// Step 7: return the coeffs
</span></span></span><span class=line><span class=ln>70</span><span class=cl><span class=c1></span>                    <span class=kt>double</span> <span class=n>weight</span> <span class=o>=</span> <span class=p>(</span><span class=n>sample_side</span> <span class=o>*</span> <span class=n>sample_side</span><span class=p>);</span>
</span></span><span class=line><span class=ln>71</span><span class=cl>                    <span class=k>for</span> <span class=p>(</span><span class=kt>unsigned</span> <span class=kt>int</span> <span class=n>c</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>c</span> <span class=o>&lt;</span> <span class=n>coeffs</span><span class=o>-&gt;</span><span class=n>size</span><span class=p>();</span> <span class=n>c</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>72</span><span class=cl>                        <span class=p>(</span><span class=o>*</span><span class=n>coeffs</span><span class=p>)[</span><span class=n>c</span><span class=p>]</span> <span class=o>/=</span> <span class=n>weight</span><span class=p>;</span>
</span></span><span class=line><span class=ln>73</span><span class=cl>                    <span class=p>}</span>
</span></span><span class=line><span class=ln>74</span><span class=cl>                
</span></span><span class=line><span class=ln>75</span><span class=cl>                    <span class=k>return</span> <span class=n>coeffs</span><span class=p>;</span>
</span></span><span class=line><span class=ln>76</span><span class=cl>                <span class=p>};</span>
</span></span><span class=line><span class=ln>77</span><span class=cl>                
</span></span><span class=line><span class=ln>78</span><span class=cl>                <span class=c1>// Step 8: call the iterateSHFunc
</span></span></span><span class=line><span class=ln>79</span><span class=cl><span class=c1></span>                <span class=k>auto</span> <span class=n>interreflectCoeffs</span> <span class=o>=</span> <span class=n>iterateSHFunc</span><span class=p>(</span><span class=o>&amp;</span><span class=n>m_TransportSHCoeffs</span><span class=p>,</span> <span class=n>v</span><span class=p>,</span> <span class=n>n</span><span class=p>,</span> <span class=n>scene</span><span class=p>,</span> <span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=ln>80</span><span class=cl>                <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>j</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>j</span> <span class=o>&lt;</span> <span class=n>SHCoeffLength</span><span class=p>;</span> <span class=n>j</span><span class=o>++</span><span class=p>)</span>
</span></span><span class=line><span class=ln>81</span><span class=cl>                <span class=p>{</span>
</span></span><span class=line><span class=ln>82</span><span class=cl>                    <span class=n>m_TransportSHCoeffs</span><span class=p>.</span><span class=n>col</span><span class=p>(</span><span class=n>i</span><span class=p>).</span><span class=n>coeffRef</span><span class=p>(</span><span class=n>j</span><span class=p>)</span> <span class=o>+=</span> <span class=p>(</span><span class=o>*</span><span class=n>interreflectCoeffs</span><span class=p>)[</span><span class=n>j</span><span class=p>];</span>
</span></span><span class=line><span class=ln>83</span><span class=cl>                <span class=p>}</span>
</span></span><span class=line><span class=ln>84</span><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=ln>85</span><span class=cl>        <span class=p>}</span>
</span></span></code></pre></div><blockquote><p>这里使用 <code>std::function</code> 包装了一下这个 lambda，不然其内部不能调用自己；生成采样点的过程可以照着 <code>sh::ProjectFunction</code> 里面抄</p></blockquote><p>在调用时可以修改 <code>m_Bounce</code> 的值控制光线反弹次数（lambda 迭代次数），我这里仍然是默认值 1，之前改了一次 2 给我跑了一个多小时，(๑╹◡╹๑)。</p><hr><h2 id=0x03-实时球谐光照-realtime-sh-lighting>0x03 实时球谐光照 Realtime SH Lighting<a hidden class=anchor aria-hidden=true href=#0x03-实时球谐光照-realtime-sh-lighting>#</a></h2><p>运行 nori.exe 后，计算得到的球谐系数将保存在 prt/scenes/cubemap/ 对应环境贴图文件夹下，需要手工先把 light.txt 和 transport.txt 放到 homework2/assets/cubemap/ 对应的环境贴图文件夹下。</p><p>engine.js 中的第 88-114 行已经帮我们完成了解析这些文件的工作，最终 Lighting 和 Transport 项的球谐系数被保存在 precomputeL 和 precomputeLT 两个数组中，这两个数组包含在 <code>envmap</code> 中所有环境纹理的球谐系数，其形状为：</p><div>$$
\begin{aligned}
precomputeL =& EnvMapNum*3*(SHOrder+1)^{2} \\
precomputeLT =& EnvMapNum*VertexCount*(SHOrder+1)^{2}
\end{aligned}
$$</div><p>可以通过 <code>guiParams.envmapId</code> 获取当前 GUI 中激活的环境纹理索引，以从以上数组中获取对应的球谐系数。</p><h3 id=新建-prt-材质-new-prt-material>新建 PRT 材质 New PRT Material<a hidden class=anchor aria-hidden=true href=#新建-prt-材质-new-prt-material>#</a></h3><p>在 src/material/ 下新建PRTMaterial.js，编写一个最简单的材质，传的统一变量仅为预计算光照项的各分量（RGB），attribute（<code>aPrecomputeLT</code>）按照 assignment sheet 里的要求传入：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=ln> 1</span><span class=cl><span class=kr>class</span> <span class=nx>PRTMaterial</span> <span class=kr>extends</span> <span class=nx>Material</span> <span class=p>{</span>
</span></span><span class=line><span class=ln> 2</span><span class=cl>
</span></span><span class=line><span class=ln> 3</span><span class=cl>    <span class=nx>constructor</span><span class=p>(</span><span class=nx>vertexShader</span><span class=p>,</span> <span class=nx>fragmentShader</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=ln> 4</span><span class=cl>        <span class=kr>super</span><span class=p>({</span>
</span></span><span class=line><span class=ln> 5</span><span class=cl>            <span class=c1>// PRT
</span></span></span><span class=line><span class=ln> 6</span><span class=cl><span class=c1></span>            <span class=s1>&#39;uPrecomputeL[0]&#39;</span><span class=o>:</span> <span class=p>{</span> <span class=nx>type</span><span class=o>:</span> <span class=s1>&#39;precomputeL&#39;</span><span class=p>,</span> <span class=nx>value</span><span class=o>:</span> <span class=kc>null</span> <span class=p>},</span>
</span></span><span class=line><span class=ln> 7</span><span class=cl>            <span class=s1>&#39;uPrecomputeL[1]&#39;</span><span class=o>:</span> <span class=p>{</span> <span class=nx>type</span><span class=o>:</span> <span class=s1>&#39;precomputeL&#39;</span><span class=p>,</span> <span class=nx>value</span><span class=o>:</span> <span class=kc>null</span> <span class=p>},</span>
</span></span><span class=line><span class=ln> 8</span><span class=cl>            <span class=s1>&#39;uPrecomputeL[2]&#39;</span><span class=o>:</span> <span class=p>{</span> <span class=nx>type</span><span class=o>:</span> <span class=s1>&#39;precomputeL&#39;</span><span class=p>,</span> <span class=nx>value</span><span class=o>:</span> <span class=kc>null</span> <span class=p>},</span>
</span></span><span class=line><span class=ln> 9</span><span class=cl>        <span class=p>},</span> <span class=p>[</span><span class=s1>&#39;aPrecomputeLT&#39;</span><span class=p>],</span> <span class=nx>vertexShader</span><span class=p>,</span> <span class=nx>fragmentShader</span><span class=p>,</span> <span class=kc>null</span><span class=p>);</span>
</span></span><span class=line><span class=ln>10</span><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=ln>11</span><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=ln>12</span><span class=cl>
</span></span><span class=line><span class=ln>13</span><span class=cl><span class=kr>async</span> <span class=kd>function</span> <span class=nx>buildPRTMaterial</span><span class=p>(</span><span class=nx>vertexPath</span><span class=p>,</span> <span class=nx>fragmentPath</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>14</span><span class=cl>
</span></span><span class=line><span class=ln>15</span><span class=cl>
</span></span><span class=line><span class=ln>16</span><span class=cl>    <span class=kd>let</span> <span class=nx>vertexShader</span> <span class=o>=</span> <span class=kr>await</span> <span class=nx>getShaderString</span><span class=p>(</span><span class=nx>vertexPath</span><span class=p>);</span>
</span></span><span class=line><span class=ln>17</span><span class=cl>    <span class=kd>let</span> <span class=nx>fragmentShader</span> <span class=o>=</span> <span class=kr>await</span> <span class=nx>getShaderString</span><span class=p>(</span><span class=nx>fragmentPath</span><span class=p>);</span>
</span></span><span class=line><span class=ln>18</span><span class=cl>
</span></span><span class=line><span class=ln>19</span><span class=cl>    <span class=k>return</span> <span class=k>new</span> <span class=nx>PRTMaterial</span><span class=p>(</span><span class=nx>vertexShader</span><span class=p>,</span> <span class=nx>fragmentShader</span><span class=p>);</span>
</span></span><span class=line><span class=ln>20</span><span class=cl>
</span></span><span class=line><span class=ln>21</span><span class=cl><span class=p>}</span>
</span></span></code></pre></div><blockquote><p>在 Shader 中，<code>uPrecomputeL</code> 是一个类型为 mat3 的数组，索引对应 RGB 分量的球谐系数，需要逐一绑定</p></blockquote><p>utils/tools.js 中提供了用于将 precomputeL 分解为三个 mat3 类型的数组的函数 <code>getMat3ValueFromRGB</code>，每帧的 render 中需要对其进行绑定，WebGLRenderer.js 中：</p><p><img loading=lazy src=https://raw.gitmirror.com/congyuxiaoyoudao/Picgo-ImageBed/main/Assignments/Assignment%205.GAMES202HW2/202504232252839.png#center></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=ln>1</span><span class=cl><span class=kd>let</span> <span class=nx>precomputeL_RGBMat3</span> <span class=o>=</span> <span class=nx>getMat3ValueFromRGB</span><span class=p>(</span><span class=nx>precomputeL</span><span class=p>[</span><span class=nx>guiParams</span><span class=p>.</span><span class=nx>envmapId</span><span class=p>]);</span>
</span></span><span class=line><span class=ln>2</span><span class=cl><span class=k>for</span><span class=p>(</span><span class=kd>let</span> <span class=nx>j</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=nx>j</span> <span class=o>&lt;</span> <span class=mi>3</span> <span class=p>;</span> <span class=nx>j</span><span class=o>++</span><span class=p>){</span>
</span></span><span class=line><span class=ln>3</span><span class=cl>	<span class=k>if</span><span class=p>(</span><span class=nx>k</span> <span class=o>==</span> <span class=sb>`uPrecomputeL[</span><span class=si>${</span><span class=nx>j</span><span class=si>}</span><span class=sb>]`</span><span class=p>){</span>
</span></span><span class=line><span class=ln>4</span><span class=cl>		<span class=nx>gl</span><span class=p>.</span><span class=nx>uniformMatrix3fv</span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=nx>meshes</span><span class=p>[</span><span class=nx>i</span><span class=p>].</span><span class=nx>shader</span><span class=p>.</span><span class=nx>program</span><span class=p>.</span><span class=nx>uniforms</span><span class=p>[</span><span class=nx>k</span><span class=p>],</span><span class=kc>false</span><span class=p>,</span><span class=nx>precomputeL_RGBMat3</span><span class=p>[</span><span class=nx>j</span><span class=p>]);</span>
</span></span><span class=line><span class=ln>5</span><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=ln>6</span><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>之后可以先在 index.html 中引入：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-html data-lang=html><span class=line><span class=ln>1</span><span class=cl><span class=p>&lt;</span><span class=nt>script</span> <span class=na>src</span><span class=o>=</span><span class=s>&#34;src/materials/PRTMaterial.js&#34;</span> <span class=na>defer</span><span class=p>&gt;&lt;/</span><span class=nt>script</span><span class=p>&gt;</span>
</span></span></code></pre></div><p>然后在 loadOBJ.js 中增加 PRT 材质的 case：</p><p><img loading=lazy src=https://raw.gitmirror.com/congyuxiaoyoudao/Picgo-ImageBed/main/Assignments/Assignment%205.GAMES202HW2/202504232228474.png#center></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=ln>1</span><span class=cl><span class=k>case</span> <span class=s1>&#39;PRTMaterial&#39;</span><span class=o>:</span>
</span></span><span class=line><span class=ln>2</span><span class=cl>	<span class=nx>material</span> <span class=o>=</span> <span class=nx>buildPRTMaterial</span><span class=p>(</span><span class=s2>&#34;./src/shaders/PRTShader/PRTVertex.glsl&#34;</span><span class=p>,</span> <span class=s2>&#34;./src/shaders/PRTShader/PRTFragment.glsl&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=ln>3</span><span class=cl>	<span class=k>break</span><span class=p>;</span>
</span></span></code></pre></div><h3 id=编写着色器-write-shader>编写着色器 Write Shader<a hidden class=anchor aria-hidden=true href=#编写着色器-write-shader>#</a></h3><p>在 shaders/PRTShader/ 下新建 PRT 的顶点和片元着色器文件，作业中需要我们在顶点着色器中完成对 Lighting 和 Transport 的球谐系数的点乘，结果 <code>vColor</code> 经插值后传至片元着色器，直接输出。</p><p>所以片元着色器很简单：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-glsl data-lang=glsl><span class=line><span class=ln> 1</span><span class=cl><span class=c1>// prtFragment.glsl</span>
</span></span><span class=line><span class=ln> 2</span><span class=cl><span class=cp>#ifdef GL_ES</span>
</span></span><span class=line><span class=ln> 3</span><span class=cl><span class=k>precision</span> <span class=k>mediump</span> <span class=k>float</span><span class=p>;</span>
</span></span><span class=line><span class=ln> 4</span><span class=cl><span class=cp>#endif</span>
</span></span><span class=line><span class=ln> 5</span><span class=cl>
</span></span><span class=line><span class=ln> 6</span><span class=cl><span class=k>varying</span> <span class=k>highp</span> <span class=k>vec3</span> <span class=n>vColor</span><span class=p>;</span>
</span></span><span class=line><span class=ln> 7</span><span class=cl>
</span></span><span class=line><span class=ln> 8</span><span class=cl><span class=k>void</span> <span class=n>main</span><span class=p>(</span><span class=k>void</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=ln> 9</span><span class=cl>   <span class=n>gl_FragColor</span> <span class=o>=</span> <span class=k>vec4</span><span class=p>(</span><span class=n>vColor</span><span class=p>,</span> <span class=mf>1.0</span><span class=p>);</span>
</span></span><span class=line><span class=ln>10</span><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>顶点着色器中需要完成对 <code>vColor</code> 的计算，看一下传过来的 <code>uPrecomputeL[3]</code> 和 <code>aPrecomputeLT</code> 长什么样子：</p><p><img loading=lazy src=https://raw.gitmirror.com/congyuxiaoyoudao/Picgo-ImageBed/main/Assignments/Assignment%205.GAMES202HW2/202504232317208.png#center>
emm，都是 mat3 没办法简单点乘，那就写一个函数，把它们都分成三个 vec3，然后点乘求和即可。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-glsl data-lang=glsl><span class=line><span class=ln> 1</span><span class=cl><span class=c1>// prtVertex.glsl</span>
</span></span><span class=line><span class=ln> 2</span><span class=cl><span class=k>attribute</span> <span class=k>vec3</span> <span class=n>aVertexPosition</span><span class=p>;</span>
</span></span><span class=line><span class=ln> 3</span><span class=cl><span class=k>attribute</span> <span class=k>vec3</span> <span class=n>aNormalPosition</span><span class=p>;</span>
</span></span><span class=line><span class=ln> 4</span><span class=cl><span class=k>attribute</span> <span class=n>mat3</span> <span class=n>aPrecomputeLT</span><span class=p>;</span>
</span></span><span class=line><span class=ln> 5</span><span class=cl>
</span></span><span class=line><span class=ln> 6</span><span class=cl><span class=k>uniform</span> <span class=n>mat4</span> <span class=n>uModelMatrix</span><span class=p>;</span>
</span></span><span class=line><span class=ln> 7</span><span class=cl><span class=k>uniform</span> <span class=n>mat4</span> <span class=n>uViewMatrix</span><span class=p>;</span>
</span></span><span class=line><span class=ln> 8</span><span class=cl><span class=k>uniform</span> <span class=n>mat4</span> <span class=n>uProjectionMatrix</span><span class=p>;</span>
</span></span><span class=line><span class=ln> 9</span><span class=cl><span class=k>uniform</span> <span class=n>mat3</span> <span class=n>uPrecomputeL</span><span class=p>[</span><span class=mi>3</span><span class=p>];</span>
</span></span><span class=line><span class=ln>10</span><span class=cl>
</span></span><span class=line><span class=ln>11</span><span class=cl><span class=k>varying</span> <span class=k>highp</span> <span class=k>vec3</span> <span class=n>vNormal</span><span class=p>;</span>
</span></span><span class=line><span class=ln>12</span><span class=cl><span class=k>varying</span> <span class=k>highp</span> <span class=k>vec3</span> <span class=n>vColor</span><span class=p>;</span>
</span></span><span class=line><span class=ln>13</span><span class=cl>
</span></span><span class=line><span class=ln>14</span><span class=cl><span class=k>float</span> <span class=n>LoT</span> <span class=p>(</span><span class=n>mat3</span> <span class=n>L</span><span class=p>,</span> <span class=n>mat3</span> <span class=n>LT</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>15</span><span class=cl>  <span class=k>vec3</span> <span class=n>L0</span> <span class=o>=</span> <span class=n>L</span><span class=p>[</span><span class=mo>0</span><span class=p>];</span>
</span></span><span class=line><span class=ln>16</span><span class=cl>  <span class=k>vec3</span> <span class=n>L1</span> <span class=o>=</span> <span class=n>L</span><span class=p>[</span><span class=mi>1</span><span class=p>];</span>
</span></span><span class=line><span class=ln>17</span><span class=cl>  <span class=k>vec3</span> <span class=n>L2</span> <span class=o>=</span> <span class=n>L</span><span class=p>[</span><span class=mi>2</span><span class=p>];</span>
</span></span><span class=line><span class=ln>18</span><span class=cl>  <span class=k>vec3</span> <span class=n>LT0</span> <span class=o>=</span> <span class=n>LT</span><span class=p>[</span><span class=mo>0</span><span class=p>];</span>
</span></span><span class=line><span class=ln>19</span><span class=cl>  <span class=k>vec3</span> <span class=n>LT1</span> <span class=o>=</span> <span class=n>LT</span><span class=p>[</span><span class=mi>1</span><span class=p>];</span>
</span></span><span class=line><span class=ln>20</span><span class=cl>  <span class=k>vec3</span> <span class=n>LT2</span> <span class=o>=</span> <span class=n>LT</span><span class=p>[</span><span class=mi>2</span><span class=p>];</span>
</span></span><span class=line><span class=ln>21</span><span class=cl>  <span class=k>return</span> <span class=n>dot</span><span class=p>(</span><span class=n>L0</span><span class=p>,</span> <span class=n>LT0</span><span class=p>)</span> <span class=o>+</span> <span class=n>dot</span><span class=p>(</span><span class=n>L1</span><span class=p>,</span> <span class=n>LT1</span><span class=p>)</span> <span class=o>+</span> <span class=n>dot</span><span class=p>(</span><span class=n>L2</span><span class=p>,</span> <span class=n>LT2</span><span class=p>);</span>
</span></span><span class=line><span class=ln>22</span><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=ln>23</span><span class=cl>
</span></span><span class=line><span class=ln>24</span><span class=cl><span class=k>void</span> <span class=n>main</span><span class=p>(</span><span class=k>void</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>25</span><span class=cl>
</span></span><span class=line><span class=ln>26</span><span class=cl>  <span class=n>vNormal</span> <span class=o>=</span> <span class=p>(</span><span class=n>uModelMatrix</span> <span class=o>*</span> <span class=k>vec4</span><span class=p>(</span><span class=n>aNormalPosition</span><span class=p>,</span> <span class=mf>0.0</span><span class=p>)).</span><span class=n>xyz</span><span class=p>;</span>
</span></span><span class=line><span class=ln>27</span><span class=cl>
</span></span><span class=line><span class=ln>28</span><span class=cl>  <span class=n>gl_Position</span> <span class=o>=</span> <span class=n>uProjectionMatrix</span> <span class=o>*</span> <span class=n>uViewMatrix</span> <span class=o>*</span> <span class=n>uModelMatrix</span> <span class=o>*</span>
</span></span><span class=line><span class=ln>29</span><span class=cl>                <span class=k>vec4</span><span class=p>(</span><span class=n>aVertexPosition</span><span class=p>,</span> <span class=mf>1.0</span><span class=p>);</span>
</span></span><span class=line><span class=ln>30</span><span class=cl>
</span></span><span class=line><span class=ln>31</span><span class=cl>  <span class=c1>// rgb color from precomputed light transport</span>
</span></span><span class=line><span class=ln>32</span><span class=cl>  <span class=k>float</span> <span class=n>r</span> <span class=o>=</span> <span class=n>LoT</span><span class=p>(</span><span class=n>uPrecomputeL</span><span class=p>[</span><span class=mo>0</span><span class=p>],</span><span class=n>aPrecomputeLT</span><span class=p>);</span>
</span></span><span class=line><span class=ln>33</span><span class=cl>  <span class=k>float</span> <span class=n>g</span> <span class=o>=</span> <span class=n>LoT</span><span class=p>(</span><span class=n>uPrecomputeL</span><span class=p>[</span><span class=mi>1</span><span class=p>],</span><span class=n>aPrecomputeLT</span><span class=p>);</span>
</span></span><span class=line><span class=ln>34</span><span class=cl>  <span class=k>float</span> <span class=n>b</span> <span class=o>=</span> <span class=n>LoT</span><span class=p>(</span><span class=n>uPrecomputeL</span><span class=p>[</span><span class=mi>2</span><span class=p>],</span><span class=n>aPrecomputeLT</span><span class=p>);</span>
</span></span><span class=line><span class=ln>35</span><span class=cl>    <span class=n>vColor</span> <span class=o>=</span> <span class=k>vec3</span><span class=p>(</span><span class=n>r</span><span class=p>,</span> <span class=n>g</span><span class=p>,</span> <span class=n>b</span><span class=p>);</span>
</span></span><span class=line><span class=ln>36</span><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h3 id=结果-outcome>结果 Outcome<a hidden class=anchor aria-hidden=true href=#结果-outcome>#</a></h3><p>最后在 engine.js 中调用 <code>loadOBJ</code> 加载 202 娘，顺便把还有一张没在 GUI 上的环境纹理放上去：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=ln> 1</span><span class=cl><span class=kd>var</span> <span class=nx>envmap</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=ln> 2</span><span class=cl>	<span class=s1>&#39;assets/cubemap/GraceCathedral&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=ln> 3</span><span class=cl>	<span class=s1>&#39;assets/cubemap/Indoor&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=ln> 4</span><span class=cl>	<span class=s1>&#39;assets/cubemap/Skybox&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=ln> 5</span><span class=cl>	<span class=c1>// Begin TOP changes Add envmap CornellBox
</span></span></span><span class=line><span class=ln> 6</span><span class=cl><span class=c1></span>	<span class=s1>&#39;assets/cubemap/CornellBox&#39;</span>
</span></span><span class=line><span class=ln> 7</span><span class=cl>	<span class=c1>// End TOP changes
</span></span></span><span class=line><span class=ln> 8</span><span class=cl><span class=c1></span><span class=p>];</span>
</span></span><span class=line><span class=ln> 9</span><span class=cl><span class=c1>// ...
</span></span></span><span class=line><span class=ln>10</span><span class=cl><span class=c1></span>
</span></span><span class=line><span class=ln>11</span><span class=cl>	<span class=nx>loadOBJ</span><span class=p>(</span><span class=nx>renderer</span><span class=p>,</span> <span class=s1>&#39;assets/mary/&#39;</span><span class=p>,</span> <span class=s1>&#39;mary&#39;</span><span class=p>,</span> <span class=s1>&#39;PRTMaterial&#39;</span><span class=p>,</span> <span class=nx>boxTransform</span><span class=p>);</span>
</span></span><span class=line><span class=ln>12</span><span class=cl><span class=c1>// ...
</span></span></span><span class=line><span class=ln>13</span><span class=cl><span class=c1></span>
</span></span><span class=line><span class=ln>14</span><span class=cl><span class=kd>function</span> <span class=nx>createGUI</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>15</span><span class=cl>	<span class=kr>const</span> <span class=nx>gui</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>dat</span><span class=p>.</span><span class=nx>gui</span><span class=p>.</span><span class=nx>GUI</span><span class=p>();</span>
</span></span><span class=line><span class=ln>16</span><span class=cl>	<span class=kr>const</span> <span class=nx>panelModel</span> <span class=o>=</span> <span class=nx>gui</span><span class=p>.</span><span class=nx>addFolder</span><span class=p>(</span><span class=s1>&#39;Switch Environemtn Map&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=ln>17</span><span class=cl>	<span class=c1>// Begin TOP changes Add envmap CornellBox case in UI
</span></span></span><span class=line><span class=ln>18</span><span class=cl><span class=c1></span>	<span class=nx>panelModel</span><span class=p>.</span><span class=nx>add</span><span class=p>(</span><span class=nx>guiParams</span><span class=p>,</span> <span class=s1>&#39;envmapId&#39;</span><span class=p>,</span> <span class=p>{</span> <span class=s1>&#39;GraceGathedral&#39;</span><span class=o>:</span> <span class=mi>0</span><span class=p>,</span> <span class=s1>&#39;Indoor&#39;</span><span class=o>:</span> <span class=mi>1</span><span class=p>,</span> <span class=s1>&#39;Skybox&#39;</span><span class=o>:</span> <span class=mi>2</span><span class=p>,</span> <span class=s1>&#39;CornellBox&#39;</span><span class=o>:</span><span class=mi>3</span><span class=p>}).</span><span class=nx>name</span><span class=p>(</span><span class=s1>&#39;Envmap Name&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=ln>19</span><span class=cl>	<span class=c1>// End TOP changes
</span></span></span><span class=line><span class=ln>20</span><span class=cl><span class=c1></span>	<span class=nx>panelModel</span><span class=p>.</span><span class=nx>open</span><span class=p>();</span>
</span></span><span class=line><span class=ln>21</span><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p><img alt="Inter-reflection m_Bounce = 1" loading=lazy src=https://raw.gitmirror.com/congyuxiaoyoudao/Picgo-ImageBed/main/Assignments/Assignment%205.GAMES202HW2/202504261655957.png#center></p><hr><h2 id=0x04-球谐旋转-sh-rotation>0x04 球谐旋转 SH Rotation<a hidden class=anchor aria-hidden=true href=#0x04-球谐旋转-sh-rotation>#</a></h2><p>球谐函数具有两个很好的性质：</p><ul><li>旋转不变性：旋转球谐展开后的函数，相当于旋转这些球谐函数</li><li>独立的线性旋转：对于每层球谐函数上的系数，可以分别进行旋转，并且该旋转是线性的</li></ul><p>把球谐函数和基向量类比就比较清楚了：旋转一个三维空间中的向量，相当于旋转坐标基，在这组新的坐标基下，其系数和旋转前其在原坐标系的系数相等。那么要求旋转后在原坐标系下的系数，只需要将新的坐标基使用原来的坐标基表示，然后重新整理系数即可。</p><p>对球谐每阶 $l$，有 $2l+1$ 维的球谐系数组成的向量，假设存在 $2l + 1$ 个任意的三维法向 $n$，旋转函数 $R$，能够返回该阶球谐投影系数的函数 $P$，需要求得旋转整个球面函数的矩阵 $M$，有：</p><div>$$
MP(n_{i})=P(R(n_{i}))\,,\,i \in[-l,l]
$$</div><blockquote><p>LHS：对整个球面函数进行旋转；RHS：先旋转方向 $n_i$，再代入球面函数</p></blockquote><p>记矩阵 $A=[P(n_{-l}),\dots,P(n_{l})]$，若其可逆，则等式两边同时右乘一个 $A^{-1}$，等式变为：</p><div>$$
M=[P(R(n_{-l})),\dots,P(R(n_{l}))]A^{-1}
$$</div><blockquote><p>Lighting 项有 RGB 三个分量，所以这里的 $P(R(n_{i}))$ 实际上是一个三维向量</p></blockquote><p>总结一下思路：</p><ol><li>对于环境纹理的旋转，可以获取其旋转矩阵 $R$；</li><li>在每阶 $l$ 选取 $2l+1$ 个单位方向向量，获取其在该阶上的球谐系数构成矩阵 $A$；</li><li>对该矩阵求逆得到 $A^{-1}$；</li><li>使用旋转矩阵依次旋转每阶的单位方向向量，获取这些旋转后的向量在该阶上的球谐系数 $S$；</li><li>解得 $M=SA^{-1}$</li></ol><p>主要的实现在 utils/tools.js 中，直接上代码：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=ln>  1</span><span class=cl><span class=kd>function</span> <span class=nx>getRotationPrecomputeL</span><span class=p>(</span><span class=nx>precompute_L</span><span class=p>,</span> <span class=nx>rotationMatrix</span><span class=p>){</span>
</span></span><span class=line><span class=ln>  2</span><span class=cl>
</span></span><span class=line><span class=ln>  3</span><span class=cl>	<span class=c1>// Step 1: Calc each band&#39;s rotation matrix 
</span></span></span><span class=line><span class=ln>  4</span><span class=cl><span class=c1></span>	<span class=c1>// Caution: for each dir the Rotation matrix is a inverse of the rotation matrix 
</span></span></span><span class=line><span class=ln>  5</span><span class=cl><span class=c1></span>    <span class=kd>let</span> <span class=nx>r</span> <span class=o>=</span> <span class=nx>mat4Matrix2mathMatrix</span><span class=p>(</span><span class=nx>rotationMatrix</span><span class=p>);</span>
</span></span><span class=line><span class=ln>  6</span><span class=cl>
</span></span><span class=line><span class=ln>  7</span><span class=cl>    <span class=kd>let</span> <span class=nx>shRotateMatrix3x3</span> <span class=o>=</span> <span class=nx>computeSquareMatrix_3by3</span><span class=p>(</span><span class=nx>r</span><span class=p>);</span>
</span></span><span class=line><span class=ln>  8</span><span class=cl>    <span class=kd>let</span> <span class=nx>shRotateMatrix5x5</span> <span class=o>=</span> <span class=nx>computeSquareMatrix_5by5</span><span class=p>(</span><span class=nx>r</span><span class=p>);</span>
</span></span><span class=line><span class=ln>  9</span><span class=cl>
</span></span><span class=line><span class=ln> 10</span><span class=cl>	<span class=c1>// Step 2: Initialize rotated L    //      R   G   B
</span></span></span><span class=line><span class=ln> 11</span><span class=cl><span class=c1></span>    <span class=kd>let</span> <span class=nx>result</span> <span class=o>=</span> <span class=p>[];</span>                   <span class=c1>// SH0
</span></span></span><span class=line><span class=ln> 12</span><span class=cl><span class=c1></span>    <span class=k>for</span><span class=p>(</span><span class=kd>let</span> <span class=nx>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=nx>i</span> <span class=o>&lt;</span> <span class=mi>9</span><span class=p>;</span> <span class=nx>i</span><span class=o>++</span><span class=p>){</span>        <span class=c1>// SH1
</span></span></span><span class=line><span class=ln> 13</span><span class=cl><span class=c1></span>        <span class=nx>result</span><span class=p>[</span><span class=nx>i</span><span class=p>]</span> <span class=o>=</span> <span class=p>[];</span>                <span class=c1>// SH2
</span></span></span><span class=line><span class=ln> 14</span><span class=cl><span class=c1></span>    <span class=p>}</span>                                  <span class=c1>// ...
</span></span></span><span class=line><span class=ln> 15</span><span class=cl><span class=c1></span>
</span></span><span class=line><span class=ln> 16</span><span class=cl>	<span class=c1>// Step 3: Calc SH coeffs for RGB component of precompute_L
</span></span></span><span class=line><span class=ln> 17</span><span class=cl><span class=c1></span>    <span class=k>for</span><span class=p>(</span><span class=kd>let</span> <span class=nx>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=nx>i</span> <span class=o>&lt;</span> <span class=mi>3</span><span class=p>;</span> <span class=nx>i</span><span class=o>++</span><span class=p>){</span>
</span></span><span class=line><span class=ln> 18</span><span class=cl>        <span class=kd>let</span> <span class=nx>L_SH_R_3</span> <span class=o>=</span> <span class=nx>math</span><span class=p>.</span><span class=nx>multiply</span><span class=p>([</span><span class=nx>precompute_L</span><span class=p>[</span><span class=mi>1</span><span class=p>][</span><span class=nx>i</span><span class=p>],</span> <span class=nx>precompute_L</span><span class=p>[</span><span class=mi>2</span><span class=p>][</span><span class=nx>i</span><span class=p>],</span> <span class=nx>precompute_L</span><span class=p>[</span><span class=mi>3</span><span class=p>][</span><span class=nx>i</span><span class=p>]],</span> <span class=nx>shRotateMatrix3x3</span><span class=p>);</span>
</span></span><span class=line><span class=ln> 19</span><span class=cl>        <span class=kd>let</span> <span class=nx>L_SH_R_5</span> <span class=o>=</span> <span class=nx>math</span><span class=p>.</span><span class=nx>multiply</span><span class=p>([</span><span class=nx>precompute_L</span><span class=p>[</span><span class=mi>4</span><span class=p>][</span><span class=nx>i</span><span class=p>],</span> <span class=nx>precompute_L</span><span class=p>[</span><span class=mi>5</span><span class=p>][</span><span class=nx>i</span><span class=p>],</span> <span class=nx>precompute_L</span><span class=p>[</span><span class=mi>6</span><span class=p>][</span><span class=nx>i</span><span class=p>],</span> <span class=nx>precompute_L</span><span class=p>[</span><span class=mi>7</span><span class=p>][</span><span class=nx>i</span><span class=p>],</span> <span class=nx>precompute_L</span><span class=p>[</span><span class=mi>8</span><span class=p>][</span><span class=nx>i</span><span class=p>]],</span> <span class=nx>shRotateMatrix5x5</span><span class=p>);</span>
</span></span><span class=line><span class=ln> 20</span><span class=cl>		
</span></span><span class=line><span class=ln> 21</span><span class=cl>		<span class=kd>let</span> <span class=nx>L_SH_R_3_arr</span> <span class=o>=</span> <span class=nx>L_SH_R_3</span><span class=p>.</span><span class=nx>toArray</span><span class=p>();</span>
</span></span><span class=line><span class=ln> 22</span><span class=cl>		<span class=kd>let</span> <span class=nx>L_SH_R_5_arr</span> <span class=o>=</span> <span class=nx>L_SH_R_5</span><span class=p>.</span><span class=nx>toArray</span><span class=p>();</span>
</span></span><span class=line><span class=ln> 23</span><span class=cl>
</span></span><span class=line><span class=ln> 24</span><span class=cl>        <span class=nx>result</span><span class=p>[</span><span class=mi>0</span><span class=p>][</span><span class=nx>i</span><span class=p>]</span> <span class=o>=</span> <span class=nx>precompute_L</span><span class=p>[</span><span class=mi>0</span><span class=p>][</span><span class=nx>i</span><span class=p>];</span> <span class=c1>// Y1^{0} remains the same
</span></span></span><span class=line><span class=ln> 25</span><span class=cl><span class=c1></span>		<span class=nx>result</span><span class=p>[</span><span class=mi>1</span><span class=p>][</span><span class=nx>i</span><span class=p>]</span> <span class=o>=</span> <span class=nx>L_SH_R_3_arr</span><span class=p>[</span><span class=mi>0</span><span class=p>];</span>
</span></span><span class=line><span class=ln> 26</span><span class=cl>        <span class=nx>result</span><span class=p>[</span><span class=mi>2</span><span class=p>][</span><span class=nx>i</span><span class=p>]</span> <span class=o>=</span> <span class=nx>L_SH_R_3_arr</span><span class=p>[</span><span class=mi>1</span><span class=p>];</span>
</span></span><span class=line><span class=ln> 27</span><span class=cl>        <span class=nx>result</span><span class=p>[</span><span class=mi>3</span><span class=p>][</span><span class=nx>i</span><span class=p>]</span> <span class=o>=</span> <span class=nx>L_SH_R_3_arr</span><span class=p>[</span><span class=mi>2</span><span class=p>];</span>
</span></span><span class=line><span class=ln> 28</span><span class=cl>        <span class=nx>result</span><span class=p>[</span><span class=mi>4</span><span class=p>][</span><span class=nx>i</span><span class=p>]</span> <span class=o>=</span> <span class=nx>L_SH_R_5_arr</span><span class=p>[</span><span class=mi>0</span><span class=p>];</span>
</span></span><span class=line><span class=ln> 29</span><span class=cl>        <span class=nx>result</span><span class=p>[</span><span class=mi>5</span><span class=p>][</span><span class=nx>i</span><span class=p>]</span> <span class=o>=</span> <span class=nx>L_SH_R_5_arr</span><span class=p>[</span><span class=mi>1</span><span class=p>];</span>
</span></span><span class=line><span class=ln> 30</span><span class=cl>        <span class=nx>result</span><span class=p>[</span><span class=mi>6</span><span class=p>][</span><span class=nx>i</span><span class=p>]</span> <span class=o>=</span> <span class=nx>L_SH_R_5_arr</span><span class=p>[</span><span class=mi>2</span><span class=p>];</span>
</span></span><span class=line><span class=ln> 31</span><span class=cl>        <span class=nx>result</span><span class=p>[</span><span class=mi>7</span><span class=p>][</span><span class=nx>i</span><span class=p>]</span> <span class=o>=</span> <span class=nx>L_SH_R_5_arr</span><span class=p>[</span><span class=mi>3</span><span class=p>];</span>
</span></span><span class=line><span class=ln> 32</span><span class=cl>        <span class=nx>result</span><span class=p>[</span><span class=mi>8</span><span class=p>][</span><span class=nx>i</span><span class=p>]</span> <span class=o>=</span> <span class=nx>L_SH_R_5_arr</span><span class=p>[</span><span class=mi>4</span><span class=p>];</span>
</span></span><span class=line><span class=ln> 33</span><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=ln> 34</span><span class=cl>
</span></span><span class=line><span class=ln> 35</span><span class=cl>	<span class=k>return</span> <span class=nx>result</span><span class=p>;</span>
</span></span><span class=line><span class=ln> 36</span><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=ln> 37</span><span class=cl>
</span></span><span class=line><span class=ln> 38</span><span class=cl><span class=kd>function</span> <span class=nx>computeSquareMatrix_3by3</span><span class=p>(</span><span class=nx>rotationMatrix</span><span class=p>){</span> <span class=c1>// 计算方阵SA(-1) 3*3 
</span></span></span><span class=line><span class=ln> 39</span><span class=cl><span class=c1></span>	
</span></span><span class=line><span class=ln> 40</span><span class=cl>	<span class=c1>// 1、pick ni - {ni}
</span></span></span><span class=line><span class=ln> 41</span><span class=cl><span class=c1></span>	<span class=kd>let</span> <span class=nx>n1</span> <span class=o>=</span> <span class=p>[</span><span class=mi>1</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>];</span> <span class=kd>let</span> <span class=nx>n2</span> <span class=o>=</span> <span class=p>[</span><span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>0</span><span class=p>];</span> <span class=kd>let</span> <span class=nx>n3</span> <span class=o>=</span> <span class=p>[</span><span class=mi>0</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>];</span>
</span></span><span class=line><span class=ln> 42</span><span class=cl>
</span></span><span class=line><span class=ln> 43</span><span class=cl>	<span class=c1>// 2、{P(ni)} - A  A_inverse
</span></span></span><span class=line><span class=ln> 44</span><span class=cl><span class=c1></span>	<span class=kd>let</span> <span class=nx>pSHn1</span> <span class=o>=</span> <span class=nx>SHEval</span><span class=p>(</span><span class=nx>n1</span><span class=p>[</span><span class=mi>0</span><span class=p>],</span> <span class=nx>n1</span><span class=p>[</span><span class=mi>1</span><span class=p>],</span> <span class=nx>n1</span><span class=p>[</span><span class=mi>2</span><span class=p>],</span> <span class=mi>3</span><span class=p>);</span>
</span></span><span class=line><span class=ln> 45</span><span class=cl>	<span class=kd>let</span> <span class=nx>pSHn2</span> <span class=o>=</span> <span class=nx>SHEval</span><span class=p>(</span><span class=nx>n2</span><span class=p>[</span><span class=mi>0</span><span class=p>],</span> <span class=nx>n2</span><span class=p>[</span><span class=mi>1</span><span class=p>],</span> <span class=nx>n2</span><span class=p>[</span><span class=mi>2</span><span class=p>],</span> <span class=mi>3</span><span class=p>);</span>
</span></span><span class=line><span class=ln> 46</span><span class=cl>	<span class=kd>let</span> <span class=nx>pSHn3</span> <span class=o>=</span> <span class=nx>SHEval</span><span class=p>(</span><span class=nx>n3</span><span class=p>[</span><span class=mi>0</span><span class=p>],</span> <span class=nx>n3</span><span class=p>[</span><span class=mi>1</span><span class=p>],</span> <span class=nx>n3</span><span class=p>[</span><span class=mi>2</span><span class=p>],</span> <span class=mi>3</span><span class=p>);</span>
</span></span><span class=line><span class=ln> 47</span><span class=cl>	
</span></span><span class=line><span class=ln> 48</span><span class=cl>	<span class=kd>let</span> <span class=nx>A</span> <span class=o>=</span> <span class=nx>math</span><span class=p>.</span><span class=nx>matrix</span><span class=p>([</span>
</span></span><span class=line><span class=ln> 49</span><span class=cl>		<span class=p>[</span><span class=nx>pSHn1</span><span class=p>[</span><span class=mi>1</span><span class=p>],</span> <span class=nx>pSHn2</span><span class=p>[</span><span class=mi>1</span><span class=p>],</span> <span class=nx>pSHn3</span><span class=p>[</span><span class=mi>1</span><span class=p>]],</span> <span class=c1>// Y1^{-1} 
</span></span></span><span class=line><span class=ln> 50</span><span class=cl><span class=c1></span>		<span class=p>[</span><span class=nx>pSHn1</span><span class=p>[</span><span class=mi>2</span><span class=p>],</span> <span class=nx>pSHn2</span><span class=p>[</span><span class=mi>2</span><span class=p>],</span> <span class=nx>pSHn3</span><span class=p>[</span><span class=mi>2</span><span class=p>]],</span> <span class=c1>// Y1^{0}
</span></span></span><span class=line><span class=ln> 51</span><span class=cl><span class=c1></span>		<span class=p>[</span><span class=nx>pSHn1</span><span class=p>[</span><span class=mi>3</span><span class=p>],</span> <span class=nx>pSHn2</span><span class=p>[</span><span class=mi>3</span><span class=p>],</span> <span class=nx>pSHn3</span><span class=p>[</span><span class=mi>3</span><span class=p>]]</span>  <span class=c1>// Y1^{1}
</span></span></span><span class=line><span class=ln> 52</span><span class=cl><span class=c1></span>	<span class=p>]);</span>
</span></span><span class=line><span class=ln> 53</span><span class=cl>	<span class=kd>let</span> <span class=nx>A_inverse</span> <span class=o>=</span> <span class=nx>math</span><span class=p>.</span><span class=nx>inv</span><span class=p>(</span><span class=nx>A</span><span class=p>);</span>
</span></span><span class=line><span class=ln> 54</span><span class=cl>
</span></span><span class=line><span class=ln> 55</span><span class=cl>	<span class=c1>// 3、用 R 旋转 ni - {R(ni)}
</span></span></span><span class=line><span class=ln> 56</span><span class=cl><span class=c1></span>	<span class=kd>let</span> <span class=nx>Rn1</span> <span class=o>=</span> <span class=nx>math</span><span class=p>.</span><span class=nx>multiply</span><span class=p>(</span><span class=nx>rotationMatrix</span><span class=p>,</span> <span class=nx>n1</span><span class=p>);</span>
</span></span><span class=line><span class=ln> 57</span><span class=cl>	<span class=kd>let</span> <span class=nx>Rn2</span> <span class=o>=</span> <span class=nx>math</span><span class=p>.</span><span class=nx>multiply</span><span class=p>(</span><span class=nx>rotationMatrix</span><span class=p>,</span> <span class=nx>n2</span><span class=p>);</span>
</span></span><span class=line><span class=ln> 58</span><span class=cl>	<span class=kd>let</span> <span class=nx>Rn3</span> <span class=o>=</span> <span class=nx>math</span><span class=p>.</span><span class=nx>multiply</span><span class=p>(</span><span class=nx>rotationMatrix</span><span class=p>,</span> <span class=nx>n3</span><span class=p>);</span>
</span></span><span class=line><span class=ln> 59</span><span class=cl>
</span></span><span class=line><span class=ln> 60</span><span class=cl>	<span class=c1>// get array from math matrix
</span></span></span><span class=line><span class=ln> 61</span><span class=cl><span class=c1></span>	<span class=kd>let</span> <span class=nx>Rn1_arr</span> <span class=o>=</span> <span class=nx>Rn1</span><span class=p>.</span><span class=nx>toArray</span><span class=p>();</span>
</span></span><span class=line><span class=ln> 62</span><span class=cl>	<span class=kd>let</span> <span class=nx>Rn2_arr</span> <span class=o>=</span> <span class=nx>Rn2</span><span class=p>.</span><span class=nx>toArray</span><span class=p>();</span>
</span></span><span class=line><span class=ln> 63</span><span class=cl>	<span class=kd>let</span> <span class=nx>Rn3_arr</span> <span class=o>=</span> <span class=nx>Rn3</span><span class=p>.</span><span class=nx>toArray</span><span class=p>();</span>
</span></span><span class=line><span class=ln> 64</span><span class=cl>
</span></span><span class=line><span class=ln> 65</span><span class=cl>	<span class=c1>// 4、R(ni) SH投影 - S
</span></span></span><span class=line><span class=ln> 66</span><span class=cl><span class=c1></span>	<span class=kd>let</span> <span class=nx>pSHRn1</span> <span class=o>=</span> <span class=nx>SHEval</span><span class=p>(</span><span class=nx>Rn1_arr</span><span class=p>[</span><span class=mi>0</span><span class=p>],</span> <span class=nx>Rn1_arr</span><span class=p>[</span><span class=mi>1</span><span class=p>],</span> <span class=nx>Rn1_arr</span><span class=p>[</span><span class=mi>2</span><span class=p>],</span> <span class=mi>3</span><span class=p>);</span>
</span></span><span class=line><span class=ln> 67</span><span class=cl>	<span class=kd>let</span> <span class=nx>pSHRn2</span> <span class=o>=</span> <span class=nx>SHEval</span><span class=p>(</span><span class=nx>Rn2_arr</span><span class=p>[</span><span class=mi>0</span><span class=p>],</span> <span class=nx>Rn2_arr</span><span class=p>[</span><span class=mi>1</span><span class=p>],</span> <span class=nx>Rn2_arr</span><span class=p>[</span><span class=mi>2</span><span class=p>],</span> <span class=mi>3</span><span class=p>);</span>
</span></span><span class=line><span class=ln> 68</span><span class=cl>	<span class=kd>let</span> <span class=nx>pSHRn3</span> <span class=o>=</span> <span class=nx>SHEval</span><span class=p>(</span><span class=nx>Rn3_arr</span><span class=p>[</span><span class=mi>0</span><span class=p>],</span> <span class=nx>Rn3_arr</span><span class=p>[</span><span class=mi>1</span><span class=p>],</span> <span class=nx>Rn3_arr</span><span class=p>[</span><span class=mi>2</span><span class=p>],</span> <span class=mi>3</span><span class=p>);</span>
</span></span><span class=line><span class=ln> 69</span><span class=cl>
</span></span><span class=line><span class=ln> 70</span><span class=cl>	<span class=kd>let</span> <span class=nx>S</span> <span class=o>=</span> <span class=nx>math</span><span class=p>.</span><span class=nx>matrix</span><span class=p>([</span>
</span></span><span class=line><span class=ln> 71</span><span class=cl>		<span class=p>[</span><span class=nx>pSHRn1</span><span class=p>[</span><span class=mi>1</span><span class=p>],</span> <span class=nx>pSHRn2</span><span class=p>[</span><span class=mi>1</span><span class=p>],</span> <span class=nx>pSHRn3</span><span class=p>[</span><span class=mi>1</span><span class=p>]],</span> <span class=c1>// Y1^{-1}
</span></span></span><span class=line><span class=ln> 72</span><span class=cl><span class=c1></span>		<span class=p>[</span><span class=nx>pSHRn1</span><span class=p>[</span><span class=mi>2</span><span class=p>],</span> <span class=nx>pSHRn2</span><span class=p>[</span><span class=mi>2</span><span class=p>],</span> <span class=nx>pSHRn3</span><span class=p>[</span><span class=mi>2</span><span class=p>]],</span> <span class=c1>// Y1^{0}
</span></span></span><span class=line><span class=ln> 73</span><span class=cl><span class=c1></span>		<span class=p>[</span><span class=nx>pSHRn1</span><span class=p>[</span><span class=mi>3</span><span class=p>],</span> <span class=nx>pSHRn2</span><span class=p>[</span><span class=mi>3</span><span class=p>],</span> <span class=nx>pSHRn3</span><span class=p>[</span><span class=mi>3</span><span class=p>]]</span>  <span class=c1>// Y1^{1}
</span></span></span><span class=line><span class=ln> 74</span><span class=cl><span class=c1></span>	<span class=p>]);</span>
</span></span><span class=line><span class=ln> 75</span><span class=cl>
</span></span><span class=line><span class=ln> 76</span><span class=cl>	<span class=c1>// 5、S*A_inverse
</span></span></span><span class=line><span class=ln> 77</span><span class=cl><span class=c1></span>	<span class=kd>let</span> <span class=nx>SA_inverse</span> <span class=o>=</span> <span class=nx>math</span><span class=p>.</span><span class=nx>multiply</span><span class=p>(</span><span class=nx>S</span><span class=p>,</span> <span class=nx>A_inverse</span><span class=p>);</span>
</span></span><span class=line><span class=ln> 78</span><span class=cl>	<span class=k>return</span> <span class=nx>SA_inverse</span><span class=p>;</span>
</span></span><span class=line><span class=ln> 79</span><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=ln> 80</span><span class=cl>
</span></span><span class=line><span class=ln> 81</span><span class=cl><span class=kd>function</span> <span class=nx>computeSquareMatrix_5by5</span><span class=p>(</span><span class=nx>rotationMatrix</span><span class=p>){</span> <span class=c1>// 计算方阵SA(-1) 5*5
</span></span></span><span class=line><span class=ln> 82</span><span class=cl><span class=c1></span>	
</span></span><span class=line><span class=ln> 83</span><span class=cl>	<span class=c1>// 1、pick ni - {ni}
</span></span></span><span class=line><span class=ln> 84</span><span class=cl><span class=c1></span>	<span class=kd>let</span> <span class=nx>k</span> <span class=o>=</span> <span class=mi>1</span> <span class=o>/</span> <span class=nx>math</span><span class=p>.</span><span class=nx>sqrt</span><span class=p>(</span><span class=mi>2</span><span class=p>);</span>
</span></span><span class=line><span class=ln> 85</span><span class=cl>	<span class=kd>let</span> <span class=nx>n1</span> <span class=o>=</span> <span class=p>[</span><span class=mi>1</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>];</span> <span class=kd>let</span> <span class=nx>n2</span> <span class=o>=</span> <span class=p>[</span><span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>0</span><span class=p>];</span> <span class=kd>let</span> <span class=nx>n3</span> <span class=o>=</span> <span class=p>[</span><span class=nx>k</span><span class=p>,</span> <span class=nx>k</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>];</span> 
</span></span><span class=line><span class=ln> 86</span><span class=cl>	<span class=kd>let</span> <span class=nx>n4</span> <span class=o>=</span> <span class=p>[</span><span class=nx>k</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=nx>k</span><span class=p>,</span> <span class=mi>0</span><span class=p>];</span> <span class=kd>let</span> <span class=nx>n5</span> <span class=o>=</span> <span class=p>[</span><span class=mi>0</span><span class=p>,</span> <span class=nx>k</span><span class=p>,</span> <span class=nx>k</span><span class=p>,</span> <span class=mi>0</span><span class=p>];</span>
</span></span><span class=line><span class=ln> 87</span><span class=cl>
</span></span><span class=line><span class=ln> 88</span><span class=cl>	<span class=c1>// 2、{P(ni)} - A  A_inverse
</span></span></span><span class=line><span class=ln> 89</span><span class=cl><span class=c1></span>	<span class=kd>let</span> <span class=nx>pSHn1</span> <span class=o>=</span> <span class=nx>SHEval</span><span class=p>(</span><span class=nx>n1</span><span class=p>[</span><span class=mi>0</span><span class=p>],</span> <span class=nx>n1</span><span class=p>[</span><span class=mi>1</span><span class=p>],</span> <span class=nx>n1</span><span class=p>[</span><span class=mi>2</span><span class=p>],</span> <span class=mi>3</span><span class=p>);</span>
</span></span><span class=line><span class=ln> 90</span><span class=cl>	<span class=kd>let</span> <span class=nx>pSHn2</span> <span class=o>=</span> <span class=nx>SHEval</span><span class=p>(</span><span class=nx>n2</span><span class=p>[</span><span class=mi>0</span><span class=p>],</span> <span class=nx>n2</span><span class=p>[</span><span class=mi>1</span><span class=p>],</span> <span class=nx>n2</span><span class=p>[</span><span class=mi>2</span><span class=p>],</span> <span class=mi>3</span><span class=p>);</span>
</span></span><span class=line><span class=ln> 91</span><span class=cl>	<span class=kd>let</span> <span class=nx>pSHn3</span> <span class=o>=</span> <span class=nx>SHEval</span><span class=p>(</span><span class=nx>n3</span><span class=p>[</span><span class=mi>0</span><span class=p>],</span> <span class=nx>n3</span><span class=p>[</span><span class=mi>1</span><span class=p>],</span> <span class=nx>n3</span><span class=p>[</span><span class=mi>2</span><span class=p>],</span> <span class=mi>3</span><span class=p>);</span>
</span></span><span class=line><span class=ln> 92</span><span class=cl>	<span class=kd>let</span> <span class=nx>pSHn4</span> <span class=o>=</span> <span class=nx>SHEval</span><span class=p>(</span><span class=nx>n4</span><span class=p>[</span><span class=mi>0</span><span class=p>],</span> <span class=nx>n4</span><span class=p>[</span><span class=mi>1</span><span class=p>],</span> <span class=nx>n4</span><span class=p>[</span><span class=mi>2</span><span class=p>],</span> <span class=mi>3</span><span class=p>);</span>
</span></span><span class=line><span class=ln> 93</span><span class=cl>	<span class=kd>let</span> <span class=nx>pSHn5</span> <span class=o>=</span> <span class=nx>SHEval</span><span class=p>(</span><span class=nx>n5</span><span class=p>[</span><span class=mi>0</span><span class=p>],</span> <span class=nx>n5</span><span class=p>[</span><span class=mi>1</span><span class=p>],</span> <span class=nx>n5</span><span class=p>[</span><span class=mi>2</span><span class=p>],</span> <span class=mi>3</span><span class=p>);</span>
</span></span><span class=line><span class=ln> 94</span><span class=cl>
</span></span><span class=line><span class=ln> 95</span><span class=cl>	<span class=kd>let</span> <span class=nx>A</span> <span class=o>=</span> <span class=nx>math</span><span class=p>.</span><span class=nx>matrix</span><span class=p>([</span>
</span></span><span class=line><span class=ln> 96</span><span class=cl>		<span class=p>[</span><span class=nx>pSHn1</span><span class=p>[</span><span class=mi>4</span><span class=p>],</span> <span class=nx>pSHn2</span><span class=p>[</span><span class=mi>4</span><span class=p>],</span> <span class=nx>pSHn3</span><span class=p>[</span><span class=mi>4</span><span class=p>],</span> <span class=nx>pSHn4</span><span class=p>[</span><span class=mi>4</span><span class=p>],</span> <span class=nx>pSHn5</span><span class=p>[</span><span class=mi>4</span><span class=p>]],</span> <span class=c1>// Y2^{-2} 
</span></span></span><span class=line><span class=ln> 97</span><span class=cl><span class=c1></span>		<span class=p>[</span><span class=nx>pSHn1</span><span class=p>[</span><span class=mi>5</span><span class=p>],</span> <span class=nx>pSHn2</span><span class=p>[</span><span class=mi>5</span><span class=p>],</span> <span class=nx>pSHn3</span><span class=p>[</span><span class=mi>5</span><span class=p>],</span> <span class=nx>pSHn4</span><span class=p>[</span><span class=mi>5</span><span class=p>],</span> <span class=nx>pSHn5</span><span class=p>[</span><span class=mi>5</span><span class=p>]],</span> <span class=c1>// Y2^{-1}
</span></span></span><span class=line><span class=ln> 98</span><span class=cl><span class=c1></span>		<span class=p>[</span><span class=nx>pSHn1</span><span class=p>[</span><span class=mi>6</span><span class=p>],</span> <span class=nx>pSHn2</span><span class=p>[</span><span class=mi>6</span><span class=p>],</span> <span class=nx>pSHn3</span><span class=p>[</span><span class=mi>6</span><span class=p>],</span> <span class=nx>pSHn4</span><span class=p>[</span><span class=mi>6</span><span class=p>],</span> <span class=nx>pSHn5</span><span class=p>[</span><span class=mi>6</span><span class=p>]],</span> <span class=c1>// Y2^{0}
</span></span></span><span class=line><span class=ln> 99</span><span class=cl><span class=c1></span>		<span class=p>[</span><span class=nx>pSHn1</span><span class=p>[</span><span class=mi>7</span><span class=p>],</span> <span class=nx>pSHn2</span><span class=p>[</span><span class=mi>7</span><span class=p>],</span> <span class=nx>pSHn3</span><span class=p>[</span><span class=mi>7</span><span class=p>],</span> <span class=nx>pSHn4</span><span class=p>[</span><span class=mi>7</span><span class=p>],</span> <span class=nx>pSHn5</span><span class=p>[</span><span class=mi>7</span><span class=p>]],</span> <span class=c1>// Y2^{1}
</span></span></span><span class=line><span class=ln>100</span><span class=cl><span class=c1></span>		<span class=p>[</span><span class=nx>pSHn1</span><span class=p>[</span><span class=mi>8</span><span class=p>],</span> <span class=nx>pSHn2</span><span class=p>[</span><span class=mi>8</span><span class=p>],</span> <span class=nx>pSHn3</span><span class=p>[</span><span class=mi>8</span><span class=p>],</span> <span class=nx>pSHn4</span><span class=p>[</span><span class=mi>8</span><span class=p>],</span> <span class=nx>pSHn5</span><span class=p>[</span><span class=mi>8</span><span class=p>]]</span>  <span class=c1>// Y2^{2}
</span></span></span><span class=line><span class=ln>101</span><span class=cl><span class=c1></span>	<span class=p>]);</span>
</span></span><span class=line><span class=ln>102</span><span class=cl>	<span class=kd>let</span> <span class=nx>A_inverse</span> <span class=o>=</span> <span class=nx>math</span><span class=p>.</span><span class=nx>inv</span><span class=p>(</span><span class=nx>A</span><span class=p>);</span>
</span></span><span class=line><span class=ln>103</span><span class=cl>
</span></span><span class=line><span class=ln>104</span><span class=cl>	<span class=c1>// 3、用 R 旋转 ni - {R(ni)}
</span></span></span><span class=line><span class=ln>105</span><span class=cl><span class=c1></span>	<span class=kd>let</span> <span class=nx>Rn1</span> <span class=o>=</span> <span class=nx>math</span><span class=p>.</span><span class=nx>multiply</span><span class=p>(</span><span class=nx>rotationMatrix</span><span class=p>,</span> <span class=nx>n1</span><span class=p>);</span>
</span></span><span class=line><span class=ln>106</span><span class=cl>	<span class=kd>let</span> <span class=nx>Rn2</span> <span class=o>=</span> <span class=nx>math</span><span class=p>.</span><span class=nx>multiply</span><span class=p>(</span><span class=nx>rotationMatrix</span><span class=p>,</span> <span class=nx>n2</span><span class=p>);</span>
</span></span><span class=line><span class=ln>107</span><span class=cl>	<span class=kd>let</span> <span class=nx>Rn3</span> <span class=o>=</span> <span class=nx>math</span><span class=p>.</span><span class=nx>multiply</span><span class=p>(</span><span class=nx>rotationMatrix</span><span class=p>,</span> <span class=nx>n3</span><span class=p>);</span>
</span></span><span class=line><span class=ln>108</span><span class=cl>	<span class=kd>let</span> <span class=nx>Rn4</span> <span class=o>=</span> <span class=nx>math</span><span class=p>.</span><span class=nx>multiply</span><span class=p>(</span><span class=nx>rotationMatrix</span><span class=p>,</span> <span class=nx>n4</span><span class=p>);</span>
</span></span><span class=line><span class=ln>109</span><span class=cl>	<span class=kd>let</span> <span class=nx>Rn5</span> <span class=o>=</span> <span class=nx>math</span><span class=p>.</span><span class=nx>multiply</span><span class=p>(</span><span class=nx>rotationMatrix</span><span class=p>,</span> <span class=nx>n5</span><span class=p>);</span>
</span></span><span class=line><span class=ln>110</span><span class=cl>
</span></span><span class=line><span class=ln>111</span><span class=cl>	<span class=c1>// get array from math matrix
</span></span></span><span class=line><span class=ln>112</span><span class=cl><span class=c1></span>	<span class=kd>let</span> <span class=nx>Rn1_arr</span> <span class=o>=</span> <span class=nx>Rn1</span><span class=p>.</span><span class=nx>toArray</span><span class=p>();</span>
</span></span><span class=line><span class=ln>113</span><span class=cl>	<span class=kd>let</span> <span class=nx>Rn2_arr</span> <span class=o>=</span> <span class=nx>Rn2</span><span class=p>.</span><span class=nx>toArray</span><span class=p>();</span>
</span></span><span class=line><span class=ln>114</span><span class=cl>	<span class=kd>let</span> <span class=nx>Rn3_arr</span> <span class=o>=</span> <span class=nx>Rn3</span><span class=p>.</span><span class=nx>toArray</span><span class=p>();</span>
</span></span><span class=line><span class=ln>115</span><span class=cl>	<span class=kd>let</span> <span class=nx>Rn4_arr</span> <span class=o>=</span> <span class=nx>Rn4</span><span class=p>.</span><span class=nx>toArray</span><span class=p>();</span>
</span></span><span class=line><span class=ln>116</span><span class=cl>	<span class=kd>let</span> <span class=nx>Rn5_arr</span> <span class=o>=</span> <span class=nx>Rn5</span><span class=p>.</span><span class=nx>toArray</span><span class=p>();</span>
</span></span><span class=line><span class=ln>117</span><span class=cl>
</span></span><span class=line><span class=ln>118</span><span class=cl>	<span class=c1>// 4、R(ni) SH投影 - S
</span></span></span><span class=line><span class=ln>119</span><span class=cl><span class=c1></span>	<span class=kd>let</span> <span class=nx>pSHRn1</span> <span class=o>=</span> <span class=nx>SHEval</span><span class=p>(</span><span class=nx>Rn1_arr</span><span class=p>[</span><span class=mi>0</span><span class=p>],</span> <span class=nx>Rn1_arr</span><span class=p>[</span><span class=mi>1</span><span class=p>],</span> <span class=nx>Rn1_arr</span><span class=p>[</span><span class=mi>2</span><span class=p>],</span> <span class=mi>3</span><span class=p>);</span>
</span></span><span class=line><span class=ln>120</span><span class=cl>	<span class=kd>let</span> <span class=nx>pSHRn2</span> <span class=o>=</span> <span class=nx>SHEval</span><span class=p>(</span><span class=nx>Rn2_arr</span><span class=p>[</span><span class=mi>0</span><span class=p>],</span> <span class=nx>Rn2_arr</span><span class=p>[</span><span class=mi>1</span><span class=p>],</span> <span class=nx>Rn2_arr</span><span class=p>[</span><span class=mi>2</span><span class=p>],</span> <span class=mi>3</span><span class=p>);</span>
</span></span><span class=line><span class=ln>121</span><span class=cl>	<span class=kd>let</span> <span class=nx>pSHRn3</span> <span class=o>=</span> <span class=nx>SHEval</span><span class=p>(</span><span class=nx>Rn3_arr</span><span class=p>[</span><span class=mi>0</span><span class=p>],</span> <span class=nx>Rn3_arr</span><span class=p>[</span><span class=mi>1</span><span class=p>],</span> <span class=nx>Rn3_arr</span><span class=p>[</span><span class=mi>2</span><span class=p>],</span> <span class=mi>3</span><span class=p>);</span>
</span></span><span class=line><span class=ln>122</span><span class=cl>	<span class=kd>let</span> <span class=nx>pSHRn4</span> <span class=o>=</span> <span class=nx>SHEval</span><span class=p>(</span><span class=nx>Rn4_arr</span><span class=p>[</span><span class=mi>0</span><span class=p>],</span> <span class=nx>Rn4_arr</span><span class=p>[</span><span class=mi>1</span><span class=p>],</span> <span class=nx>Rn4_arr</span><span class=p>[</span><span class=mi>2</span><span class=p>],</span> <span class=mi>3</span><span class=p>);</span>
</span></span><span class=line><span class=ln>123</span><span class=cl>	<span class=kd>let</span> <span class=nx>pSHRn5</span> <span class=o>=</span> <span class=nx>SHEval</span><span class=p>(</span><span class=nx>Rn5_arr</span><span class=p>[</span><span class=mi>0</span><span class=p>],</span> <span class=nx>Rn5_arr</span><span class=p>[</span><span class=mi>1</span><span class=p>],</span> <span class=nx>Rn5_arr</span><span class=p>[</span><span class=mi>2</span><span class=p>],</span> <span class=mi>3</span><span class=p>);</span>
</span></span><span class=line><span class=ln>124</span><span class=cl>
</span></span><span class=line><span class=ln>125</span><span class=cl>	<span class=kd>let</span> <span class=nx>S</span> <span class=o>=</span> <span class=nx>math</span><span class=p>.</span><span class=nx>matrix</span><span class=p>([</span>
</span></span><span class=line><span class=ln>126</span><span class=cl>		<span class=p>[</span><span class=nx>pSHRn1</span><span class=p>[</span><span class=mi>4</span><span class=p>],</span> <span class=nx>pSHRn2</span><span class=p>[</span><span class=mi>4</span><span class=p>],</span> <span class=nx>pSHRn3</span><span class=p>[</span><span class=mi>4</span><span class=p>],</span> <span class=nx>pSHRn4</span><span class=p>[</span><span class=mi>4</span><span class=p>],</span> <span class=nx>pSHRn5</span><span class=p>[</span><span class=mi>4</span><span class=p>]],</span> <span class=c1>// Y2^{-2}
</span></span></span><span class=line><span class=ln>127</span><span class=cl><span class=c1></span>		<span class=p>[</span><span class=nx>pSHRn1</span><span class=p>[</span><span class=mi>5</span><span class=p>],</span> <span class=nx>pSHRn2</span><span class=p>[</span><span class=mi>5</span><span class=p>],</span> <span class=nx>pSHRn3</span><span class=p>[</span><span class=mi>5</span><span class=p>],</span> <span class=nx>pSHRn4</span><span class=p>[</span><span class=mi>5</span><span class=p>],</span> <span class=nx>pSHRn5</span><span class=p>[</span><span class=mi>5</span><span class=p>]],</span> <span class=c1>// Y2^{-1}
</span></span></span><span class=line><span class=ln>128</span><span class=cl><span class=c1></span>		<span class=p>[</span><span class=nx>pSHRn1</span><span class=p>[</span><span class=mi>6</span><span class=p>],</span> <span class=nx>pSHRn2</span><span class=p>[</span><span class=mi>6</span><span class=p>],</span> <span class=nx>pSHRn3</span><span class=p>[</span><span class=mi>6</span><span class=p>],</span> <span class=nx>pSHRn4</span><span class=p>[</span><span class=mi>6</span><span class=p>],</span> <span class=nx>pSHRn5</span><span class=p>[</span><span class=mi>6</span><span class=p>]],</span> <span class=c1>// Y2^{0}
</span></span></span><span class=line><span class=ln>129</span><span class=cl><span class=c1></span>		<span class=p>[</span><span class=nx>pSHRn1</span><span class=p>[</span><span class=mi>7</span><span class=p>],</span> <span class=nx>pSHRn2</span><span class=p>[</span><span class=mi>7</span><span class=p>],</span> <span class=nx>pSHRn3</span><span class=p>[</span><span class=mi>7</span><span class=p>],</span> <span class=nx>pSHRn4</span><span class=p>[</span><span class=mi>7</span><span class=p>],</span> <span class=nx>pSHRn5</span><span class=p>[</span><span class=mi>7</span><span class=p>]],</span> <span class=c1>// Y2^{1}
</span></span></span><span class=line><span class=ln>130</span><span class=cl><span class=c1></span>		<span class=p>[</span><span class=nx>pSHRn1</span><span class=p>[</span><span class=mi>8</span><span class=p>],</span> <span class=nx>pSHRn2</span><span class=p>[</span><span class=mi>8</span><span class=p>],</span> <span class=nx>pSHRn3</span><span class=p>[</span><span class=mi>8</span><span class=p>],</span> <span class=nx>pSHRn4</span><span class=p>[</span><span class=mi>8</span><span class=p>],</span> <span class=nx>pSHRn5</span><span class=p>[</span><span class=mi>8</span><span class=p>]]</span>  <span class=c1>// Y2^{2}
</span></span></span><span class=line><span class=ln>131</span><span class=cl><span class=c1></span>	<span class=p>]);</span>
</span></span><span class=line><span class=ln>132</span><span class=cl>
</span></span><span class=line><span class=ln>133</span><span class=cl>	<span class=c1>// 5、S*A_inverse
</span></span></span><span class=line><span class=ln>134</span><span class=cl><span class=c1></span>	<span class=kd>let</span> <span class=nx>SA_inverse</span> <span class=o>=</span> <span class=nx>math</span><span class=p>.</span><span class=nx>multiply</span><span class=p>(</span><span class=nx>S</span><span class=p>,</span> <span class=nx>A_inverse</span><span class=p>);</span>
</span></span><span class=line><span class=ln>135</span><span class=cl>	<span class=k>return</span> <span class=nx>SA_inverse</span><span class=p>;</span>
</span></span><span class=line><span class=ln>136</span><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>有一些要注意的点，旋转天空盒的矩阵是如下代码生成并传入 Shader 的：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=ln> 1</span><span class=cl><span class=c1>// WebGLRenderer.js
</span></span></span><span class=line><span class=ln> 2</span><span class=cl><span class=c1></span><span class=kd>let</span> <span class=nx>cameraModelMatrix</span> <span class=o>=</span> <span class=nx>mat4</span><span class=p>.</span><span class=nx>create</span><span class=p>();</span>
</span></span><span class=line><span class=ln> 3</span><span class=cl><span class=nx>mat4</span><span class=p>.</span><span class=nx>fromRotation</span><span class=p>(</span><span class=nx>cameraModelMatrix</span><span class=p>,</span> <span class=nx>timer</span><span class=p>,</span> <span class=p>[</span><span class=mi>0</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>0</span><span class=p>]);</span>
</span></span><span class=line><span class=ln> 4</span><span class=cl>
</span></span><span class=line><span class=ln> 5</span><span class=cl><span class=k>if</span> <span class=p>(</span><span class=nx>k</span> <span class=o>==</span> <span class=s1>&#39;uMoveWithCamera&#39;</span><span class=p>)</span> <span class=p>{</span> <span class=c1>// The rotation of the skybox
</span></span></span><span class=line><span class=ln> 6</span><span class=cl><span class=c1></span>	<span class=nx>gl</span><span class=p>.</span><span class=nx>uniformMatrix4fv</span><span class=p>(</span>
</span></span><span class=line><span class=ln> 7</span><span class=cl>		<span class=k>this</span><span class=p>.</span><span class=nx>meshes</span><span class=p>[</span><span class=nx>i</span><span class=p>].</span><span class=nx>shader</span><span class=p>.</span><span class=nx>program</span><span class=p>.</span><span class=nx>uniforms</span><span class=p>[</span><span class=nx>k</span><span class=p>],</span>
</span></span><span class=line><span class=ln> 8</span><span class=cl>		<span class=kc>false</span><span class=p>,</span>
</span></span><span class=line><span class=ln> 9</span><span class=cl>		<span class=nx>cameraModelMatrix</span><span class=p>);</span>
</span></span><span class=line><span class=ln>10</span><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>对整个环境纹理进行旋转，对某一个方向 $n_{i}$ 来说，旋转后的 Lighting 相当于对这个方向应用旋转矩阵的逆，即在原始天空盒的 $R^{-1}n_{i}$ 方向的 Lighting 的值，所以传入计算球谐函数的旋转矩阵是天空盒旋转矩阵的逆（由于旋转矩阵是单位阵，所以等价于转置）。</p><p>tools.js 有一个函数 <code>mat4Matrix2mathMatrix</code>，按照名字应该是把 WebGL 的矩阵格式转换为 math.js 的矩阵格式：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=ln> 1</span><span class=cl><span class=kd>function</span> <span class=nx>mat4Matrix2mathMatrix</span><span class=p>(</span><span class=nx>rotationMatrix</span><span class=p>){</span>
</span></span><span class=line><span class=ln> 2</span><span class=cl>
</span></span><span class=line><span class=ln> 3</span><span class=cl>	<span class=kd>let</span> <span class=nx>mathMatrix</span> <span class=o>=</span> <span class=p>[];</span>
</span></span><span class=line><span class=ln> 4</span><span class=cl>	<span class=k>for</span><span class=p>(</span><span class=kd>let</span> <span class=nx>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=nx>i</span> <span class=o>&lt;</span> <span class=mi>4</span><span class=p>;</span> <span class=nx>i</span><span class=o>++</span><span class=p>){</span>
</span></span><span class=line><span class=ln> 5</span><span class=cl>		<span class=kd>let</span> <span class=nx>r</span> <span class=o>=</span> <span class=p>[];</span>
</span></span><span class=line><span class=ln> 6</span><span class=cl>		<span class=k>for</span><span class=p>(</span><span class=kd>let</span> <span class=nx>j</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=nx>j</span> <span class=o>&lt;</span> <span class=mi>4</span><span class=p>;</span> <span class=nx>j</span><span class=o>++</span><span class=p>){</span>
</span></span><span class=line><span class=ln> 7</span><span class=cl>			<span class=nx>r</span><span class=p>.</span><span class=nx>push</span><span class=p>(</span><span class=nx>rotationMatrix</span><span class=p>[</span><span class=nx>i</span><span class=o>*</span><span class=mi>4</span><span class=o>+</span><span class=nx>j</span><span class=p>]);</span>
</span></span><span class=line><span class=ln> 8</span><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=ln> 9</span><span class=cl>		<span class=nx>mathMatrix</span><span class=p>.</span><span class=nx>push</span><span class=p>(</span><span class=nx>r</span><span class=p>);</span>
</span></span><span class=line><span class=ln>10</span><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=ln>11</span><span class=cl>	<span class=k>return</span> <span class=nx>math</span><span class=p>.</span><span class=nx>matrix</span><span class=p>(</span><span class=nx>mathMatrix</span><span class=p>)</span>
</span></span><span class=line><span class=ln>12</span><span class=cl>
</span></span><span class=line><span class=ln>13</span><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>看起来好像是把东西都掏出来再塞回去，不过这俩矩阵存储方式是不一样的，WebGL 是按行优先存储，而 math.js 是按列优先，如果做下打印：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=ln>1</span><span class=cl><span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s2>&#34;WebGL mat4:&#34;</span><span class=p>,</span> <span class=nx>cameraModelMatrix</span><span class=p>);</span>
</span></span><span class=line><span class=ln>2</span><span class=cl><span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s2>&#34;math matrix:&#34;</span><span class=p>,</span> <span class=nx>mat4Matrix2mathMatrix</span><span class=p>(</span><span class=nx>cameraModelMatrix</span><span class=p>));</span>
</span></span></code></pre></div><p><img loading=lazy src=https://raw.gitmirror.com/congyuxiaoyoudao/Picgo-ImageBed/main/Assignments/Assignment%205.GAMES202HW2/202504261451794.png#center></p><p>会发现这俩看起来似乎一样，但是在内存中存储的方式有区别。WebGL 在内存中以<strong>一维数组</strong>形式排布，math.js 的矩阵在内存中按行以二维数组存储：</p><div>$$
WebGLMatrix=\begin{bmatrix}
m_{00} & m_{10} & m_{20} &m_{30} \\
m_{01} & m_{11} & m_{21} &m_{31} \\
m_{02} & m_{12} & m_{22} &m_{32} \\
m_{03} & m_{13} & m_{23} &m_{33}
\end{bmatrix},\quad
mathMatrix=\begin{bmatrix}
\left[ m_{00},m_{01},m_{02},m_{03} \right] \\
\left[ m_{10},m_{11},m_{12},m_{13} \right] \\
\left[ m_{20},m_{21},m_{22},m_{23} \right] \\
\left[ m_{30},m_{31},m_{32},m_{33} \right]
\end{bmatrix}
$$</div><p>所以 <code>mat4Matrix2mathMatrix</code> 这个函数实际上就是把 WebGL 矩阵转到 math.js 的矩阵，还做了一次转置，相当于直接拿到了旋转矩阵的逆，可以在 <code>getRotationPrecomputeL</code> 中直接调用这个函数获得天空盒旋转矩阵的逆，然后再传入 <code>computeSquareMatrix_xbyx</code> 计算球谐系数的旋转矩阵。另外，由于该矩阵是 math.js 封装的 matrix，调用 <code>math.multiply</code> 方法的返回值还是 matrix（即便是矩阵乘向量），所以不能通过下标访问，可以使用 <code>._data[i]</code> 或者先用 <code>.toArray</code> 方法拿到数组，再按下标访问。</p><p>最后将 WebGLRenderer.js 第 53 和第 63 行取消注释，不出意外就能看到模型的着色正确跟随天空盒旋转！</p><p><img loading=lazy src=https://raw.gitmirror.com/congyuxiaoyoudao/Picgo-ImageBed/main/Assignments/Assignment%205.GAMES202HW2/202504261631929.png#center></p></div><footer class=post-footer><ul class=post-tags><li><a href=https://congyuxiaoyoudao.github.io/tags/games202/>GAMES202</a></li></ul><nav class=paginav><a class=prev href=https://congyuxiaoyoudao.github.io/posts/assignments/games202-homework-3/><span class=title>« 上一页</span><br><span>Assignment 6. GAMES202 Homework 3</span>
</a><a class=next href=https://congyuxiaoyoudao.github.io/posts/assignments/games202-homework-1/><span class=title>下一页 »</span><br><span>Assignment 4. GAMES202 Homework 1</span></a></nav></footer><div id=tw-comment></div><script>const getStoredTheme=()=>localStorage.getItem("pref-theme")==="light"?"light":"noborder_dark",setGiscusTheme=()=>{const e=e=>{const t=document.querySelector("iframe.giscus-frame");t&&t.contentWindow.postMessage({giscus:e},"https://giscus.app")};e({setConfig:{theme:getStoredTheme()}})};document.addEventListener("DOMContentLoaded",()=>{const s={src:"https://giscus.app/client.js","data-repo":"congyuxiaoyoudao/congyuxiaoyoudao.github.io","data-repo-id":"","data-category":"Announcements","data-category-id":"","data-mapping":"pathname","data-strict":"0","data-reactions-enabled":"","data-emit-metadata":"","data-input-position":"","data-theme":getStoredTheme(),"data-lang":"zh-CN","data-loading":"lazy",crossorigin:"anonymous"},e=document.createElement("script");Object.entries(s).forEach(([t,n])=>e.setAttribute(t,n)),document.querySelector("#tw-comment").appendChild(e);const t=document.querySelector("#theme-toggle");t&&t.addEventListener("click",setGiscusTheme);const n=document.querySelector("#theme-toggle-float");n&&n.addEventListener("click",setGiscusTheme)})</script></article></main><footer class=footer><span>&copy; 2025 <a href=https://congyuxiaoyoudao.github.io/>The Only Problem's Blog</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
<a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentColor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="复制";function s(){t.innerHTML="已复制！",setTimeout(()=>{t.innerHTML="复制"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>