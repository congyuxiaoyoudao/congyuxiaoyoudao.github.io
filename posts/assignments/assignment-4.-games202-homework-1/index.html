<!doctype html><html lang=zh dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>The Only Problem's Blog</title><meta name=keywords content><meta name=description content="
ä¸è¦å¿˜è®°æ”¹å›¾åºŠä¸Šä¼ åœ°å€ï¼
Assignmentç³»åˆ—ï¼šAssignments/Assignment 4.GAMES202HW1/









  Assignment 2. A Review of Realistic Water Waveform Simulation



ğŸš© 0x00 To begin with
è¿™ç¯‡æ–‡ç« å°†ä¼šåŒ…å«ä»¥ä¸‹å†…å®¹ï¼š

 GAMES202 ä½œä¸š 1
 ä¸åŒ…å«ä½œä¸šæ¡†æ¶åˆ†æ

For referenceğŸ‘‡ï¼š

ğŸ“º B ç«™è§†é¢‘ï¼š








  GAMES202-é«˜è´¨é‡å®æ—¶æ¸²æŸ“


ğŸ“¦ ä»£ç ä»“åº“ï¼š








  congyuxiaoyoudao/GAMES202_Homework at working




master åˆ†æ”¯ä¸Šæ˜¯ 202 å…¨éƒ¨ä½œä¸šæ±‡æ€»ï¼Œworking åˆ†æ”¯ç”¨äºæäº¤ä»£ç ã€‚éœ€è¦åŸå§‹ä½œä¸šå¯ä¸‹è½½ master åˆ†æ”¯çš„åŒ…

0x01 Shadow Map
å®Œæˆä¸¤ä¸ªä»»åŠ¡ç‚¹ï¼š

ç¬¬ä¸€ä¸ª Pass ä»¥å…‰æºä½œä¸ºç›¸æœºæ¸²æŸ“ä¸€å¼  ShadowMapï¼Œéœ€è¦ä¸º Shader ä¼ é€’æ­£ç¡®çš„ uLightMVP çŸ©é˜µï¼›
ç¬¬äºŒä¸ª Pass è·å–å…‰æºä¼ é€’çš„ç»Ÿä¸€å˜é‡ FBO ï¼ˆShadowMapï¼‰ï¼Œéœ€è¦æ¯”è¾ƒå½“å‰ ShadingPoint çš„æ·±åº¦å€¼ä¸ ShadowMap ä¸Šè®°å½•çš„æ·±åº¦å€¼ï¼Œå¾—å‡ºå¯è§æ€§é¡¹ä¸ Shading ç»“æœç›¸ä¹˜ã€‚

DirectionalLight.js ä¸­ï¼Œå®Œå–„ CalcLightMVP å‡½æ•°ï¼š

 1		// Model transform
 2        mat4.translate(modelMatrix, modelMatrix, translate);
 3        mat4.scale(modelMatrix, modelMatrix, scale);
 4
 5        // View transform
 6        mat4.lookAt(viewMatrix, this.lightPos, this.focalPoint, this.lightUp);
 7
 8        // Projection transform
 9        var r = 100;
10        var l = -r;
11        var t = 100;
12        var b = -t;
13        var n = 0.01;
14        // caution! Depth of far plane should be a bit more larger
15        var f = 400;
16        
17        mat4.ortho(projectionMatrix, l, r, b, t, n, f);

è¿œå¹³é¢éœ€è®¾ç½®å¾—ç¨å¾®å¤§ä¸€ç‚¹ï¼Œé¿å…å…‰æºçš„è§†é”¥èŒƒå›´æ— æ³•è¦†ç›–å…¨éƒ¨åœºæ™¯"><meta name=author content="The Only Problem"><link rel=canonical href=https://congyuxiaoyoudao.github.io/posts/assignments/assignment-4.-games202-homework-1/><link crossorigin=anonymous href=/assets/css/stylesheet.452758010f0b7fc9ad7fa528ffdfdd8eb9e830816fb8c8119f16f39583297db8.css integrity="sha256-RSdYAQ8Lf8mtf6Uo/9/djrnoMIFvuMgRnxbzlYMpfbg=" rel="preload stylesheet" as=style><link rel=icon href=https://congyuxiaoyoudao.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://congyuxiaoyoudao.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://congyuxiaoyoudao.github.io/favicon-32x32.png><link rel=apple-touch-icon href=https://congyuxiaoyoudao.github.io/apple-touch-icon.png><link rel=mask-icon href=https://congyuxiaoyoudao.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=zh href=https://congyuxiaoyoudao.github.io/posts/assignments/assignment-4.-games202-homework-1/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.16.10/dist/katex.min.css integrity=sha384-wcIxkf4k558AjM3Yz3BBFQUbk/zgIYC2R0QpeeYb+TwlBVMrlgLqwRjRtGZiK7ww crossorigin=anonymous><script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.10/dist/katex.min.js integrity=sha384-hIoBPJpTUs74ddyc4bFZSM1TVlQDA60VBbJS0oA934VSz82sBx1X7kSx2ATBDIyd crossorigin=anonymous></script><script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.10/dist/contrib/auto-render.min.js integrity=sha384-43gviWU0YVjaDtb/GhzOouOXtZMP/7XUzwPTstBeZFe/+rCMvRwr4yROQP43s0Xk crossorigin=anonymous onload='window.addEventListener("DOMContentLoaded",function(){renderMathInElement(document.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1},{left:"\\$$",right:"\\\\$$",display:!1},{left:"\\$$",right:"\\\\$$",display:!0}]})})'></script><link rel=preconnect href=https://fonts.googleapis.com><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:ital,wght@0,100..800;1,100..800&display=swap" rel=stylesheet><link rel=stylesheet href=https://cdn.bootcdn.net/ajax/libs/lxgw-wenkai-screen-webfont/1.7.0/style.min.css><meta property="og:url" content="https://congyuxiaoyoudao.github.io/posts/assignments/assignment-4.-games202-homework-1/"><meta property="og:site_name" content="The Only Problem's Blog"><meta property="og:title" content="The Only Problem's Blog"><meta property="og:description" content=" ä¸è¦å¿˜è®°æ”¹å›¾åºŠä¸Šä¼ åœ°å€ï¼ Assignmentç³»åˆ—ï¼šAssignments/Assignment 4.GAMES202HW1/ Assignment 2. A Review of Realistic Water Waveform Simulation ğŸš© 0x00 To begin with è¿™ç¯‡æ–‡ç« å°†ä¼šåŒ…å«ä»¥ä¸‹å†…å®¹ï¼š
GAMES202 ä½œä¸š 1 ä¸åŒ…å«ä½œä¸šæ¡†æ¶åˆ†æ For referenceğŸ‘‡ï¼š
ğŸ“º B ç«™è§†é¢‘ï¼š GAMES202-é«˜è´¨é‡å®æ—¶æ¸²æŸ“ ğŸ“¦ ä»£ç ä»“åº“ï¼š congyuxiaoyoudao/GAMES202_Homework at working master åˆ†æ”¯ä¸Šæ˜¯ 202 å…¨éƒ¨ä½œä¸šæ±‡æ€»ï¼Œworking åˆ†æ”¯ç”¨äºæäº¤ä»£ç ã€‚éœ€è¦åŸå§‹ä½œä¸šå¯ä¸‹è½½ master åˆ†æ”¯çš„åŒ…
0x01 Shadow Map å®Œæˆä¸¤ä¸ªä»»åŠ¡ç‚¹ï¼š
ç¬¬ä¸€ä¸ª Pass ä»¥å…‰æºä½œä¸ºç›¸æœºæ¸²æŸ“ä¸€å¼  ShadowMapï¼Œéœ€è¦ä¸º Shader ä¼ é€’æ­£ç¡®çš„ uLightMVP çŸ©é˜µï¼› ç¬¬äºŒä¸ª Pass è·å–å…‰æºä¼ é€’çš„ç»Ÿä¸€å˜é‡ FBO ï¼ˆShadowMapï¼‰ï¼Œéœ€è¦æ¯”è¾ƒå½“å‰ ShadingPoint çš„æ·±åº¦å€¼ä¸ ShadowMap ä¸Šè®°å½•çš„æ·±åº¦å€¼ï¼Œå¾—å‡ºå¯è§æ€§é¡¹ä¸ Shading ç»“æœç›¸ä¹˜ã€‚ DirectionalLight.js ä¸­ï¼Œå®Œå–„ CalcLightMVP å‡½æ•°ï¼š
1	// Model transform 2 mat4.translate(modelMatrix, modelMatrix, translate); 3 mat4.scale(modelMatrix, modelMatrix, scale); 4 5 // View transform 6 mat4.lookAt(viewMatrix, this.lightPos, this.focalPoint, this.lightUp); 7 8 // Projection transform 9 var r = 100; 10 var l = -r; 11 var t = 100; 12 var b = -t; 13 var n = 0.01; 14 // caution! Depth of far plane should be a bit more larger 15 var f = 400; 16 17 mat4.ortho(projectionMatrix, l, r, b, t, n, f); è¿œå¹³é¢éœ€è®¾ç½®å¾—ç¨å¾®å¤§ä¸€ç‚¹ï¼Œé¿å…å…‰æºçš„è§†é”¥èŒƒå›´æ— æ³•è¦†ç›–å…¨éƒ¨åœºæ™¯"><meta property="og:locale" content="zh"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2025-04-14T00:00:00+00:00"><meta property="article:modified_time" content="2025-04-14T00:00:00+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content><meta name=twitter:description content="
ä¸è¦å¿˜è®°æ”¹å›¾åºŠä¸Šä¼ åœ°å€ï¼
Assignmentç³»åˆ—ï¼šAssignments/Assignment 4.GAMES202HW1/









  Assignment 2. A Review of Realistic Water Waveform Simulation



ğŸš© 0x00 To begin with
è¿™ç¯‡æ–‡ç« å°†ä¼šåŒ…å«ä»¥ä¸‹å†…å®¹ï¼š

 GAMES202 ä½œä¸š 1
 ä¸åŒ…å«ä½œä¸šæ¡†æ¶åˆ†æ

For referenceğŸ‘‡ï¼š

ğŸ“º B ç«™è§†é¢‘ï¼š








  GAMES202-é«˜è´¨é‡å®æ—¶æ¸²æŸ“


ğŸ“¦ ä»£ç ä»“åº“ï¼š








  congyuxiaoyoudao/GAMES202_Homework at working




master åˆ†æ”¯ä¸Šæ˜¯ 202 å…¨éƒ¨ä½œä¸šæ±‡æ€»ï¼Œworking åˆ†æ”¯ç”¨äºæäº¤ä»£ç ã€‚éœ€è¦åŸå§‹ä½œä¸šå¯ä¸‹è½½ master åˆ†æ”¯çš„åŒ…

0x01 Shadow Map
å®Œæˆä¸¤ä¸ªä»»åŠ¡ç‚¹ï¼š

ç¬¬ä¸€ä¸ª Pass ä»¥å…‰æºä½œä¸ºç›¸æœºæ¸²æŸ“ä¸€å¼  ShadowMapï¼Œéœ€è¦ä¸º Shader ä¼ é€’æ­£ç¡®çš„ uLightMVP çŸ©é˜µï¼›
ç¬¬äºŒä¸ª Pass è·å–å…‰æºä¼ é€’çš„ç»Ÿä¸€å˜é‡ FBO ï¼ˆShadowMapï¼‰ï¼Œéœ€è¦æ¯”è¾ƒå½“å‰ ShadingPoint çš„æ·±åº¦å€¼ä¸ ShadowMap ä¸Šè®°å½•çš„æ·±åº¦å€¼ï¼Œå¾—å‡ºå¯è§æ€§é¡¹ä¸ Shading ç»“æœç›¸ä¹˜ã€‚

DirectionalLight.js ä¸­ï¼Œå®Œå–„ CalcLightMVP å‡½æ•°ï¼š

 1		// Model transform
 2        mat4.translate(modelMatrix, modelMatrix, translate);
 3        mat4.scale(modelMatrix, modelMatrix, scale);
 4
 5        // View transform
 6        mat4.lookAt(viewMatrix, this.lightPos, this.focalPoint, this.lightUp);
 7
 8        // Projection transform
 9        var r = 100;
10        var l = -r;
11        var t = 100;
12        var b = -t;
13        var n = 0.01;
14        // caution! Depth of far plane should be a bit more larger
15        var f = 400;
16        
17        mat4.ortho(projectionMatrix, l, r, b, t, n, f);

è¿œå¹³é¢éœ€è®¾ç½®å¾—ç¨å¾®å¤§ä¸€ç‚¹ï¼Œé¿å…å…‰æºçš„è§†é”¥èŒƒå›´æ— æ³•è¦†ç›–å…¨éƒ¨åœºæ™¯"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://congyuxiaoyoudao.github.io/posts/"},{"@type":"ListItem","position":2,"name":"Assignments","item":"https://congyuxiaoyoudao.github.io/posts/assignments/"},{"@type":"ListItem","position":3,"name":"","item":"https://congyuxiaoyoudao.github.io/posts/assignments/assignment-4.-games202-homework-1/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"","name":"","description":" ä¸è¦å¿˜è®°æ”¹å›¾åºŠä¸Šä¼ åœ°å€ï¼ Assignmentç³»åˆ—ï¼šAssignments/Assignment 4.GAMES202HW1/ Assignment 2. A Review of Realistic Water Waveform Simulation ğŸš© 0x00 To begin with è¿™ç¯‡æ–‡ç« å°†ä¼šåŒ…å«ä»¥ä¸‹å†…å®¹ï¼š\nGAMES202 ä½œä¸š 1 ä¸åŒ…å«ä½œä¸šæ¡†æ¶åˆ†æ For referenceğŸ‘‡ï¼š\nğŸ“º B ç«™è§†é¢‘ï¼š GAMES202-é«˜è´¨é‡å®æ—¶æ¸²æŸ“ ğŸ“¦ ä»£ç ä»“åº“ï¼š congyuxiaoyoudao/GAMES202_Homework at working master åˆ†æ”¯ä¸Šæ˜¯ 202 å…¨éƒ¨ä½œä¸šæ±‡æ€»ï¼Œworking åˆ†æ”¯ç”¨äºæäº¤ä»£ç ã€‚éœ€è¦åŸå§‹ä½œä¸šå¯ä¸‹è½½ master åˆ†æ”¯çš„åŒ…\n0x01 Shadow Map å®Œæˆä¸¤ä¸ªä»»åŠ¡ç‚¹ï¼š\nç¬¬ä¸€ä¸ª Pass ä»¥å…‰æºä½œä¸ºç›¸æœºæ¸²æŸ“ä¸€å¼  ShadowMapï¼Œéœ€è¦ä¸º Shader ä¼ é€’æ­£ç¡®çš„ uLightMVP çŸ©é˜µï¼› ç¬¬äºŒä¸ª Pass è·å–å…‰æºä¼ é€’çš„ç»Ÿä¸€å˜é‡ FBO ï¼ˆShadowMapï¼‰ï¼Œéœ€è¦æ¯”è¾ƒå½“å‰ ShadingPoint çš„æ·±åº¦å€¼ä¸ ShadowMap ä¸Šè®°å½•çš„æ·±åº¦å€¼ï¼Œå¾—å‡ºå¯è§æ€§é¡¹ä¸ Shading ç»“æœç›¸ä¹˜ã€‚ DirectionalLight.js ä¸­ï¼Œå®Œå–„ CalcLightMVP å‡½æ•°ï¼š\n1\t// Model transform 2 mat4.translate(modelMatrix, modelMatrix, translate); 3 mat4.scale(modelMatrix, modelMatrix, scale); 4 5 // View transform 6 mat4.lookAt(viewMatrix, this.lightPos, this.focalPoint, this.lightUp); 7 8 // Projection transform 9 var r = 100; 10 var l = -r; 11 var t = 100; 12 var b = -t; 13 var n = 0.01; 14 // caution! Depth of far plane should be a bit more larger 15 var f = 400; 16 17 mat4.ortho(projectionMatrix, l, r, b, t, n, f); è¿œå¹³é¢éœ€è®¾ç½®å¾—ç¨å¾®å¤§ä¸€ç‚¹ï¼Œé¿å…å…‰æºçš„è§†é”¥èŒƒå›´æ— æ³•è¦†ç›–å…¨éƒ¨åœºæ™¯\n","keywords":[],"articleBody":" ä¸è¦å¿˜è®°æ”¹å›¾åºŠä¸Šä¼ åœ°å€ï¼ Assignmentç³»åˆ—ï¼šAssignments/Assignment 4.GAMES202HW1/ Assignment 2. A Review of Realistic Water Waveform Simulation ğŸš© 0x00 To begin with è¿™ç¯‡æ–‡ç« å°†ä¼šåŒ…å«ä»¥ä¸‹å†…å®¹ï¼š\nGAMES202 ä½œä¸š 1 ä¸åŒ…å«ä½œä¸šæ¡†æ¶åˆ†æ For referenceğŸ‘‡ï¼š\nğŸ“º B ç«™è§†é¢‘ï¼š GAMES202-é«˜è´¨é‡å®æ—¶æ¸²æŸ“ ğŸ“¦ ä»£ç ä»“åº“ï¼š congyuxiaoyoudao/GAMES202_Homework at working master åˆ†æ”¯ä¸Šæ˜¯ 202 å…¨éƒ¨ä½œä¸šæ±‡æ€»ï¼Œworking åˆ†æ”¯ç”¨äºæäº¤ä»£ç ã€‚éœ€è¦åŸå§‹ä½œä¸šå¯ä¸‹è½½ master åˆ†æ”¯çš„åŒ…\n0x01 Shadow Map å®Œæˆä¸¤ä¸ªä»»åŠ¡ç‚¹ï¼š\nç¬¬ä¸€ä¸ª Pass ä»¥å…‰æºä½œä¸ºç›¸æœºæ¸²æŸ“ä¸€å¼  ShadowMapï¼Œéœ€è¦ä¸º Shader ä¼ é€’æ­£ç¡®çš„ uLightMVP çŸ©é˜µï¼› ç¬¬äºŒä¸ª Pass è·å–å…‰æºä¼ é€’çš„ç»Ÿä¸€å˜é‡ FBO ï¼ˆShadowMapï¼‰ï¼Œéœ€è¦æ¯”è¾ƒå½“å‰ ShadingPoint çš„æ·±åº¦å€¼ä¸ ShadowMap ä¸Šè®°å½•çš„æ·±åº¦å€¼ï¼Œå¾—å‡ºå¯è§æ€§é¡¹ä¸ Shading ç»“æœç›¸ä¹˜ã€‚ DirectionalLight.js ä¸­ï¼Œå®Œå–„ CalcLightMVP å‡½æ•°ï¼š\n1\t// Model transform 2 mat4.translate(modelMatrix, modelMatrix, translate); 3 mat4.scale(modelMatrix, modelMatrix, scale); 4 5 // View transform 6 mat4.lookAt(viewMatrix, this.lightPos, this.focalPoint, this.lightUp); 7 8 // Projection transform 9 var r = 100; 10 var l = -r; 11 var t = 100; 12 var b = -t; 13 var n = 0.01; 14 // caution! Depth of far plane should be a bit more larger 15 var f = 400; 16 17 mat4.ortho(projectionMatrix, l, r, b, t, n, f); è¿œå¹³é¢éœ€è®¾ç½®å¾—ç¨å¾®å¤§ä¸€ç‚¹ï¼Œé¿å…å…‰æºçš„è§†é”¥èŒƒå›´æ— æ³•è¦†ç›–å…¨éƒ¨åœºæ™¯\nphongFragment.glsl ä¸­ï¼Œç”±äº ShadowMap è®°å½•çš„æ·±åº¦å€¼èŒƒå›´æ˜¯ 0-1ï¼Œæ‰€ä»¥åœ¨æ¯”è¾ƒä¹‹å‰éœ€è¦æŠŠå½“å‰ ShadingPoint åˆ°å…‰æºçš„è·ç¦»è½¬æ¢åˆ°è¯¥åŒºé—´ï¼Œå¯ä»¥é€è§†é™¤æ³•åè½¬æ¢è‡³ NDC åå†æ˜ å°„è‡³è¯¥èŒƒå›´ï¼š\n1Â vec3 shadowCoord = vPositionFromLight.xyz / vPositionFromLight.w; // NDC 2Â shadowCoord.xyz = (shadowCoord.xyz + 1.0) / 2.0; // -1~1 -\u003e 0-1 ç„¶åä½¿ç”¨è¿™ä¸ªåæ ‡ä¼ å…¥ useShadowMap å‡½æ•°è¿›è¡Œæ¯”è¾ƒï¼š\n1float useShadowMap(sampler2D shadowMap, vec4 shadowCoord){ 2 float shadowMapDepth = unpack(texture2D(shadowMap, shadowCoord.xy)); 3 float visibility = shadowCoord.z \u003e (shadowMapDepth + EPS) ? 0.0 : 1.0; 4 return visibility; 5} è¿™é‡Œçš„ EPSï¼ˆEpsilonï¼‰æ˜¯æ¡†æ¶å®šä¹‰çš„ Biasï¼Œä½œä¸ºé˜ˆå€¼åˆ¤æ–­æ˜¯å¦æ˜¾è‘—å¾—å¤§äºè®°å½•çš„æ·±åº¦ï¼Œç”¨äºä¿®æ­£è‡ªé®æŒ¡é—®é¢˜\nç„¶ååœ¨ main å‡½æ•°ä¸­è°ƒç”¨ useShadowMap å’Œ phongColor ç›¸ä¹˜å³å¯ã€‚\n0x02 PCF ç®€å•è¯´ä¸‹ PCF çš„åŸç†ï¼šé’ˆå¯¹å½“å‰ ShadingPointï¼Œä¸ä»…è€ƒå¯Ÿå…¶å¯¹åº”åƒç´ åœ¨ ShadowMap ä¸Šè®°å½•çš„æ·±åº¦ï¼Œè¿˜è¦è€ƒå¯Ÿè¯¥åƒç´ å‘¨å›´ï¼ˆé‚»å±…åƒç´ ï¼‰çš„æ·±åº¦ï¼Œå¹¶é€ä¸€æ¯”è¾ƒå¾—å‡ºå½“å‰ ShadingPoint åœ¨è¿™äº›åƒç´ ä¸Šçš„é®æŒ¡å…³ç³»ï¼Œç„¶åå°†è¿™äº›å€¼æ±‚å¹³å‡ï¼Œå¾—å‡ºä¸€ä¸ªå¹³å‡çš„é®æŒ¡å…³ç³»ï¼ˆä»‹äº 0-1 ä¹‹é—´ï¼‰ã€‚è¦ç‚¹ï¼š\nå¹¶éå¯¹ ShadowMap è¿›è¡Œæ»¤æ³¢ æ›´åƒæ˜¯å¯¹æ·±åº¦æ¯”è¾ƒçš„ç»“æœè¿›è¡Œæ»¤æ³¢ æ¡†æ¶æ¨èåœ¨åœ†ç›˜çŠ¶æ»¤æ³¢æ ¸ä¸­éšæœºé‡‡æ ·ï¼Œå¯ä»¥ç”Ÿæˆæ›´åŠ è‡ªç„¶çš„æ¨¡ç³Šé˜´å½±ï¼Œè¦å®Œæˆçš„ä»»åŠ¡å¦‚ä¸‹ï¼š\nè°ƒç”¨ä»»ä¸€éšæœºé‡‡æ ·å‡½æ•°ï¼Œå¡«å……é‡‡æ ·åç§»æ•°ç»„ï¼ˆpoissonDisk[NUM_SAMPLES]ï¼‰; è€ƒå¯Ÿæ¯ä¸ªåç§»ååƒç´ è®°å½•çš„æ·±åº¦å¹¶ä¸å½“å‰ ShadingsPoint çš„æ·±åº¦è¿›è¡Œæ¯”è¾ƒï¼Œç´¯åŠ å¯è§æ€§é¡¹ï¼› è¿”å›å¹³å‡çš„å¯è§æ€§é¡¹ã€‚ è¿™é‡Œä½¿ç”¨ poissonDiskSamples ç”Ÿæˆéšæœºåç§»ï¼š\nè¿™æ®µä»£ç å°†ä¼šå¡«å……é‡‡æ ·åç§»æ•°ç»„ï¼Œå€¼å½¢å¦‚ï¼š\n$$ \\begin{aligned} possionDisk_{i}=\u0026(\\cos\\theta,\\sin \\theta)\\cdot R \\\\ a_{0}\\leq \\theta\\leq a_{0}\u0026+2\\pi \\cdot rings \\\\ \\frac{1}{samples}^{3/4}\u0026\\leq R\\leq 1 \\end{aligned} $$ åœ¨å¡«å……æ•°ç»„åï¼Œå¾ªç¯é‡‡æ ·æ¯ä¸€ä¸ªåç§»åçš„åƒç´ ï¼Œæ¯”è¾ƒæ·±åº¦ï¼Œç´¯åŠ å¯è§æ€§é¡¹ï¼Œæœ€åæ±‚å…¶å‡å€¼ï¼š\n1// filter size is filter window size in pixels defined by FILTER_RADIUS / resolution 2float PCF(sampler2D shadowMap, vec4 coords, float filterSize) { 3 4 // STEP 1: uniform disk sampling generate a group of random sample points 5 poissonDiskSamples(coords.xy); 6 // Step 2: sample each point and accumulate each visibility component 7 float sum = 0.0; 8 for (int i = 0; i \u003c PCF_NUM_SAMPLES; i++) { 9 vec2 sampleOffset = poissonDisk[i] * filterSize; 10 vec2 uv = coords.xy + sampleOffset; 11 float shadowMapDepth = unpack(texture2D(shadowMap, uv)); 12 float visibility = coords.z \u003e (shadowMapDepth + EPS) ? 0.0 : 1.0; 13 sum += visibility; 14 } 15 // Step 3: return averaged visibility 16 return sum / float(PCF_NUM_SAMPLES); 17} ç”±äºé‡‡æ ·çš„åç§»åœ¨ UV ç©ºé—´ä¸­è¿›è¡Œï¼Œæ‰€ä»¥éœ€è¦é™¤ä»¥è´´å›¾åˆ†è¾¨ç‡ï¼Œæ¡†æ¶ç»™çš„æ˜¯ 2048ï¼Œæ­¤å¤–ï¼Œä¹˜ä¸€ä¸ª FILTER_RADIUS è°ƒæ•´åç§»èŒƒå›´å¤§å°ï¼Œè¯¥å€¼è¶Šå¤§ï¼Œé˜´å½±è¶Šè½¯\nåŒæ ·åœ¨ main å‡½æ•°ä¸­è°ƒç”¨ PCF å’Œ phongColor ç›¸ä¹˜å³å¯ã€‚\n0x03 PCSS è§‚å¯Ÿç°å®çš„é˜´å½±ï¼Œä¼šå‘ç°åœ¨é è¿‘æŠ•å°„é˜´å½±çš„éšœç¢ç‰©æ—¶ï¼Œé˜´å½±ä¼šæ›´åŠ ç¡¬ï¼Œåä¹‹æ›´è½¯ã€‚PCSS åœ¨ PCF çš„åŸºç¡€ä¸Šéœ€è¦æ ¹æ®é®æŒ¡ç‰©çš„è·ç¦»æ”¹å˜æ»¤æ³¢æ ¸çš„å¤§å°ï¼Œä»¥è°ƒèŠ‚é˜´å½±è½¯ç¡¬ï¼Œè¦å®Œæˆçš„ä»»åŠ¡å¦‚ä¸‹ï¼š\nè·å¾—é®æŒ¡ç‰©çš„å¹³å‡æ·±åº¦ï¼Œå®Œå–„ findBlocker å‡½æ•°ï¼› æ ¹æ®ç›¸ä¼¼ä¸‰è§’å½¢åŸç†è®¡ç®—åŠå½±å¤§å°ï¼ˆpenumbra sizeï¼‰ï¼› æ ¹æ®åŠå½±å¤§å°è°ƒæ•´æ»¤æ³¢æ ¸å¤§å°ï¼Œè°ƒç”¨ PCFã€‚ è¯¾ç¨‹è§†é¢‘ç»™å‡ºäº†ä¸€ç§ç¡®å®šå¯èƒ½é®æŒ¡å½“å‰ ShadingPoint çš„èŒƒå›´ï¼Œå³è¿æ¥ ShadingPoint åˆ° Lightï¼Œåœ¨è¿‘å¹³é¢å¤„æ‰€æˆªçš„åŒºåŸŸã€‚\nä¹Ÿæ˜¯ç›¸ä¼¼ä¸‰è§’å½¢ï¼Œç»™å®šå…‰æºå®½åº¦å³å¯è®¡ç®—ï¼š\n$$ blockerSearchRadius=W_{light} \\cdot \\frac{d_{PosToLight}-d_{near}}{d_{PosToLight}} $$ ç„¶åå°†è¿™ä¸ªèŒƒå›´ä¹˜ä¸Šåç§»ï¼Œåœ¨æœ€ç»ˆçš„åç§»èŒƒå›´å†…éšæœºé‡‡æ ·ï¼Œä»…è®°å½•å¹¶ç´¯åŠ ä¸ºé®æŒ¡ç‰©çš„åƒç´ æ·±åº¦ï¼Œæœ€åæ±‚å¾—å¹³å‡é®æŒ¡ç‰©æ·±åº¦ã€‚\n1float findBlocker( sampler2D shadowMap, vec2 uv, float zReceiver ) { 2 float avgBlockerDepth = 0.0; 3 float blockerSum = 0.0; 4 poissonDiskSamples(uv); 5 6 // use proj on near plane to define search radius 7 float blockerSearchRadius = LIGHT_WIDTH_UV * (vPositionFromLight.z - NEAR_PLANE) / vPositionFromLight.z ; 8 9 for (int i = 0; i \u003c BLOCKER_SEARCH_NUM_SAMPLES; i++) { 10 vec2 sampleOffset = poissonDisk[i] * blockerSearchRadius; 11 vec2 uvSample = uv + sampleOffset; 12 float shadowMapDepth = unpack(texture2D(shadowMap, uvSample)); 13 if (shadowMapDepth \u003c zReceiver) { 14 avgBlockerDepth += shadowMapDepth; 15 blockerSum ++; 16 } 17 } 18 19 if(blockerSum == 0.0) return 1.0; // no blocker give a max depth value 20 else return avgBlockerDepth / blockerSum; 21} ä¹‹ååœ¨ PCSS ä¸­è°ƒç”¨ä¹‹ï¼Œå†ä¸€æ¬¡ä½¿ç”¨ç›¸ä¼¼ä¸‰è§’å½¢è·å¾—åŠå½±å¤§å°ï¼Œå°†å…¶ä½œä¸ºæ»¤æ³¢å™¨å¤§å°ä¼ å…¥ PCFã€‚\n1float PCSS(sampler2D shadowMap, vec4 coords){ 2 3 // STEP 1: avgblocker depth 4 float avgBlockerDepth = findBlocker(shadowMap, coords.xy, coords.z); 5 // STEP 2: penumbra size 6 // LIGHT_WIDTH_UV is defined by (LIGHT_WIDTH / resolution) 7 float penumbraSize = (coords.z - avgBlockerDepth) * LIGHT_WIDTH_UV / avgBlockerDepth; 8 // STEP 3: use penumbra size to define filter size 9 float visibility = PCF(shadowMap, coords, penumbraSize); 10 return visibility; 11 12} è¿™é‡Œç›¸ä¼¼ä¸‰è§’å½¢æ±‚è§£æ—¶ç›´æ¥ä½¿ç”¨å±å¹•ç©ºé—´ç¯å®½åº¦ï¼Œå¯ä»¥ç›´æ¥å°†å¾—åˆ°çš„åŠå½±ç›´å¾„ä½œä¸ºæ»¤æ³¢å™¨å¤§å°ä¼ å…¥ PCFï¼Œæ³¨æ„ç»Ÿä¸€çš„é‡çº²\nåŒæ ·åœ¨ main å‡½æ•°ä¸­è°ƒç”¨ PCSS å’Œ phongColor ç›¸ä¹˜å³å¯ã€‚\n0x04 Bonus å¤šå…‰æº è¦å®ç°å¤šå…‰æºï¼Œå°±éœ€è¦ä¸ºæ¯ä¸ªå…‰æºç»˜åˆ¶ä¸€å¼  ShadowMapï¼Œå¸¸è§„çš„æ€è·¯æ˜¯ä¸ºæ¯å¼  ShadowMap ç»‘å®šä¸€ä¸ª uniformï¼Œç„¶å Shader é‡Œä¸€ä¸€æ¯”è¾ƒï¼Œåˆæˆæœ€ç»ˆçš„é˜´å½±ã€‚ä½†æ˜¯è¿™æ ·è¿˜éœ€è¦å‘ Shader ä¼ ä¸åŒçš„å…‰æºçš„ ulightMVP çŸ©é˜µï¼Œéšç€å…‰æºæ•°é‡å¢åŠ ï¼Œå˜é‡ä¼šå¼‚å¸¸åœ°å¤šï¼Œä¸æ˜¯å¾ˆä¼˜é›…ã€‚\nè¿™ç§æ€è·¯è¦å¹²çš„äº‹ï¼š\nä¸ºæ¯ä¸ªå…‰æºæ¸²æŸ“å…¶ç‹¬ç«‹çš„ ShadowMap å°†æ¯ä¸ªå…‰æºçš„ ShadowMap ç»‘åˆ° Material çš„ uniform ä¸­ å°†æ¯ä¸ªå…‰æºçš„ uLightPos å’Œ ulightMVP ä¼ é€’ç»™ Shader åœ¨ Shader ä¸­éå†æ¯å¼  ShadowMapï¼Œç´¯åŠ å¯è§æ€§é¡¹ æœ¬æ¥æ˜¯æƒ³ç”¨è¿™ä¸ªæ€è·¯çš„ï¼Œä½†æ˜¯æ¡†æ¶è¦åŠ¨çš„ä¸œè¥¿å¤ªå¤šäº†ï¼Œé‚æ”¾å¼ƒ\nGPUGems ä¸­ä½¿ç”¨ä¸€å¼  ShadowMap çº¹ç†ï¼š\nChapter 10. Parallel-Split Shadow Maps on Programmable GPUs â€¦we reuse a single shadow-map texture in each rendering pass\nç”Ÿæˆ ShadowMap åé©¬ä¸Šåˆæˆé˜´å½±ï¼Œä¹‹åçš„å…‰æºå°±å¯ä»¥å¤ç”¨è¿™ä¸ª Textureï¼Œç„¶ååªéœ€å°†æ¯ä¸ªå…‰æºçš„è´¡çŒ®ç´¯åŠ å³å¯ã€‚\né‡‡ç”¨èŠ±æ¡‘æ°çš„åšæ³•ï¼Œæ¯ä¸ªå…‰æºéƒ½èµ°ä¸€æ¬¡ Camera Passï¼Œç„¶åæ··åˆã€‚\nå› ä¸ºä¸€ä¸ª material åªèƒ½å­˜ä¸€å¼  ShadowMapï¼Œæ‰€ä»¥ä¸€ä¸ªæè´¨è¦ä¸ºæ¯ä¸ªå…‰æºéƒ½ build ä¸€éï¼Œä¹Ÿæ˜¯èŠ±æ¡‘æ°çš„åšæ³•ï¼Œç”¨ä¸€ä¸ªç´¢å¼•åŒºåˆ† material å¯¹åº”çš„å…‰æºï¼Œå…ˆä»çˆ¶ç±» Material æ”¹èµ·ï¼ŒMaterial.js ä¸­ï¼š\nç„¶åæ˜¯ PhongMaterial.js ä¸­ï¼Œåœ¨æ„é€ å‡½æ•°å’Œ build å‡½æ•°ä¸­å¢åŠ ç¯å…‰ç´¢å¼•ï¼š\nShadowMaterial.js ä¸­ï¼ŒåŒæ ·ï¼š\nloadOBJ.js ä¸­ï¼Œä¸ºæ¯ä¸ªå…‰æº build ä¸€ä¸ªæè´¨ï¼š\nengine.js ä¸­ï¼Œä¸ºäº†æ–¹ä¾¿ä¸€ç‚¹å°è£…ä¸€ä¸ªåŠ æ–¹å‘å…‰çš„å‡½æ•°ï¼š\n1function AddDirectionalLight(renderer, intensity, color, position, focalPoint, up, hasShadowMap) { 2 const directionLight = new DirectionalLight(intensity, color, position, focalPoint, up, hasShadowMap, renderer.gl); 3 renderer.addLight(directionLight); 4} ç„¶åæ”¹ä¸€ä¸‹ä½ç½®å’Œé¢œè‰²ï¼Œå†æ¬¡å¢åŠ ä¸¤ç›æ–¹å‘å…‰ï¼š\n1AddDirectionalLight(renderer, 5000, [1, 0, 1], lightPos, focalPoint, lightUp, true); 2lightPos = [0, 80, -80]; 3AddDirectionalLight(renderer, 500, [0, 1, 1], lightPos, focalPoint, lightUp, true); 4lightPos = [80, 80, 0]; 5AddDirectionalLight(renderer, 500, [1, 1, 0], lightPos, focalPoint, lightUp, true); æœ€å WebGLRendererä¸­.js ä¸­ï¼Œåªä¸ºå¯¹åº”å…‰æºç´¢å¼•çš„ material è¿›è¡Œç»˜åˆ¶ï¼Œç„¶åæŠŠå…¶ä½™å…‰æºçš„ç»˜åˆ¶ç»“æœå åˆ°ç¬¬ä¸€ä¸ªå…‰æºçš„ç»˜åˆ¶ç»“æœï¼ˆFrameBufferï¼‰ä¸Šï¼š\nè¿™é‡ŒæŒ‰æˆ‘åŸæ¥å†™çš„æŠŠ mesh çš„æ—‹è½¬æ”¾ Camera Pass é‡Œäº†ï¼Œæ‰€ä»¥åŠ äº†å¤šå…‰æºä¼šå‡ºç°å¾ˆä¸¥é‡çš„æŠ–åŠ¨ï¼Œæ‹¿åˆ°å¤–é¢å³å¯\næœ€åå†è®©å…‰æºè½¬èµ·æ¥ï¼š\n1let lightPos = this.lights[l].entity.lightPos; 2lightPos = vec3.rotateY(lightPos, lightPos, this.lights[l].entity.focalPoint, degreeToRadian(10) * deltaTime); 3this.lights[l].entity.lightPos = lightPos; å¤§åŠŸå‘Šæˆï¼Œçœ‹ä¸€ä¸‹ä¸‰ä½“è¿åŠ¨ï¼š\nåŠ¨æ€ç‰©ä½“ ç›®å‰å¯ä»¥çœ‹åˆ°ç‰©ä½“å’Œå…‰æºæ˜¯ä¸æ”¯æŒæ—‹è½¬çš„ï¼Œè¿™é‡ŒåŠ ä¸Šã€‚ä¸åŠ¨è„‘å­ä¸€ç‚¹çš„åŠæ³•æ˜¯å…¨å±€æœç´¢ Transformï¼Œç„¶åä¸€ä¸ªä¸€ä¸ªåŠ ä¸Šæ—‹è½¬å°±è¡Œï¼Œè¿™é‡Œç¬”è€…å°½é‡ç»™å‡ºæœ‰é€»è¾‘çš„ä¿®æ”¹æ–¹å¼ã€‚\næ¡†æ¶ä¸­çš„æ¸²æŸ“å¾ªç¯ä½äº engine.jsï¼Œæœ€åæœ‰ä¸ª setTransform å‡½æ•°ï¼Œåœ¨è¿™é‡ŒåŠ ä¸Šæ—‹è½¬å˜æ¢ï¼š\n1function setTransform(t_x, t_y, t_z, r_x, r_y, r_z, s_x, s_y, s_z) { 2\treturn { 3\tmodelTransX: t_x, 4\tmodelTransY: t_y, 5\tmodelTransZ: t_z, 6\t// Begin TOP changes 7\tmodelRotateX: r_x, 8\tmodelRotateY: r_y, 9\tmodelRotateZ: r_z, 10\t// End TOP changes 11\tmodelScaleX: s_x, 12\tmodelScaleY: s_y, 13\tmodelScaleZ: s_z, 14\t}; 15} ç„¶ååœ¨ä¸Šé¢éƒ¨åˆ†ä»£ç è®¾ç½®æ¨¡å‹å˜æ¢ä¸­åŠ ä¸Šæ—‹è½¬çš„å‚æ•°ï¼Œç›®å‰å…ˆç»™ 0ï¼š\n1let floorTransform = setTransform(0, 0, -30, 0, 0, 0, 4, 4, 4); 2let obj1Transform = setTransform(0, 0, 0, 0, 0, 0, 20, 20, 20); 3let obj2Transform = setTransform(40, 0, -40, 0, 0, 0, 10, 10, 10); è¿™ä¸ªå˜æ¢ä½œä¸º loadOBJ å‡½æ•°çš„å‚æ•°ç”¨äºè®¾ç½®æ¨¡å‹å˜æ¢ï¼Œå…ˆçœ‹çœ‹è¿™ä¸ªå‡½æ•°å¹²äº†ä»€ä¹ˆï¼ˆloadOBJ.jsï¼‰ï¼š\næ¶‰åŠåˆ° transform çš„åœ°æ–¹å°±è¿™äº›ï¼Œä¸€ä¸ªæ˜¯ Mesh çš„ Ctorï¼Œå¦ä¸€ä¸ªæ˜¯ material çš„ build å‡½æ•°ã€‚\nåœ¨ Mesh.js ä¸­ï¼Œæ›´æ”¹å…¶æ„é€ å‡½æ•°ï¼Œå¢åŠ å¯¹æ—‹è½¬çš„æ”¯æŒï¼š\n1// TRSTransform Ctor 2 constructor(translate = [0, 0, 0], rotate = [0, 0, 0], scale = [1, 1, 1]) { 3 this.translate = translate; 4\tthis.rotate = rotate; 5 this.scale = scale; 6 } 7 8// ... 9 10// Mesh Ctor 11\tconst modelTranslation = [transform.modelTransX, transform.modelTransY, transform.modelTransZ]; 12\tconst modelRotation = [transform.modelRotateX, transform.modelRotateY, transform.modelRotateZ]; 13\tconst modelScale = [transform.modelScaleX, transform.modelScaleY, transform.modelScaleZ]; 14\tlet meshTrans = new TRSTransform(modelTranslation, modelRotation, modelScale); å›åˆ° loadOBJ.jsï¼Œä»ä¼ å…¥çš„ transform ä¸­è§£ææ¨¡å‹æ—‹è½¬ï¼Œç„¶åä¼ å…¥ material çš„ build å‡½æ•°ï¼š\n1// object.traverse 2let Translation = [transform.modelTransX, transform.modelTransY, transform.modelTransZ]; 3let Rotation = [transform.modelRotateX, transform.modelRotateY, transform.modelRotateZ]; 4let Scale = [transform.modelScaleX, transform.modelScaleY, transform.modelScaleZ]; 5 6material = buildPhongMaterial(colorMap, mat.specular.toArray(), light, Translation, Rotation, Scale, \"./src/shaders/phongShader/phongVertex.glsl\", \"./src/shaders/phongShader/phongFragment.glsl\"); 7shadowMaterial = buildShadowMaterial(light, Translation, Rotation, Scale, \"./src/shaders/shadowShader/shadowVertex.glsl\", \"./src/shaders/shadowShader/shadowFragment.glsl\"); ç„¶åè‡ªç„¶éœ€è¦å¯¹ material çš„å˜æ¢è¿›è¡Œæ”¯æŒï¼Œä¾æ¬¡åœ¨ PhongMaterial.js å’Œ ShadowMaterial.js ä¸­ä¸ºä¸Šè¿°åˆ›å»ºæè´¨çš„å‡½æ•°æ·»åŠ å¯¹æ—‹è½¬çš„æ”¯æŒï¼š\nPhongMaterial.js ä¸­ï¼š\n1// PhongMaterial Ctor 2 constructor(color, specular, light, translate, rotate, scale, vertexShader, fragmentShader) { 3 let lightMVP = light.CalcLightMVP(translate, rotate, scale); 4 5// material builder function 6async function buildPhongMaterial(color, specular, light, translate, rotate, scale, vertexPath, fragmentPath) { 7 8 let vertexShader = await getShaderString(vertexPath); 9 let fragmentShader = await getShaderString(fragmentPath); 10 return new PhongMaterial(color, specular, light, translate, rotate, scale, vertexShader, fragmentShader); 11} åŒæ ·ï¼ŒShadowMaterial.js ä¸­ï¼š\n1class ShadowMaterial extends Material { 2 constructor(light, translate, rotate, scale, vertexShader, fragmentShader) { 3 let lightMVP = light.CalcLightMVP(translate, rotate, scale); 4 super({ 5 'uLightMVP': { type: 'matrix4fv', value: lightMVP } 6 }, [], vertexShader, fragmentShader, light.fbo); 7 } 8} 9 10async function buildShadowMaterial(light, translate, rotate, scale, vertexPath, fragmentPath) { 11 let vertexShader = await getShaderString(vertexPath); 12 let fragmentShader = await getShaderString(fragmentPath); 13 return new ShadowMaterial(light, translate,rotate, scale, vertexShader, fragmentShader); 14} æ³¨æ„åˆ°ï¼Œä¸Šé¢ä¼ é€’çš„ lightMVP çŸ©é˜µæ˜¯é€šè¿‡ CalcLightMVP è®¡ç®—çš„ï¼Œæ‰€ä»¥ä¸‹ä¸€æ­¥ä¸ºå…¶å¢åŠ å¯¹æ—‹è½¬çš„æ”¯æŒï¼ŒDirectionalLight.js ä¸­ï¼š\n1 CalcLightMVP(translate, rotate, scale) { 2 let lightMVP = mat4.create(); 3 let modelMatrix = mat4.create(); 4 let viewMatrix = mat4.create(); 5 let projectionMatrix = mat4.create(); 6 7 // Model transform 8 mat4.translate(modelMatrix, modelMatrix, translate); 9 mat4.rotateX(modelMatrix, modelMatrix, rotate[0]); 10 mat4.rotateY(modelMatrix, modelMatrix, rotate[1]); 11 mat4.rotateZ(modelMatrix, modelMatrix, rotate[2]); 12 mat4.scale(modelMatrix, modelMatrix, scale); è®°å¾—æŠŠä¸Šé¢ç¯çš„ Meshï¼ˆcubeï¼‰æ¨¡å‹å˜æ¢çš„æ—‹è½¬å‚æ•°åŠ ä¸Š\n1// DirectionalLight Ctor 2this.mesh = Mesh.cube(setTransform(0, 0, 0, 0, 0, 0, 0.2, 0.2, 0.2, 0)); æœ€åï¼Œæ¸²æŸ“å¾ªç¯æ¯ä¸€å¸§ç»˜åˆ¶æ—¶ä¼šè°ƒç”¨ WebGLRenderer çš„ render å‡½æ•°ï¼Œåè€…åˆä¼šä¸ºæ¯ä¸€ä¸ªå®ä½“è°ƒç”¨å…¶ meshRender çš„ draw å‡½æ•°ï¼Œè¯¥å‡½æ•°éœ€è¦è°ƒç”¨ bindCameraParametersï¼Œè¿™é‡Œå‘ Shader ä¼ é€’äº†ä½œä¸º uniform çš„æ¨¡å‹å˜æ¢çŸ©é˜µï¼Œåœ¨è¿™é‡ŒåŠ ä¸Šæ—‹è½¬ï¼ˆMeshRender.js ä¸­ï¼‰ï¼š\n1mat4.rotateX(modelMatrix, modelMatrix, this.mesh.transform.rotate[0]); 2mat4.rotateY(modelMatrix, modelMatrix, this.mesh.transform.rotate[1]); 3mat4.rotateZ(modelMatrix, modelMatrix, this.mesh.transform.rotate[2]); å¯¹æ—‹è½¬çš„æ”¯æŒåˆ°è¿™é‡Œå°±å·®ä¸å¤šäº†ï¼Œç°åœ¨æˆ‘ä»¬éœ€è¦è®©æ¨¡å‹éšç€æ—¶é—´æŒ‰ Y è½´æ—‹è½¬ï¼Œæˆ‘ä»¬å¯ä»¥ä»å¾ªç¯é‡Œæ‹¿åˆ°å½“å‰æ—¶é—´ï¼Œç„¶åä¸ä¿å­˜çš„æ—¶é—´ç›¸å‡å¾—åˆ°å·®å€¼ï¼Œå‘ render å‡½æ•°ä¼ å…¥è¿™ä¸ªå·®å€¼ç„¶åæ¯å¸§ç´¯åŠ ä¸€ä¸ªæ—‹è½¬è§’åº¦å³å¯ã€‚\næœ€åï¼Œåœ¨ WebGLRenderer.jsï¼Œrender å‡½æ•°ä¸­æ¯å¸§éœ€è¦æ›´æ–°å…‰æºå¯¹åº”çš„ FBOï¼ˆå¸§ç¼“å†²åŒºï¼‰ï¼Œå¦åˆ™ ShadowMap çš„å†…å®¹ä¼šæ¯å¸§å åŠ ï¼Œä»¥åŠæ›´æ–°ä¼ å…¥ Shader çš„ uniform å˜é‡ã€‚\nè¿™é‡Œ updateMVP æ˜¯æˆ‘è‡ªå®šä¹‰çš„ä¸€ä¸ªå‡½æ•°ï¼š\n1 updateMVP(mesh, lightEntity){ 2 let translate = mesh.transform.translate; 3 let rotate = mesh.transform.rotate; 4 let scale = mesh.transform.scale; 5 let MVP = lightEntity.CalcLightMVP(translate, rotate, scale); 6 return MVP; 7 } å®Œæˆä¹‹åå°±å¯ä»¥è½¬åœˆåœˆ~\n","wordCount":"1316","inLanguage":"zh","datePublished":"2025-04-14T00:00:00Z","dateModified":"2025-04-14T00:00:00Z","author":{"@type":"Person","name":"The Only Problem"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://congyuxiaoyoudao.github.io/posts/assignments/assignment-4.-games202-homework-1/"},"publisher":{"@type":"Organization","name":"The Only Problem's Blog","logo":{"@type":"ImageObject","url":"https://congyuxiaoyoudao.github.io/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://congyuxiaoyoudao.github.io/ accesskey=h title="The Only Problem's Blog (Alt + H)">The Only Problem's Blog</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)" aria-label="Toggle theme">
<svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
<svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://congyuxiaoyoudao.github.io/archives/ title=Archive><span>Archive</span></a></li><li><a href=https://congyuxiaoyoudao.github.io/search/ title="Search (Alt + /)" accesskey=/><span>Search</span></a></li><li><a href=https://congyuxiaoyoudao.github.io/tags/ title=Tags><span>Tags</span></a></li><li><a href=https://congyuxiaoyoudao.github.io/about/ title=About><span>About</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://congyuxiaoyoudao.github.io/>ä¸»é¡µ</a>&nbsp;Â»&nbsp;<a href=https://congyuxiaoyoudao.github.io/posts/>Posts</a>&nbsp;Â»&nbsp;<a href=https://congyuxiaoyoudao.github.io/posts/assignments/>Assignments</a></div><h1 class="post-title entry-hint-parent"></h1><div class=post-meta><span title='2025-04-14 00:00:00 +0000 UTC'>å››æœˆ 14, 2025</span>&nbsp;Â·&nbsp;7 åˆ†é’Ÿ&nbsp;Â·&nbsp;The Only Problem</div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>ç›®å½•</span></summary><div class=inner><ul><li><a href=#-0x00-to-begin-with aria-label="ğŸš© 0x00 To begin with">ğŸš© 0x00 To begin with</a></li><li><a href=#0x01-shadow-map aria-label="0x01 Shadow Map">0x01 Shadow Map</a></li><li><a href=#0x02-pcf aria-label="0x02 PCF">0x02 PCF</a></li><li><a href=#0x03-pcss aria-label="0x03 PCSS">0x03 PCSS</a></li><li><a href=#0x04-bonus aria-label="0x04 Bonus">0x04 Bonus</a><ul><li><a href=#%e5%a4%9a%e5%85%89%e6%ba%90 aria-label=å¤šå…‰æº>å¤šå…‰æº</a></li><li><a href=#%e5%8a%a8%e6%80%81%e7%89%a9%e4%bd%93 aria-label=åŠ¨æ€ç‰©ä½“>åŠ¨æ€ç‰©ä½“</a></li></ul></li></ul></div></details></div><div class=post-content><blockquote><p>ä¸è¦å¿˜è®°æ”¹å›¾åºŠä¸Šä¼ åœ°å€ï¼
Assignmentç³»åˆ—ï¼šAssignments/Assignment 4.GAMES202HW1/
<a href=./Assignment%202.%20A%20Review%20of%20Realistic%20Water%20Waveform%20Simulation.md>Assignment 2. A Review of Realistic Water Waveform Simulation</a></p></blockquote><hr><h2 id=-0x00-to-begin-with>ğŸš© 0x00 To begin with<a hidden class=anchor aria-hidden=true href=#-0x00-to-begin-with>#</a></h2><p>è¿™ç¯‡æ–‡ç« å°†ä¼šåŒ…å«ä»¥ä¸‹å†…å®¹ï¼š</p><ul><li><input checked disabled type=checkbox> GAMES202 ä½œä¸š 1</li><li><input checked disabled type=checkbox> <strong>ä¸</strong>åŒ…å«ä½œä¸šæ¡†æ¶åˆ†æ</li></ul><p><strong>For reference</strong>ğŸ‘‡ï¼š</p><ul><li>ğŸ“º B ç«™è§†é¢‘ï¼š
<a href="https://www.bilibili.com/video/BV1YK4y1T7yY/?spm_id_from=333.337.top_right_bar_window_custom_collection.content.click&amp;vd_source=b6584cebba3a7a1a34d2f60d63bdc868">GAMES202-é«˜è´¨é‡å®æ—¶æ¸²æŸ“</a></li><li>ğŸ“¦ ä»£ç ä»“åº“ï¼š
<a href=https://github.com/congyuxiaoyoudao/GAMES202_Homework/tree/working>congyuxiaoyoudao/GAMES202_Homework at working</a></li></ul><blockquote><p>master åˆ†æ”¯ä¸Šæ˜¯ 202 å…¨éƒ¨ä½œä¸šæ±‡æ€»ï¼Œworking åˆ†æ”¯ç”¨äºæäº¤ä»£ç ã€‚éœ€è¦åŸå§‹ä½œä¸šå¯ä¸‹è½½ master åˆ†æ”¯çš„åŒ…</p></blockquote><hr><h2 id=0x01-shadow-map>0x01 Shadow Map<a hidden class=anchor aria-hidden=true href=#0x01-shadow-map>#</a></h2><p>å®Œæˆä¸¤ä¸ªä»»åŠ¡ç‚¹ï¼š</p><ol><li>ç¬¬ä¸€ä¸ª Pass ä»¥å…‰æºä½œä¸ºç›¸æœºæ¸²æŸ“ä¸€å¼  ShadowMapï¼Œéœ€è¦ä¸º Shader ä¼ é€’æ­£ç¡®çš„ <code>uLightMVP</code> çŸ©é˜µï¼›</li><li>ç¬¬äºŒä¸ª Pass è·å–å…‰æºä¼ é€’çš„ç»Ÿä¸€å˜é‡ FBO ï¼ˆShadowMapï¼‰ï¼Œéœ€è¦æ¯”è¾ƒå½“å‰ ShadingPoint çš„æ·±åº¦å€¼ä¸ ShadowMap ä¸Šè®°å½•çš„æ·±åº¦å€¼ï¼Œå¾—å‡ºå¯è§æ€§é¡¹ä¸ Shading ç»“æœç›¸ä¹˜ã€‚</li></ol><p>DirectionalLight.js ä¸­ï¼Œå®Œå–„ <code>CalcLightMVP</code> å‡½æ•°ï¼š</p><p><img loading=lazy src=https://raw.gitmirror.com/congyuxiaoyoudao/Picgo-ImageBed/main/Assignments/Assignment%204.GAMES202HW1/202504151505787.png></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-glsl data-lang=glsl><span class=line><span class=ln> 1</span><span class=cl>		<span class=c1>// Model transform</span>
</span></span><span class=line><span class=ln> 2</span><span class=cl>        <span class=n>mat4</span><span class=p>.</span><span class=n>translate</span><span class=p>(</span><span class=n>modelMatrix</span><span class=p>,</span> <span class=n>modelMatrix</span><span class=p>,</span> <span class=n>translate</span><span class=p>);</span>
</span></span><span class=line><span class=ln> 3</span><span class=cl>        <span class=n>mat4</span><span class=p>.</span><span class=n>scale</span><span class=p>(</span><span class=n>modelMatrix</span><span class=p>,</span> <span class=n>modelMatrix</span><span class=p>,</span> <span class=n>scale</span><span class=p>);</span>
</span></span><span class=line><span class=ln> 4</span><span class=cl>
</span></span><span class=line><span class=ln> 5</span><span class=cl>        <span class=c1>// View transform</span>
</span></span><span class=line><span class=ln> 6</span><span class=cl>        <span class=n>mat4</span><span class=p>.</span><span class=n>lookAt</span><span class=p>(</span><span class=n>viewMatrix</span><span class=p>,</span> <span class=k>this</span><span class=p>.</span><span class=n>lightPos</span><span class=p>,</span> <span class=k>this</span><span class=p>.</span><span class=n>focalPoint</span><span class=p>,</span> <span class=k>this</span><span class=p>.</span><span class=n>lightUp</span><span class=p>);</span>
</span></span><span class=line><span class=ln> 7</span><span class=cl>
</span></span><span class=line><span class=ln> 8</span><span class=cl>        <span class=c1>// Projection transform</span>
</span></span><span class=line><span class=ln> 9</span><span class=cl>        <span class=n>var</span> <span class=n>r</span> <span class=o>=</span> <span class=mi>100</span><span class=p>;</span>
</span></span><span class=line><span class=ln>10</span><span class=cl>        <span class=n>var</span> <span class=n>l</span> <span class=o>=</span> <span class=o>-</span><span class=n>r</span><span class=p>;</span>
</span></span><span class=line><span class=ln>11</span><span class=cl>        <span class=n>var</span> <span class=n>t</span> <span class=o>=</span> <span class=mi>100</span><span class=p>;</span>
</span></span><span class=line><span class=ln>12</span><span class=cl>        <span class=n>var</span> <span class=n>b</span> <span class=o>=</span> <span class=o>-</span><span class=n>t</span><span class=p>;</span>
</span></span><span class=line><span class=ln>13</span><span class=cl>        <span class=n>var</span> <span class=n>n</span> <span class=o>=</span> <span class=mf>0.01</span><span class=p>;</span>
</span></span><span class=line><span class=ln>14</span><span class=cl>        <span class=c1>// caution! Depth of far plane should be a bit more larger</span>
</span></span><span class=line><span class=ln>15</span><span class=cl>        <span class=n>var</span> <span class=n>f</span> <span class=o>=</span> <span class=mi>400</span><span class=p>;</span>
</span></span><span class=line><span class=ln>16</span><span class=cl>        
</span></span><span class=line><span class=ln>17</span><span class=cl>        <span class=n>mat4</span><span class=p>.</span><span class=n>ortho</span><span class=p>(</span><span class=n>projectionMatrix</span><span class=p>,</span> <span class=n>l</span><span class=p>,</span> <span class=n>r</span><span class=p>,</span> <span class=n>b</span><span class=p>,</span> <span class=n>t</span><span class=p>,</span> <span class=n>n</span><span class=p>,</span> <span class=n>f</span><span class=p>);</span>
</span></span></code></pre></div><blockquote><p>è¿œå¹³é¢éœ€è®¾ç½®å¾—ç¨å¾®å¤§ä¸€ç‚¹ï¼Œé¿å…å…‰æºçš„è§†é”¥èŒƒå›´æ— æ³•è¦†ç›–å…¨éƒ¨åœºæ™¯</p></blockquote><p>phongFragment.glsl ä¸­ï¼Œç”±äº ShadowMap è®°å½•çš„æ·±åº¦å€¼èŒƒå›´æ˜¯ 0-1ï¼Œæ‰€ä»¥åœ¨æ¯”è¾ƒä¹‹å‰éœ€è¦æŠŠå½“å‰ ShadingPoint åˆ°å…‰æºçš„è·ç¦»è½¬æ¢åˆ°è¯¥åŒºé—´ï¼Œå¯ä»¥é€è§†é™¤æ³•åè½¬æ¢è‡³ NDC åå†æ˜ å°„è‡³è¯¥èŒƒå›´ï¼š</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-glsl data-lang=glsl><span class=line><span class=ln>1</span><span class=cl>Â  <span class=k>vec3</span> <span class=n>shadowCoord</span> <span class=o>=</span> <span class=n>vPositionFromLight</span><span class=p>.</span><span class=n>xyz</span> <span class=o>/</span> <span class=n>vPositionFromLight</span><span class=p>.</span><span class=n>w</span><span class=p>;</span> <span class=c1>// NDC</span>
</span></span><span class=line><span class=ln>2</span><span class=cl>Â  <span class=n>shadowCoord</span><span class=p>.</span><span class=n>xyz</span> <span class=o>=</span> <span class=p>(</span><span class=n>shadowCoord</span><span class=p>.</span><span class=n>xyz</span> <span class=o>+</span> <span class=mf>1.0</span><span class=p>)</span> <span class=o>/</span> <span class=mf>2.0</span><span class=p>;</span> <span class=c1>// -1~1 -&gt; 0-1</span>
</span></span></code></pre></div><p>ç„¶åä½¿ç”¨è¿™ä¸ªåæ ‡ä¼ å…¥ <code>useShadowMap</code> å‡½æ•°è¿›è¡Œæ¯”è¾ƒï¼š</p><p><img loading=lazy src=https://raw.gitmirror.com/congyuxiaoyoudao/Picgo-ImageBed/main/Assignments/Assignment%204.GAMES202HW1/202504151515031.png></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-glsl data-lang=glsl><span class=line><span class=ln>1</span><span class=cl><span class=k>float</span> <span class=n>useShadowMap</span><span class=p>(</span><span class=k>sampler2D</span> <span class=n>shadowMap</span><span class=p>,</span> <span class=k>vec4</span> <span class=n>shadowCoord</span><span class=p>){</span>
</span></span><span class=line><span class=ln>2</span><span class=cl>  <span class=k>float</span> <span class=n>shadowMapDepth</span> <span class=o>=</span> <span class=n>unpack</span><span class=p>(</span><span class=n>texture2D</span><span class=p>(</span><span class=n>shadowMap</span><span class=p>,</span> <span class=n>shadowCoord</span><span class=p>.</span><span class=n>xy</span><span class=p>));</span>
</span></span><span class=line><span class=ln>3</span><span class=cl>  <span class=k>float</span> <span class=n>visibility</span> <span class=o>=</span> <span class=n>shadowCoord</span><span class=p>.</span><span class=n>z</span> <span class=o>&gt;</span> <span class=p>(</span><span class=n>shadowMapDepth</span> <span class=o>+</span> <span class=n>EPS</span><span class=p>)</span> <span class=o>?</span> <span class=mf>0.0</span> <span class=o>:</span> <span class=mf>1.0</span><span class=p>;</span>
</span></span><span class=line><span class=ln>4</span><span class=cl>  <span class=k>return</span> <span class=n>visibility</span><span class=p>;</span>
</span></span><span class=line><span class=ln>5</span><span class=cl><span class=p>}</span>
</span></span></code></pre></div><blockquote><p>è¿™é‡Œçš„ EPSï¼ˆEpsilonï¼‰æ˜¯æ¡†æ¶å®šä¹‰çš„ Biasï¼Œä½œä¸ºé˜ˆå€¼åˆ¤æ–­æ˜¯å¦æ˜¾è‘—å¾—å¤§äºè®°å½•çš„æ·±åº¦ï¼Œç”¨äºä¿®æ­£è‡ªé®æŒ¡é—®é¢˜</p></blockquote><p>ç„¶ååœ¨ <code>main</code> å‡½æ•°ä¸­è°ƒç”¨ <code>useShadowMap</code> å’Œ <code>phongColor</code> ç›¸ä¹˜å³å¯ã€‚</p><p><img alt="ShadowMap ç¡¬é˜´å½±" loading=lazy src=https://raw.gitmirror.com/congyuxiaoyoudao/Picgo-ImageBed/main/Assignments/Assignment%204.GAMES202HW1/202504151522650.png></p><hr><h2 id=0x02-pcf>0x02 PCF<a hidden class=anchor aria-hidden=true href=#0x02-pcf>#</a></h2><p>ç®€å•è¯´ä¸‹ PCF çš„åŸç†ï¼šé’ˆå¯¹å½“å‰ ShadingPointï¼Œä¸ä»…è€ƒå¯Ÿå…¶å¯¹åº”åƒç´ åœ¨ ShadowMap ä¸Šè®°å½•çš„æ·±åº¦ï¼Œè¿˜è¦è€ƒå¯Ÿè¯¥åƒç´ å‘¨å›´ï¼ˆé‚»å±…åƒç´ ï¼‰çš„æ·±åº¦ï¼Œå¹¶é€ä¸€æ¯”è¾ƒå¾—å‡ºå½“å‰ ShadingPoint åœ¨è¿™äº›åƒç´ ä¸Šçš„é®æŒ¡å…³ç³»ï¼Œç„¶åå°†è¿™äº›å€¼æ±‚å¹³å‡ï¼Œå¾—å‡ºä¸€ä¸ªå¹³å‡çš„é®æŒ¡å…³ç³»ï¼ˆä»‹äº 0-1 ä¹‹é—´ï¼‰ã€‚è¦ç‚¹ï¼š</p><ul><li>å¹¶éå¯¹ ShadowMap è¿›è¡Œæ»¤æ³¢</li><li>æ›´åƒæ˜¯å¯¹æ·±åº¦æ¯”è¾ƒçš„ç»“æœè¿›è¡Œæ»¤æ³¢</li></ul><p>æ¡†æ¶æ¨èåœ¨åœ†ç›˜çŠ¶æ»¤æ³¢æ ¸ä¸­éšæœºé‡‡æ ·ï¼Œå¯ä»¥ç”Ÿæˆæ›´åŠ è‡ªç„¶çš„æ¨¡ç³Šé˜´å½±ï¼Œè¦å®Œæˆçš„ä»»åŠ¡å¦‚ä¸‹ï¼š</p><ol><li>è°ƒç”¨ä»»ä¸€éšæœºé‡‡æ ·å‡½æ•°ï¼Œå¡«å……é‡‡æ ·åç§»æ•°ç»„ï¼ˆ<code>poissonDisk[NUM_SAMPLES]</code>ï¼‰;</li><li>è€ƒå¯Ÿæ¯ä¸ªåç§»ååƒç´ è®°å½•çš„æ·±åº¦å¹¶ä¸å½“å‰ ShadingsPoint çš„æ·±åº¦è¿›è¡Œæ¯”è¾ƒï¼Œç´¯åŠ å¯è§æ€§é¡¹ï¼›</li><li>è¿”å›å¹³å‡çš„å¯è§æ€§é¡¹ã€‚</li></ol><p>è¿™é‡Œä½¿ç”¨ <code>poissonDiskSamples</code> ç”Ÿæˆéšæœºåç§»ï¼š</p><p><img loading=lazy src=https://raw.gitmirror.com/congyuxiaoyoudao/Picgo-ImageBed/main/Assignments/Assignment%204.GAMES202HW1/202504151557964.png></p><p>è¿™æ®µä»£ç å°†ä¼šå¡«å……é‡‡æ ·åç§»æ•°ç»„ï¼Œå€¼å½¢å¦‚ï¼š</p><div>$$
\begin{aligned}
possionDisk_{i}=&(\cos\theta,\sin \theta)\cdot R \\
a_{0}\leq \theta\leq a_{0}&+2\pi \cdot rings \\
\frac{1}{samples}^{3/4}&\leq R\leq 1
\end{aligned}
$$</div><p>åœ¨å¡«å……æ•°ç»„åï¼Œå¾ªç¯é‡‡æ ·æ¯ä¸€ä¸ªåç§»åçš„åƒç´ ï¼Œæ¯”è¾ƒæ·±åº¦ï¼Œç´¯åŠ å¯è§æ€§é¡¹ï¼Œæœ€åæ±‚å…¶å‡å€¼ï¼š</p><p><img loading=lazy src=https://raw.gitmirror.com/congyuxiaoyoudao/Picgo-ImageBed/main/Assignments/Assignment%204.GAMES202HW1/202504151618280.png></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-glsl data-lang=glsl><span class=line><span class=ln> 1</span><span class=cl><span class=c1>// filter size is filter window size in pixels defined by FILTER_RADIUS / resolution</span>
</span></span><span class=line><span class=ln> 2</span><span class=cl><span class=k>float</span> <span class=n>PCF</span><span class=p>(</span><span class=k>sampler2D</span> <span class=n>shadowMap</span><span class=p>,</span> <span class=k>vec4</span> <span class=n>coords</span><span class=p>,</span> <span class=k>float</span> <span class=n>filterSize</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=ln> 3</span><span class=cl>
</span></span><span class=line><span class=ln> 4</span><span class=cl>  <span class=c1>// STEP 1: uniform disk sampling generate a group of random sample points</span>
</span></span><span class=line><span class=ln> 5</span><span class=cl>  <span class=n>poissonDiskSamples</span><span class=p>(</span><span class=n>coords</span><span class=p>.</span><span class=n>xy</span><span class=p>);</span>
</span></span><span class=line><span class=ln> 6</span><span class=cl>  <span class=c1>// Step 2: sample each point and accumulate each visibility component</span>
</span></span><span class=line><span class=ln> 7</span><span class=cl>  <span class=k>float</span> <span class=n>sum</span> <span class=o>=</span> <span class=mf>0.0</span><span class=p>;</span>
</span></span><span class=line><span class=ln> 8</span><span class=cl>  <span class=k>for</span> <span class=p>(</span><span class=k>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mo>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>PCF_NUM_SAMPLES</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=ln> 9</span><span class=cl>    <span class=k>vec2</span> <span class=n>sampleOffset</span> <span class=o>=</span> <span class=n>poissonDisk</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>*</span> <span class=n>filterSize</span><span class=p>;</span>
</span></span><span class=line><span class=ln>10</span><span class=cl>    <span class=k>vec2</span> <span class=n>uv</span> <span class=o>=</span> <span class=n>coords</span><span class=p>.</span><span class=n>xy</span> <span class=o>+</span> <span class=n>sampleOffset</span><span class=p>;</span>
</span></span><span class=line><span class=ln>11</span><span class=cl>    <span class=k>float</span> <span class=n>shadowMapDepth</span> <span class=o>=</span> <span class=n>unpack</span><span class=p>(</span><span class=n>texture2D</span><span class=p>(</span><span class=n>shadowMap</span><span class=p>,</span> <span class=n>uv</span><span class=p>));</span>
</span></span><span class=line><span class=ln>12</span><span class=cl>    <span class=k>float</span> <span class=n>visibility</span> <span class=o>=</span> <span class=n>coords</span><span class=p>.</span><span class=n>z</span> <span class=o>&gt;</span> <span class=p>(</span><span class=n>shadowMapDepth</span> <span class=o>+</span> <span class=n>EPS</span><span class=p>)</span> <span class=o>?</span> <span class=mf>0.0</span> <span class=o>:</span> <span class=mf>1.0</span><span class=p>;</span>
</span></span><span class=line><span class=ln>13</span><span class=cl>    <span class=n>sum</span> <span class=o>+=</span> <span class=n>visibility</span><span class=p>;</span>
</span></span><span class=line><span class=ln>14</span><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=ln>15</span><span class=cl>  <span class=c1>// Step 3: return averaged visibility</span>
</span></span><span class=line><span class=ln>16</span><span class=cl>  <span class=k>return</span> <span class=n>sum</span> <span class=o>/</span> <span class=k>float</span><span class=p>(</span><span class=n>PCF_NUM_SAMPLES</span><span class=p>);</span>
</span></span><span class=line><span class=ln>17</span><span class=cl><span class=p>}</span>
</span></span></code></pre></div><blockquote><p>ç”±äºé‡‡æ ·çš„åç§»åœ¨ UV ç©ºé—´ä¸­è¿›è¡Œï¼Œæ‰€ä»¥éœ€è¦é™¤ä»¥è´´å›¾åˆ†è¾¨ç‡ï¼Œæ¡†æ¶ç»™çš„æ˜¯ 2048ï¼Œæ­¤å¤–ï¼Œä¹˜ä¸€ä¸ª <code>FILTER_RADIUS</code> è°ƒæ•´åç§»èŒƒå›´å¤§å°ï¼Œè¯¥å€¼è¶Šå¤§ï¼Œé˜´å½±è¶Šè½¯</p></blockquote><p>åŒæ ·åœ¨ <code>main</code> å‡½æ•°ä¸­è°ƒç”¨ <code>PCF</code> å’Œ <code>phongColor</code> ç›¸ä¹˜å³å¯ã€‚</p><p><img alt=é˜´å½±è½¯è½¯çš„ loading=lazy src=https://raw.gitmirror.com/congyuxiaoyoudao/Picgo-ImageBed/main/Assignments/Assignment%204.GAMES202HW1/202504151624409.png></p><hr><h2 id=0x03-pcss>0x03 PCSS<a hidden class=anchor aria-hidden=true href=#0x03-pcss>#</a></h2><p>è§‚å¯Ÿç°å®çš„é˜´å½±ï¼Œä¼šå‘ç°åœ¨é è¿‘æŠ•å°„é˜´å½±çš„éšœç¢ç‰©æ—¶ï¼Œé˜´å½±ä¼šæ›´åŠ ç¡¬ï¼Œåä¹‹æ›´è½¯ã€‚PCSS åœ¨ PCF çš„åŸºç¡€ä¸Šéœ€è¦æ ¹æ®é®æŒ¡ç‰©çš„è·ç¦»æ”¹å˜æ»¤æ³¢æ ¸çš„å¤§å°ï¼Œä»¥è°ƒèŠ‚é˜´å½±è½¯ç¡¬ï¼Œè¦å®Œæˆçš„ä»»åŠ¡å¦‚ä¸‹ï¼š</p><ol><li>è·å¾—é®æŒ¡ç‰©çš„å¹³å‡æ·±åº¦ï¼Œå®Œå–„ <code>findBlocker</code> å‡½æ•°ï¼›</li><li>æ ¹æ®ç›¸ä¼¼ä¸‰è§’å½¢åŸç†è®¡ç®—åŠå½±å¤§å°ï¼ˆpenumbra sizeï¼‰ï¼›</li><li>æ ¹æ®åŠå½±å¤§å°è°ƒæ•´æ»¤æ³¢æ ¸å¤§å°ï¼Œè°ƒç”¨ PCFã€‚</li></ol><p>è¯¾ç¨‹è§†é¢‘ç»™å‡ºäº†ä¸€ç§ç¡®å®šå¯èƒ½é®æŒ¡å½“å‰ ShadingPoint çš„èŒƒå›´ï¼Œå³è¿æ¥ ShadingPoint åˆ° Lightï¼Œåœ¨è¿‘å¹³é¢å¤„æ‰€æˆªçš„åŒºåŸŸã€‚</p><p><img loading=lazy src=https://raw.gitmirror.com/congyuxiaoyoudao/Picgo-ImageBed/main/Assignments/Assignment%204.GAMES202HW1/202504151640949.png></p><p>ä¹Ÿæ˜¯ç›¸ä¼¼ä¸‰è§’å½¢ï¼Œç»™å®šå…‰æºå®½åº¦å³å¯è®¡ç®—ï¼š</p><div>$$
blockerSearchRadius=W_{light} \cdot \frac{d_{PosToLight}-d_{near}}{d_{PosToLight}}
$$</div><p>ç„¶åå°†è¿™ä¸ªèŒƒå›´ä¹˜ä¸Šåç§»ï¼Œåœ¨æœ€ç»ˆçš„åç§»èŒƒå›´å†…éšæœºé‡‡æ ·ï¼Œä»…è®°å½•å¹¶ç´¯åŠ ä¸ºé®æŒ¡ç‰©çš„åƒç´ æ·±åº¦ï¼Œæœ€åæ±‚å¾—å¹³å‡é®æŒ¡ç‰©æ·±åº¦ã€‚</p><p><img loading=lazy src=https://raw.gitmirror.com/congyuxiaoyoudao/Picgo-ImageBed/main/Assignments/Assignment%204.GAMES202HW1/202504151634249.png></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-glsl data-lang=glsl><span class=line><span class=ln> 1</span><span class=cl><span class=k>float</span> <span class=n>findBlocker</span><span class=p>(</span> <span class=k>sampler2D</span> <span class=n>shadowMap</span><span class=p>,</span>  <span class=k>vec2</span> <span class=n>uv</span><span class=p>,</span> <span class=k>float</span> <span class=n>zReceiver</span> <span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=ln> 2</span><span class=cl>  <span class=k>float</span> <span class=n>avgBlockerDepth</span> <span class=o>=</span> <span class=mf>0.0</span><span class=p>;</span>
</span></span><span class=line><span class=ln> 3</span><span class=cl>  <span class=k>float</span> <span class=n>blockerSum</span> <span class=o>=</span> <span class=mf>0.0</span><span class=p>;</span>
</span></span><span class=line><span class=ln> 4</span><span class=cl>  <span class=n>poissonDiskSamples</span><span class=p>(</span><span class=n>uv</span><span class=p>);</span>
</span></span><span class=line><span class=ln> 5</span><span class=cl>
</span></span><span class=line><span class=ln> 6</span><span class=cl>  <span class=c1>// use proj on near plane to define search radius</span>
</span></span><span class=line><span class=ln> 7</span><span class=cl>  <span class=k>float</span> <span class=n>blockerSearchRadius</span> <span class=o>=</span> <span class=n>LIGHT_WIDTH_UV</span> <span class=o>*</span> <span class=p>(</span><span class=n>vPositionFromLight</span><span class=p>.</span><span class=n>z</span> <span class=o>-</span> <span class=n>NEAR_PLANE</span><span class=p>)</span> <span class=o>/</span> <span class=n>vPositionFromLight</span><span class=p>.</span><span class=n>z</span> <span class=p>;</span>
</span></span><span class=line><span class=ln> 8</span><span class=cl>
</span></span><span class=line><span class=ln> 9</span><span class=cl>  <span class=k>for</span> <span class=p>(</span><span class=k>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mo>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>BLOCKER_SEARCH_NUM_SAMPLES</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>10</span><span class=cl>    <span class=k>vec2</span> <span class=n>sampleOffset</span> <span class=o>=</span> <span class=n>poissonDisk</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>*</span> <span class=n>blockerSearchRadius</span><span class=p>;</span>
</span></span><span class=line><span class=ln>11</span><span class=cl>    <span class=k>vec2</span> <span class=n>uvSample</span> <span class=o>=</span> <span class=n>uv</span> <span class=o>+</span> <span class=n>sampleOffset</span><span class=p>;</span>
</span></span><span class=line><span class=ln>12</span><span class=cl>    <span class=k>float</span> <span class=n>shadowMapDepth</span> <span class=o>=</span> <span class=n>unpack</span><span class=p>(</span><span class=n>texture2D</span><span class=p>(</span><span class=n>shadowMap</span><span class=p>,</span> <span class=n>uvSample</span><span class=p>));</span>
</span></span><span class=line><span class=ln>13</span><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>shadowMapDepth</span> <span class=o>&lt;</span> <span class=n>zReceiver</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>14</span><span class=cl>      <span class=n>avgBlockerDepth</span> <span class=o>+=</span> <span class=n>shadowMapDepth</span><span class=p>;</span>
</span></span><span class=line><span class=ln>15</span><span class=cl>      <span class=n>blockerSum</span> <span class=o>++</span><span class=p>;</span>
</span></span><span class=line><span class=ln>16</span><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=ln>17</span><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=ln>18</span><span class=cl>
</span></span><span class=line><span class=ln>19</span><span class=cl>  <span class=k>if</span><span class=p>(</span><span class=n>blockerSum</span> <span class=o>==</span> <span class=mf>0.0</span><span class=p>)</span> <span class=k>return</span> <span class=mf>1.0</span><span class=p>;</span> <span class=c1>// no blocker give a max depth value</span>
</span></span><span class=line><span class=ln>20</span><span class=cl>  <span class=k>else</span> <span class=k>return</span> <span class=n>avgBlockerDepth</span> <span class=o>/</span> <span class=n>blockerSum</span><span class=p>;</span>
</span></span><span class=line><span class=ln>21</span><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>ä¹‹ååœ¨ PCSS ä¸­è°ƒç”¨ä¹‹ï¼Œå†ä¸€æ¬¡ä½¿ç”¨ç›¸ä¼¼ä¸‰è§’å½¢è·å¾—åŠå½±å¤§å°ï¼Œå°†å…¶ä½œä¸ºæ»¤æ³¢å™¨å¤§å°ä¼ å…¥ PCFã€‚</p><p><img loading=lazy src=https://raw.gitmirror.com/congyuxiaoyoudao/Picgo-ImageBed/main/Assignments/Assignment%204.GAMES202HW1/202504151709181.png></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-glsl data-lang=glsl><span class=line><span class=ln> 1</span><span class=cl><span class=k>float</span> <span class=n>PCSS</span><span class=p>(</span><span class=k>sampler2D</span> <span class=n>shadowMap</span><span class=p>,</span> <span class=k>vec4</span> <span class=n>coords</span><span class=p>){</span>
</span></span><span class=line><span class=ln> 2</span><span class=cl>
</span></span><span class=line><span class=ln> 3</span><span class=cl>  <span class=c1>// STEP 1: avgblocker depth</span>
</span></span><span class=line><span class=ln> 4</span><span class=cl>  <span class=k>float</span> <span class=n>avgBlockerDepth</span> <span class=o>=</span> <span class=n>findBlocker</span><span class=p>(</span><span class=n>shadowMap</span><span class=p>,</span> <span class=n>coords</span><span class=p>.</span><span class=n>xy</span><span class=p>,</span> <span class=n>coords</span><span class=p>.</span><span class=n>z</span><span class=p>);</span>
</span></span><span class=line><span class=ln> 5</span><span class=cl>  <span class=c1>// STEP 2: penumbra size</span>
</span></span><span class=line><span class=ln> 6</span><span class=cl>  <span class=c1>// LIGHT_WIDTH_UV is defined by (LIGHT_WIDTH / resolution)</span>
</span></span><span class=line><span class=ln> 7</span><span class=cl>  <span class=k>float</span> <span class=n>penumbraSize</span> <span class=o>=</span> <span class=p>(</span><span class=n>coords</span><span class=p>.</span><span class=n>z</span> <span class=o>-</span> <span class=n>avgBlockerDepth</span><span class=p>)</span> <span class=o>*</span> <span class=n>LIGHT_WIDTH_UV</span> <span class=o>/</span> <span class=n>avgBlockerDepth</span><span class=p>;</span>
</span></span><span class=line><span class=ln> 8</span><span class=cl>  <span class=c1>// STEP 3: use penumbra size to define filter size</span>
</span></span><span class=line><span class=ln> 9</span><span class=cl>  <span class=k>float</span> <span class=n>visibility</span> <span class=o>=</span> <span class=n>PCF</span><span class=p>(</span><span class=n>shadowMap</span><span class=p>,</span> <span class=n>coords</span><span class=p>,</span> <span class=n>penumbraSize</span><span class=p>);</span>
</span></span><span class=line><span class=ln>10</span><span class=cl>  <span class=k>return</span> <span class=n>visibility</span><span class=p>;</span>
</span></span><span class=line><span class=ln>11</span><span class=cl>
</span></span><span class=line><span class=ln>12</span><span class=cl><span class=p>}</span>
</span></span></code></pre></div><blockquote><p>è¿™é‡Œç›¸ä¼¼ä¸‰è§’å½¢æ±‚è§£æ—¶ç›´æ¥ä½¿ç”¨å±å¹•ç©ºé—´ç¯å®½åº¦ï¼Œå¯ä»¥ç›´æ¥å°†å¾—åˆ°çš„åŠå½±ç›´å¾„ä½œä¸ºæ»¤æ³¢å™¨å¤§å°ä¼ å…¥ <code>PCF</code>ï¼Œæ³¨æ„ç»Ÿä¸€çš„é‡çº²</p></blockquote><p>åŒæ ·åœ¨ <code>main</code> å‡½æ•°ä¸­è°ƒç”¨ <code>PCSS</code> å’Œ <code>phongColor</code> ç›¸ä¹˜å³å¯ã€‚</p><p><img alt=é è¿‘é®æŒ¡ç‰©çš„ç¡¬é˜´å½±å’Œè¿œç¦»é®æŒ¡ç‰©çš„è½¯é˜´å½± loading=lazy src=https://raw.gitmirror.com/congyuxiaoyoudao/Picgo-ImageBed/main/Assignments/Assignment%204.GAMES202HW1/202504151713765.png></p><hr><h2 id=0x04-bonus>0x04 Bonus<a hidden class=anchor aria-hidden=true href=#0x04-bonus>#</a></h2><h3 id=å¤šå…‰æº><strong>å¤šå…‰æº</strong><a hidden class=anchor aria-hidden=true href=#å¤šå…‰æº>#</a></h3><p>è¦å®ç°å¤šå…‰æºï¼Œå°±éœ€è¦ä¸ºæ¯ä¸ªå…‰æºç»˜åˆ¶ä¸€å¼  ShadowMapï¼Œå¸¸è§„çš„æ€è·¯æ˜¯ä¸ºæ¯å¼  ShadowMap ç»‘å®šä¸€ä¸ª <code>uniform</code>ï¼Œç„¶å Shader é‡Œä¸€ä¸€æ¯”è¾ƒï¼Œåˆæˆæœ€ç»ˆçš„é˜´å½±ã€‚ä½†æ˜¯è¿™æ ·è¿˜éœ€è¦å‘ Shader ä¼ ä¸åŒçš„å…‰æºçš„ <code>ulightMVP</code> çŸ©é˜µï¼Œéšç€å…‰æºæ•°é‡å¢åŠ ï¼Œå˜é‡ä¼šå¼‚å¸¸åœ°å¤šï¼Œä¸æ˜¯å¾ˆä¼˜é›…ã€‚</p><p>è¿™ç§æ€è·¯è¦å¹²çš„äº‹ï¼š</p><ul><li>ä¸ºæ¯ä¸ªå…‰æºæ¸²æŸ“å…¶ç‹¬ç«‹çš„ ShadowMap</li><li>å°†æ¯ä¸ªå…‰æºçš„ ShadowMap ç»‘åˆ° Material çš„ <code>uniform</code> ä¸­</li><li>å°†æ¯ä¸ªå…‰æºçš„ <code>uLightPos</code> å’Œ <code>ulightMVP</code> ä¼ é€’ç»™ Shader</li><li>åœ¨ Shader ä¸­éå†æ¯å¼  ShadowMapï¼Œç´¯åŠ å¯è§æ€§é¡¹</li></ul><blockquote><p>æœ¬æ¥æ˜¯æƒ³ç”¨è¿™ä¸ªæ€è·¯çš„ï¼Œä½†æ˜¯æ¡†æ¶è¦åŠ¨çš„ä¸œè¥¿å¤ªå¤šäº†ï¼Œé‚æ”¾å¼ƒ</p></blockquote><p><em>GPUGems</em> ä¸­ä½¿ç”¨ä¸€å¼  ShadowMap çº¹ç†ï¼š</p><p><a href=https://developer.nvidia.com/gpugems/gpugems3/part-ii-light-and-shadows/chapter-10-parallel-split-shadow-maps-programmable-gpus>Chapter 10. Parallel-Split Shadow Maps on Programmable GPUs</a></p><blockquote><p>&mldr;we reuse a single shadow-map texture in each rendering pass</p></blockquote><p>ç”Ÿæˆ ShadowMap åé©¬ä¸Šåˆæˆé˜´å½±ï¼Œä¹‹åçš„å…‰æºå°±å¯ä»¥å¤ç”¨è¿™ä¸ª Textureï¼Œç„¶ååªéœ€å°†æ¯ä¸ªå…‰æºçš„è´¡çŒ®ç´¯åŠ å³å¯ã€‚</p><p>é‡‡ç”¨èŠ±æ¡‘æ°çš„åšæ³•ï¼Œæ¯ä¸ªå…‰æºéƒ½èµ°ä¸€æ¬¡ Camera Passï¼Œç„¶åæ··åˆã€‚</p><p>å› ä¸ºä¸€ä¸ª material åªèƒ½å­˜ä¸€å¼  ShadowMapï¼Œæ‰€ä»¥ä¸€ä¸ªæè´¨è¦ä¸ºæ¯ä¸ªå…‰æºéƒ½ build ä¸€éï¼Œä¹Ÿæ˜¯èŠ±æ¡‘æ°çš„åšæ³•ï¼Œç”¨ä¸€ä¸ªç´¢å¼•åŒºåˆ† material å¯¹åº”çš„å…‰æºï¼Œå…ˆä»çˆ¶ç±» <code>Material</code> æ”¹èµ·ï¼ŒMaterial.js ä¸­ï¼š</p><p><img loading=lazy src=https://raw.gitmirror.com/congyuxiaoyoudao/Picgo-ImageBed/main/Assignments/Assignment%204.GAMES202HW1/202504162302185.png></p><p>ç„¶åæ˜¯ PhongMaterial.js ä¸­ï¼Œåœ¨æ„é€ å‡½æ•°å’Œ build å‡½æ•°ä¸­å¢åŠ ç¯å…‰ç´¢å¼•ï¼š</p><p><img loading=lazy src=https://raw.gitmirror.com/congyuxiaoyoudao/Picgo-ImageBed/main/Assignments/Assignment%204.GAMES202HW1/202504162345660.png></p><p>ShadowMaterial.js ä¸­ï¼ŒåŒæ ·ï¼š</p><p><img loading=lazy src=https://raw.gitmirror.com/congyuxiaoyoudao/Picgo-ImageBed/main/Assignments/Assignment%204.GAMES202HW1/202504162346969.png></p><p>loadOBJ.js ä¸­ï¼Œä¸ºæ¯ä¸ªå…‰æº build ä¸€ä¸ªæè´¨ï¼š</p><p><img loading=lazy src=https://raw.gitmirror.com/congyuxiaoyoudao/Picgo-ImageBed/main/Assignments/Assignment%204.GAMES202HW1/202504162348770.png></p><p>engine.js ä¸­ï¼Œä¸ºäº†æ–¹ä¾¿ä¸€ç‚¹å°è£…ä¸€ä¸ªåŠ æ–¹å‘å…‰çš„å‡½æ•°ï¼š</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=ln>1</span><span class=cl><span class=kd>function</span> <span class=nx>AddDirectionalLight</span><span class=p>(</span><span class=nx>renderer</span><span class=p>,</span> <span class=nx>intensity</span><span class=p>,</span> <span class=nx>color</span><span class=p>,</span> <span class=nx>position</span><span class=p>,</span> <span class=nx>focalPoint</span><span class=p>,</span> <span class=nx>up</span><span class=p>,</span> <span class=nx>hasShadowMap</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>2</span><span class=cl>    <span class=kr>const</span> <span class=nx>directionLight</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>DirectionalLight</span><span class=p>(</span><span class=nx>intensity</span><span class=p>,</span> <span class=nx>color</span><span class=p>,</span> <span class=nx>position</span><span class=p>,</span> <span class=nx>focalPoint</span><span class=p>,</span> <span class=nx>up</span><span class=p>,</span> <span class=nx>hasShadowMap</span><span class=p>,</span> <span class=nx>renderer</span><span class=p>.</span><span class=nx>gl</span><span class=p>);</span>
</span></span><span class=line><span class=ln>3</span><span class=cl>    <span class=nx>renderer</span><span class=p>.</span><span class=nx>addLight</span><span class=p>(</span><span class=nx>directionLight</span><span class=p>);</span>
</span></span><span class=line><span class=ln>4</span><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>ç„¶åæ”¹ä¸€ä¸‹ä½ç½®å’Œé¢œè‰²ï¼Œå†æ¬¡å¢åŠ ä¸¤ç›æ–¹å‘å…‰ï¼š</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=ln>1</span><span class=cl><span class=nx>AddDirectionalLight</span><span class=p>(</span><span class=nx>renderer</span><span class=p>,</span> <span class=mi>5000</span><span class=p>,</span> <span class=p>[</span><span class=mi>1</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>1</span><span class=p>],</span> <span class=nx>lightPos</span><span class=p>,</span> <span class=nx>focalPoint</span><span class=p>,</span> <span class=nx>lightUp</span><span class=p>,</span> <span class=kc>true</span><span class=p>);</span>
</span></span><span class=line><span class=ln>2</span><span class=cl><span class=nx>lightPos</span> <span class=o>=</span> <span class=p>[</span><span class=mi>0</span><span class=p>,</span> <span class=mi>80</span><span class=p>,</span> <span class=o>-</span><span class=mi>80</span><span class=p>];</span>
</span></span><span class=line><span class=ln>3</span><span class=cl><span class=nx>AddDirectionalLight</span><span class=p>(</span><span class=nx>renderer</span><span class=p>,</span> <span class=mi>500</span><span class=p>,</span> <span class=p>[</span><span class=mi>0</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>1</span><span class=p>],</span> <span class=nx>lightPos</span><span class=p>,</span> <span class=nx>focalPoint</span><span class=p>,</span> <span class=nx>lightUp</span><span class=p>,</span> <span class=kc>true</span><span class=p>);</span>
</span></span><span class=line><span class=ln>4</span><span class=cl><span class=nx>lightPos</span> <span class=o>=</span> <span class=p>[</span><span class=mi>80</span><span class=p>,</span> <span class=mi>80</span><span class=p>,</span> <span class=mi>0</span><span class=p>];</span>
</span></span><span class=line><span class=ln>5</span><span class=cl><span class=nx>AddDirectionalLight</span><span class=p>(</span><span class=nx>renderer</span><span class=p>,</span> <span class=mi>500</span><span class=p>,</span> <span class=p>[</span><span class=mi>1</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>0</span><span class=p>],</span> <span class=nx>lightPos</span><span class=p>,</span> <span class=nx>focalPoint</span><span class=p>,</span> <span class=nx>lightUp</span><span class=p>,</span> <span class=kc>true</span><span class=p>);</span>
</span></span></code></pre></div><p>æœ€å WebGLRendererä¸­.js ä¸­ï¼Œåªä¸ºå¯¹åº”å…‰æºç´¢å¼•çš„ material è¿›è¡Œç»˜åˆ¶ï¼Œç„¶åæŠŠå…¶ä½™å…‰æºçš„ç»˜åˆ¶ç»“æœå åˆ°ç¬¬ä¸€ä¸ªå…‰æºçš„ç»˜åˆ¶ç»“æœï¼ˆFrameBufferï¼‰ä¸Šï¼š</p><p><img loading=lazy src=https://raw.gitmirror.com/congyuxiaoyoudao/Picgo-ImageBed/main/Assignments/Assignment%204.GAMES202HW1/202504162354923.png></p><blockquote><p>è¿™é‡ŒæŒ‰æˆ‘åŸæ¥å†™çš„æŠŠ mesh çš„æ—‹è½¬æ”¾ Camera Pass é‡Œäº†ï¼Œæ‰€ä»¥åŠ äº†å¤šå…‰æºä¼šå‡ºç°å¾ˆä¸¥é‡çš„æŠ–åŠ¨ï¼Œæ‹¿åˆ°å¤–é¢å³å¯</p></blockquote><p>æœ€åå†è®©å…‰æºè½¬èµ·æ¥ï¼š</p><p><img loading=lazy src=https://raw.gitmirror.com/congyuxiaoyoudao/Picgo-ImageBed/main/Assignments/Assignment%204.GAMES202HW1/202504162357479.png></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=ln>1</span><span class=cl><span class=kd>let</span> <span class=nx>lightPos</span> <span class=o>=</span> <span class=k>this</span><span class=p>.</span><span class=nx>lights</span><span class=p>[</span><span class=nx>l</span><span class=p>].</span><span class=nx>entity</span><span class=p>.</span><span class=nx>lightPos</span><span class=p>;</span>
</span></span><span class=line><span class=ln>2</span><span class=cl><span class=nx>lightPos</span> <span class=o>=</span> <span class=nx>vec3</span><span class=p>.</span><span class=nx>rotateY</span><span class=p>(</span><span class=nx>lightPos</span><span class=p>,</span> <span class=nx>lightPos</span><span class=p>,</span> <span class=k>this</span><span class=p>.</span><span class=nx>lights</span><span class=p>[</span><span class=nx>l</span><span class=p>].</span><span class=nx>entity</span><span class=p>.</span><span class=nx>focalPoint</span><span class=p>,</span> <span class=nx>degreeToRadian</span><span class=p>(</span><span class=mi>10</span><span class=p>)</span> <span class=o>*</span> <span class=nx>deltaTime</span><span class=p>);</span>
</span></span><span class=line><span class=ln>3</span><span class=cl><span class=k>this</span><span class=p>.</span><span class=nx>lights</span><span class=p>[</span><span class=nx>l</span><span class=p>].</span><span class=nx>entity</span><span class=p>.</span><span class=nx>lightPos</span> <span class=o>=</span> <span class=nx>lightPos</span><span class=p>;</span>
</span></span></code></pre></div><p>å¤§åŠŸå‘Šæˆï¼Œçœ‹ä¸€ä¸‹ä¸‰ä½“è¿åŠ¨ï¼š</p><p><img alt=â€œä¸‰ä½“è¿åŠ¨â€ loading=lazy src=https://raw.gitmirror.com/congyuxiaoyoudao/Picgo-ImageBed/main/Assignments/Assignment%204.GAMES202HW1/202504170002614.gif></p><h3 id=åŠ¨æ€ç‰©ä½“><strong>åŠ¨æ€ç‰©ä½“</strong><a hidden class=anchor aria-hidden=true href=#åŠ¨æ€ç‰©ä½“>#</a></h3><p>ç›®å‰å¯ä»¥çœ‹åˆ°ç‰©ä½“å’Œå…‰æºæ˜¯ä¸æ”¯æŒæ—‹è½¬çš„ï¼Œè¿™é‡ŒåŠ ä¸Šã€‚ä¸åŠ¨è„‘å­ä¸€ç‚¹çš„åŠæ³•æ˜¯å…¨å±€æœç´¢ Transformï¼Œç„¶åä¸€ä¸ªä¸€ä¸ªåŠ ä¸Šæ—‹è½¬å°±è¡Œï¼Œè¿™é‡Œç¬”è€…å°½é‡ç»™å‡ºæœ‰é€»è¾‘çš„ä¿®æ”¹æ–¹å¼ã€‚</p><p>æ¡†æ¶ä¸­çš„æ¸²æŸ“å¾ªç¯ä½äº engine.jsï¼Œæœ€åæœ‰ä¸ª <code>setTransform</code> å‡½æ•°ï¼Œåœ¨è¿™é‡ŒåŠ ä¸Šæ—‹è½¬å˜æ¢ï¼š</p><p><img loading=lazy src=https://raw.gitmirror.com/congyuxiaoyoudao/Picgo-ImageBed/main/Assignments/Assignment%204.GAMES202HW1/202504151944573.png></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=ln> 1</span><span class=cl><span class=kd>function</span> <span class=nx>setTransform</span><span class=p>(</span><span class=nx>t_x</span><span class=p>,</span> <span class=nx>t_y</span><span class=p>,</span> <span class=nx>t_z</span><span class=p>,</span> <span class=nx>r_x</span><span class=p>,</span> <span class=nx>r_y</span><span class=p>,</span> <span class=nx>r_z</span><span class=p>,</span> <span class=nx>s_x</span><span class=p>,</span> <span class=nx>s_y</span><span class=p>,</span> <span class=nx>s_z</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=ln> 2</span><span class=cl>	<span class=k>return</span> <span class=p>{</span>
</span></span><span class=line><span class=ln> 3</span><span class=cl>		<span class=nx>modelTransX</span><span class=o>:</span> <span class=nx>t_x</span><span class=p>,</span>
</span></span><span class=line><span class=ln> 4</span><span class=cl>		<span class=nx>modelTransY</span><span class=o>:</span> <span class=nx>t_y</span><span class=p>,</span>
</span></span><span class=line><span class=ln> 5</span><span class=cl>		<span class=nx>modelTransZ</span><span class=o>:</span> <span class=nx>t_z</span><span class=p>,</span>
</span></span><span class=line><span class=ln> 6</span><span class=cl>		<span class=c1>// Begin TOP changes
</span></span></span><span class=line><span class=ln> 7</span><span class=cl><span class=c1></span>		<span class=nx>modelRotateX</span><span class=o>:</span> <span class=nx>r_x</span><span class=p>,</span>
</span></span><span class=line><span class=ln> 8</span><span class=cl>		<span class=nx>modelRotateY</span><span class=o>:</span> <span class=nx>r_y</span><span class=p>,</span>
</span></span><span class=line><span class=ln> 9</span><span class=cl>		<span class=nx>modelRotateZ</span><span class=o>:</span> <span class=nx>r_z</span><span class=p>,</span>
</span></span><span class=line><span class=ln>10</span><span class=cl>		<span class=c1>// End TOP changes
</span></span></span><span class=line><span class=ln>11</span><span class=cl><span class=c1></span>		<span class=nx>modelScaleX</span><span class=o>:</span> <span class=nx>s_x</span><span class=p>,</span>
</span></span><span class=line><span class=ln>12</span><span class=cl>		<span class=nx>modelScaleY</span><span class=o>:</span> <span class=nx>s_y</span><span class=p>,</span>
</span></span><span class=line><span class=ln>13</span><span class=cl>		<span class=nx>modelScaleZ</span><span class=o>:</span> <span class=nx>s_z</span><span class=p>,</span>
</span></span><span class=line><span class=ln>14</span><span class=cl>	<span class=p>};</span>
</span></span><span class=line><span class=ln>15</span><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>ç„¶ååœ¨ä¸Šé¢éƒ¨åˆ†ä»£ç è®¾ç½®æ¨¡å‹å˜æ¢ä¸­åŠ ä¸Šæ—‹è½¬çš„å‚æ•°ï¼Œç›®å‰å…ˆç»™ 0ï¼š</p><p><img loading=lazy src=https://raw.gitmirror.com/congyuxiaoyoudao/Picgo-ImageBed/main/Assignments/Assignment%204.GAMES202HW1/202504151948322.png></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=ln>1</span><span class=cl><span class=kd>let</span> <span class=nx>floorTransform</span> <span class=o>=</span> <span class=nx>setTransform</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=o>-</span><span class=mi>30</span><span class=p>,</span>   <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span>   <span class=mi>4</span><span class=p>,</span> <span class=mi>4</span><span class=p>,</span> <span class=mi>4</span><span class=p>);</span>
</span></span><span class=line><span class=ln>2</span><span class=cl><span class=kd>let</span> <span class=nx>obj1Transform</span>  <span class=o>=</span> <span class=nx>setTransform</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span>     <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span>   <span class=mi>20</span><span class=p>,</span> <span class=mi>20</span><span class=p>,</span> <span class=mi>20</span><span class=p>);</span>
</span></span><span class=line><span class=ln>3</span><span class=cl><span class=kd>let</span> <span class=nx>obj2Transform</span>  <span class=o>=</span> <span class=nx>setTransform</span><span class=p>(</span><span class=mi>40</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=o>-</span><span class=mi>40</span><span class=p>,</span>  <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span>   <span class=mi>10</span><span class=p>,</span> <span class=mi>10</span><span class=p>,</span> <span class=mi>10</span><span class=p>);</span>
</span></span></code></pre></div><p>è¿™ä¸ªå˜æ¢ä½œä¸º <code>loadOBJ</code> å‡½æ•°çš„å‚æ•°ç”¨äºè®¾ç½®æ¨¡å‹å˜æ¢ï¼Œå…ˆçœ‹çœ‹è¿™ä¸ªå‡½æ•°å¹²äº†ä»€ä¹ˆï¼ˆloadOBJ.jsï¼‰ï¼š</p><p><img loading=lazy src=https://raw.gitmirror.com/congyuxiaoyoudao/Picgo-ImageBed/main/Assignments/Assignment%204.GAMES202HW1/202504151955859.png></p><p>æ¶‰åŠåˆ° transform çš„åœ°æ–¹å°±è¿™äº›ï¼Œä¸€ä¸ªæ˜¯ <code>Mesh</code> çš„ Ctorï¼Œå¦ä¸€ä¸ªæ˜¯ material çš„ build å‡½æ•°ã€‚</p><p>åœ¨ Mesh.js ä¸­ï¼Œæ›´æ”¹å…¶æ„é€ å‡½æ•°ï¼Œå¢åŠ å¯¹æ—‹è½¬çš„æ”¯æŒï¼š</p><p><img loading=lazy src=https://raw.gitmirror.com/congyuxiaoyoudao/Picgo-ImageBed/main/Assignments/Assignment%204.GAMES202HW1/202504152001811.png></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=ln> 1</span><span class=cl><span class=c1>// TRSTransform Ctor
</span></span></span><span class=line><span class=ln> 2</span><span class=cl><span class=c1></span>    <span class=nx>constructor</span><span class=p>(</span><span class=nx>translate</span> <span class=o>=</span> <span class=p>[</span><span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>],</span> <span class=nx>rotate</span> <span class=o>=</span> <span class=p>[</span><span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>],</span> <span class=nx>scale</span> <span class=o>=</span> <span class=p>[</span><span class=mi>1</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>1</span><span class=p>])</span> <span class=p>{</span>
</span></span><span class=line><span class=ln> 3</span><span class=cl>        <span class=k>this</span><span class=p>.</span><span class=nx>translate</span> <span class=o>=</span> <span class=nx>translate</span><span class=p>;</span>
</span></span><span class=line><span class=ln> 4</span><span class=cl>		<span class=k>this</span><span class=p>.</span><span class=nx>rotate</span> <span class=o>=</span> <span class=nx>rotate</span><span class=p>;</span>
</span></span><span class=line><span class=ln> 5</span><span class=cl>        <span class=k>this</span><span class=p>.</span><span class=nx>scale</span> <span class=o>=</span> <span class=nx>scale</span><span class=p>;</span>
</span></span><span class=line><span class=ln> 6</span><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=ln> 7</span><span class=cl>    
</span></span><span class=line><span class=ln> 8</span><span class=cl><span class=c1>// ...
</span></span></span><span class=line><span class=ln> 9</span><span class=cl><span class=c1></span>
</span></span><span class=line><span class=ln>10</span><span class=cl><span class=c1>// Mesh Ctor
</span></span></span><span class=line><span class=ln>11</span><span class=cl><span class=c1></span>		<span class=kr>const</span> <span class=nx>modelTranslation</span> <span class=o>=</span> <span class=p>[</span><span class=nx>transform</span><span class=p>.</span><span class=nx>modelTransX</span><span class=p>,</span> <span class=nx>transform</span><span class=p>.</span><span class=nx>modelTransY</span><span class=p>,</span> <span class=nx>transform</span><span class=p>.</span><span class=nx>modelTransZ</span><span class=p>];</span>
</span></span><span class=line><span class=ln>12</span><span class=cl>		<span class=kr>const</span> <span class=nx>modelRotation</span> <span class=o>=</span> <span class=p>[</span><span class=nx>transform</span><span class=p>.</span><span class=nx>modelRotateX</span><span class=p>,</span> <span class=nx>transform</span><span class=p>.</span><span class=nx>modelRotateY</span><span class=p>,</span> <span class=nx>transform</span><span class=p>.</span><span class=nx>modelRotateZ</span><span class=p>];</span>
</span></span><span class=line><span class=ln>13</span><span class=cl>		<span class=kr>const</span> <span class=nx>modelScale</span> <span class=o>=</span> <span class=p>[</span><span class=nx>transform</span><span class=p>.</span><span class=nx>modelScaleX</span><span class=p>,</span> <span class=nx>transform</span><span class=p>.</span><span class=nx>modelScaleY</span><span class=p>,</span> <span class=nx>transform</span><span class=p>.</span><span class=nx>modelScaleZ</span><span class=p>];</span>
</span></span><span class=line><span class=ln>14</span><span class=cl>		<span class=kd>let</span> <span class=nx>meshTrans</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>TRSTransform</span><span class=p>(</span><span class=nx>modelTranslation</span><span class=p>,</span> <span class=nx>modelRotation</span><span class=p>,</span> <span class=nx>modelScale</span><span class=p>);</span>
</span></span></code></pre></div><p>å›åˆ° loadOBJ.jsï¼Œä»ä¼ å…¥çš„ <code>transform</code> ä¸­è§£ææ¨¡å‹æ—‹è½¬ï¼Œç„¶åä¼ å…¥ material çš„ build å‡½æ•°ï¼š</p><p><img loading=lazy src=https://raw.gitmirror.com/congyuxiaoyoudao/Picgo-ImageBed/main/Assignments/Assignment%204.GAMES202HW1/202504152005867.png></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=ln>1</span><span class=cl><span class=c1>// object.traverse
</span></span></span><span class=line><span class=ln>2</span><span class=cl><span class=c1></span><span class=kd>let</span> <span class=nx>Translation</span> <span class=o>=</span> <span class=p>[</span><span class=nx>transform</span><span class=p>.</span><span class=nx>modelTransX</span><span class=p>,</span> <span class=nx>transform</span><span class=p>.</span><span class=nx>modelTransY</span><span class=p>,</span> <span class=nx>transform</span><span class=p>.</span><span class=nx>modelTransZ</span><span class=p>];</span>
</span></span><span class=line><span class=ln>3</span><span class=cl><span class=kd>let</span> <span class=nx>Rotation</span> <span class=o>=</span> <span class=p>[</span><span class=nx>transform</span><span class=p>.</span><span class=nx>modelRotateX</span><span class=p>,</span> <span class=nx>transform</span><span class=p>.</span><span class=nx>modelRotateY</span><span class=p>,</span> <span class=nx>transform</span><span class=p>.</span><span class=nx>modelRotateZ</span><span class=p>];</span>
</span></span><span class=line><span class=ln>4</span><span class=cl><span class=kd>let</span> <span class=nx>Scale</span> <span class=o>=</span> <span class=p>[</span><span class=nx>transform</span><span class=p>.</span><span class=nx>modelScaleX</span><span class=p>,</span> <span class=nx>transform</span><span class=p>.</span><span class=nx>modelScaleY</span><span class=p>,</span> <span class=nx>transform</span><span class=p>.</span><span class=nx>modelScaleZ</span><span class=p>];</span>
</span></span><span class=line><span class=ln>5</span><span class=cl>
</span></span><span class=line><span class=ln>6</span><span class=cl><span class=nx>material</span> <span class=o>=</span> <span class=nx>buildPhongMaterial</span><span class=p>(</span><span class=nx>colorMap</span><span class=p>,</span> <span class=nx>mat</span><span class=p>.</span><span class=nx>specular</span><span class=p>.</span><span class=nx>toArray</span><span class=p>(),</span> <span class=nx>light</span><span class=p>,</span> <span class=nx>Translation</span><span class=p>,</span> <span class=nx>Rotation</span><span class=p>,</span> <span class=nx>Scale</span><span class=p>,</span> <span class=s2>&#34;./src/shaders/phongShader/phongVertex.glsl&#34;</span><span class=p>,</span> <span class=s2>&#34;./src/shaders/phongShader/phongFragment.glsl&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=ln>7</span><span class=cl><span class=nx>shadowMaterial</span> <span class=o>=</span> <span class=nx>buildShadowMaterial</span><span class=p>(</span><span class=nx>light</span><span class=p>,</span> <span class=nx>Translation</span><span class=p>,</span> <span class=nx>Rotation</span><span class=p>,</span> <span class=nx>Scale</span><span class=p>,</span> <span class=s2>&#34;./src/shaders/shadowShader/shadowVertex.glsl&#34;</span><span class=p>,</span> <span class=s2>&#34;./src/shaders/shadowShader/shadowFragment.glsl&#34;</span><span class=p>);</span>
</span></span></code></pre></div><p>ç„¶åè‡ªç„¶éœ€è¦å¯¹ <code>material</code> çš„å˜æ¢è¿›è¡Œæ”¯æŒï¼Œä¾æ¬¡åœ¨ PhongMaterial.js å’Œ ShadowMaterial.js ä¸­ä¸ºä¸Šè¿°åˆ›å»ºæè´¨çš„å‡½æ•°æ·»åŠ å¯¹æ—‹è½¬çš„æ”¯æŒï¼š</p><p>PhongMaterial.js ä¸­ï¼š</p><p><img loading=lazy src=https://raw.gitmirror.com/congyuxiaoyoudao/Picgo-ImageBed/main/Assignments/Assignment%204.GAMES202HW1/202504152014479.png></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=ln> 1</span><span class=cl><span class=c1>// PhongMaterial Ctor
</span></span></span><span class=line><span class=ln> 2</span><span class=cl><span class=c1></span>    <span class=nx>constructor</span><span class=p>(</span><span class=nx>color</span><span class=p>,</span> <span class=nx>specular</span><span class=p>,</span> <span class=nx>light</span><span class=p>,</span> <span class=nx>translate</span><span class=p>,</span> <span class=nx>rotate</span><span class=p>,</span> <span class=nx>scale</span><span class=p>,</span> <span class=nx>vertexShader</span><span class=p>,</span> <span class=nx>fragmentShader</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=ln> 3</span><span class=cl>        <span class=kd>let</span> <span class=nx>lightMVP</span> <span class=o>=</span> <span class=nx>light</span><span class=p>.</span><span class=nx>CalcLightMVP</span><span class=p>(</span><span class=nx>translate</span><span class=p>,</span> <span class=nx>rotate</span><span class=p>,</span> <span class=nx>scale</span><span class=p>);</span>
</span></span><span class=line><span class=ln> 4</span><span class=cl>
</span></span><span class=line><span class=ln> 5</span><span class=cl><span class=c1>// material builder function
</span></span></span><span class=line><span class=ln> 6</span><span class=cl><span class=c1></span><span class=kr>async</span> <span class=kd>function</span> <span class=nx>buildPhongMaterial</span><span class=p>(</span><span class=nx>color</span><span class=p>,</span> <span class=nx>specular</span><span class=p>,</span> <span class=nx>light</span><span class=p>,</span> <span class=nx>translate</span><span class=p>,</span> <span class=nx>rotate</span><span class=p>,</span> <span class=nx>scale</span><span class=p>,</span> <span class=nx>vertexPath</span><span class=p>,</span> <span class=nx>fragmentPath</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=ln> 7</span><span class=cl>
</span></span><span class=line><span class=ln> 8</span><span class=cl>    <span class=kd>let</span> <span class=nx>vertexShader</span> <span class=o>=</span> <span class=kr>await</span> <span class=nx>getShaderString</span><span class=p>(</span><span class=nx>vertexPath</span><span class=p>);</span>
</span></span><span class=line><span class=ln> 9</span><span class=cl>    <span class=kd>let</span> <span class=nx>fragmentShader</span> <span class=o>=</span> <span class=kr>await</span> <span class=nx>getShaderString</span><span class=p>(</span><span class=nx>fragmentPath</span><span class=p>);</span>
</span></span><span class=line><span class=ln>10</span><span class=cl>    <span class=k>return</span> <span class=k>new</span> <span class=nx>PhongMaterial</span><span class=p>(</span><span class=nx>color</span><span class=p>,</span> <span class=nx>specular</span><span class=p>,</span> <span class=nx>light</span><span class=p>,</span> <span class=nx>translate</span><span class=p>,</span> <span class=nx>rotate</span><span class=p>,</span> <span class=nx>scale</span><span class=p>,</span> <span class=nx>vertexShader</span><span class=p>,</span> <span class=nx>fragmentShader</span><span class=p>);</span>
</span></span><span class=line><span class=ln>11</span><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>åŒæ ·ï¼ŒShadowMaterial.js ä¸­ï¼š</p><p><img loading=lazy src=https://raw.gitmirror.com/congyuxiaoyoudao/Picgo-ImageBed/main/Assignments/Assignment%204.GAMES202HW1/202504152017642.png></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=ln> 1</span><span class=cl><span class=kr>class</span> <span class=nx>ShadowMaterial</span> <span class=kr>extends</span> <span class=nx>Material</span> <span class=p>{</span>
</span></span><span class=line><span class=ln> 2</span><span class=cl>    <span class=nx>constructor</span><span class=p>(</span><span class=nx>light</span><span class=p>,</span> <span class=nx>translate</span><span class=p>,</span> <span class=nx>rotate</span><span class=p>,</span> <span class=nx>scale</span><span class=p>,</span> <span class=nx>vertexShader</span><span class=p>,</span> <span class=nx>fragmentShader</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=ln> 3</span><span class=cl>        <span class=kd>let</span> <span class=nx>lightMVP</span> <span class=o>=</span> <span class=nx>light</span><span class=p>.</span><span class=nx>CalcLightMVP</span><span class=p>(</span><span class=nx>translate</span><span class=p>,</span> <span class=nx>rotate</span><span class=p>,</span> <span class=nx>scale</span><span class=p>);</span>
</span></span><span class=line><span class=ln> 4</span><span class=cl>        <span class=kr>super</span><span class=p>({</span>
</span></span><span class=line><span class=ln> 5</span><span class=cl>            <span class=s1>&#39;uLightMVP&#39;</span><span class=o>:</span> <span class=p>{</span> <span class=nx>type</span><span class=o>:</span> <span class=s1>&#39;matrix4fv&#39;</span><span class=p>,</span> <span class=nx>value</span><span class=o>:</span> <span class=nx>lightMVP</span> <span class=p>}</span>
</span></span><span class=line><span class=ln> 6</span><span class=cl>        <span class=p>},</span> <span class=p>[],</span> <span class=nx>vertexShader</span><span class=p>,</span> <span class=nx>fragmentShader</span><span class=p>,</span> <span class=nx>light</span><span class=p>.</span><span class=nx>fbo</span><span class=p>);</span>
</span></span><span class=line><span class=ln> 7</span><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=ln> 8</span><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=ln> 9</span><span class=cl>
</span></span><span class=line><span class=ln>10</span><span class=cl><span class=kr>async</span> <span class=kd>function</span> <span class=nx>buildShadowMaterial</span><span class=p>(</span><span class=nx>light</span><span class=p>,</span> <span class=nx>translate</span><span class=p>,</span> <span class=nx>rotate</span><span class=p>,</span> <span class=nx>scale</span><span class=p>,</span> <span class=nx>vertexPath</span><span class=p>,</span> <span class=nx>fragmentPath</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>11</span><span class=cl>    <span class=kd>let</span> <span class=nx>vertexShader</span> <span class=o>=</span> <span class=kr>await</span> <span class=nx>getShaderString</span><span class=p>(</span><span class=nx>vertexPath</span><span class=p>);</span>
</span></span><span class=line><span class=ln>12</span><span class=cl>    <span class=kd>let</span> <span class=nx>fragmentShader</span> <span class=o>=</span> <span class=kr>await</span> <span class=nx>getShaderString</span><span class=p>(</span><span class=nx>fragmentPath</span><span class=p>);</span>
</span></span><span class=line><span class=ln>13</span><span class=cl>    <span class=k>return</span> <span class=k>new</span> <span class=nx>ShadowMaterial</span><span class=p>(</span><span class=nx>light</span><span class=p>,</span> <span class=nx>translate</span><span class=p>,</span><span class=nx>rotate</span><span class=p>,</span> <span class=nx>scale</span><span class=p>,</span> <span class=nx>vertexShader</span><span class=p>,</span> <span class=nx>fragmentShader</span><span class=p>);</span>
</span></span><span class=line><span class=ln>14</span><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>æ³¨æ„åˆ°ï¼Œä¸Šé¢ä¼ é€’çš„ <code>lightMVP</code> çŸ©é˜µæ˜¯é€šè¿‡ <code>CalcLightMVP</code> è®¡ç®—çš„ï¼Œæ‰€ä»¥ä¸‹ä¸€æ­¥ä¸ºå…¶å¢åŠ å¯¹æ—‹è½¬çš„æ”¯æŒï¼ŒDirectionalLight.js ä¸­ï¼š</p><p><img loading=lazy src=https://raw.gitmirror.com/congyuxiaoyoudao/Picgo-ImageBed/main/Assignments/Assignment%204.GAMES202HW1/202504152024830.png></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=ln> 1</span><span class=cl>    <span class=nx>CalcLightMVP</span><span class=p>(</span><span class=nx>translate</span><span class=p>,</span> <span class=nx>rotate</span><span class=p>,</span> <span class=nx>scale</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=ln> 2</span><span class=cl>        <span class=kd>let</span> <span class=nx>lightMVP</span> <span class=o>=</span> <span class=nx>mat4</span><span class=p>.</span><span class=nx>create</span><span class=p>();</span>
</span></span><span class=line><span class=ln> 3</span><span class=cl>        <span class=kd>let</span> <span class=nx>modelMatrix</span> <span class=o>=</span> <span class=nx>mat4</span><span class=p>.</span><span class=nx>create</span><span class=p>();</span>
</span></span><span class=line><span class=ln> 4</span><span class=cl>        <span class=kd>let</span> <span class=nx>viewMatrix</span> <span class=o>=</span> <span class=nx>mat4</span><span class=p>.</span><span class=nx>create</span><span class=p>();</span>
</span></span><span class=line><span class=ln> 5</span><span class=cl>        <span class=kd>let</span> <span class=nx>projectionMatrix</span> <span class=o>=</span> <span class=nx>mat4</span><span class=p>.</span><span class=nx>create</span><span class=p>();</span>
</span></span><span class=line><span class=ln> 6</span><span class=cl>        
</span></span><span class=line><span class=ln> 7</span><span class=cl>        <span class=c1>// Model transform
</span></span></span><span class=line><span class=ln> 8</span><span class=cl><span class=c1></span>        <span class=nx>mat4</span><span class=p>.</span><span class=nx>translate</span><span class=p>(</span><span class=nx>modelMatrix</span><span class=p>,</span> <span class=nx>modelMatrix</span><span class=p>,</span> <span class=nx>translate</span><span class=p>);</span>
</span></span><span class=line><span class=ln> 9</span><span class=cl>        <span class=nx>mat4</span><span class=p>.</span><span class=nx>rotateX</span><span class=p>(</span><span class=nx>modelMatrix</span><span class=p>,</span> <span class=nx>modelMatrix</span><span class=p>,</span> <span class=nx>rotate</span><span class=p>[</span><span class=mi>0</span><span class=p>]);</span>
</span></span><span class=line><span class=ln>10</span><span class=cl>        <span class=nx>mat4</span><span class=p>.</span><span class=nx>rotateY</span><span class=p>(</span><span class=nx>modelMatrix</span><span class=p>,</span> <span class=nx>modelMatrix</span><span class=p>,</span> <span class=nx>rotate</span><span class=p>[</span><span class=mi>1</span><span class=p>]);</span>
</span></span><span class=line><span class=ln>11</span><span class=cl>        <span class=nx>mat4</span><span class=p>.</span><span class=nx>rotateZ</span><span class=p>(</span><span class=nx>modelMatrix</span><span class=p>,</span> <span class=nx>modelMatrix</span><span class=p>,</span> <span class=nx>rotate</span><span class=p>[</span><span class=mi>2</span><span class=p>]);</span>
</span></span><span class=line><span class=ln>12</span><span class=cl>        <span class=nx>mat4</span><span class=p>.</span><span class=nx>scale</span><span class=p>(</span><span class=nx>modelMatrix</span><span class=p>,</span> <span class=nx>modelMatrix</span><span class=p>,</span> <span class=nx>scale</span><span class=p>);</span>
</span></span></code></pre></div><blockquote><p>è®°å¾—æŠŠä¸Šé¢ç¯çš„ Meshï¼ˆcubeï¼‰æ¨¡å‹å˜æ¢çš„æ—‹è½¬å‚æ•°åŠ ä¸Š</p></blockquote><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=ln>1</span><span class=cl><span class=c1>// DirectionalLight Ctor
</span></span></span><span class=line><span class=ln>2</span><span class=cl><span class=c1></span><span class=k>this</span><span class=p>.</span><span class=nx>mesh</span> <span class=o>=</span> <span class=nx>Mesh</span><span class=p>.</span><span class=nx>cube</span><span class=p>(</span><span class=nx>setTransform</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> Â  Â <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> Â  Â <span class=mf>0.2</span><span class=p>,</span> <span class=mf>0.2</span><span class=p>,</span> <span class=mf>0.2</span><span class=p>,</span> Â  Â <span class=mi>0</span><span class=p>));</span>
</span></span></code></pre></div><p>æœ€åï¼Œæ¸²æŸ“å¾ªç¯æ¯ä¸€å¸§ç»˜åˆ¶æ—¶ä¼šè°ƒç”¨ <code>WebGLRenderer</code> çš„ <code>render</code> å‡½æ•°ï¼Œåè€…åˆä¼šä¸ºæ¯ä¸€ä¸ªå®ä½“è°ƒç”¨å…¶ <code>meshRender</code> çš„ <code>draw</code> å‡½æ•°ï¼Œè¯¥å‡½æ•°éœ€è¦è°ƒç”¨ <code>bindCameraParameters</code>ï¼Œè¿™é‡Œå‘ Shader ä¼ é€’äº†ä½œä¸º <code>uniform</code> çš„æ¨¡å‹å˜æ¢çŸ©é˜µï¼Œåœ¨è¿™é‡ŒåŠ ä¸Šæ—‹è½¬ï¼ˆMeshRender.js ä¸­ï¼‰ï¼š</p><p><img loading=lazy src=https://raw.gitmirror.com/congyuxiaoyoudao/Picgo-ImageBed/main/Assignments/Assignment%204.GAMES202HW1/202504152038588.png></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=ln>1</span><span class=cl><span class=nx>mat4</span><span class=p>.</span><span class=nx>rotateX</span><span class=p>(</span><span class=nx>modelMatrix</span><span class=p>,</span> <span class=nx>modelMatrix</span><span class=p>,</span> <span class=k>this</span><span class=p>.</span><span class=nx>mesh</span><span class=p>.</span><span class=nx>transform</span><span class=p>.</span><span class=nx>rotate</span><span class=p>[</span><span class=mi>0</span><span class=p>]);</span>
</span></span><span class=line><span class=ln>2</span><span class=cl><span class=nx>mat4</span><span class=p>.</span><span class=nx>rotateY</span><span class=p>(</span><span class=nx>modelMatrix</span><span class=p>,</span> <span class=nx>modelMatrix</span><span class=p>,</span> <span class=k>this</span><span class=p>.</span><span class=nx>mesh</span><span class=p>.</span><span class=nx>transform</span><span class=p>.</span><span class=nx>rotate</span><span class=p>[</span><span class=mi>1</span><span class=p>]);</span>
</span></span><span class=line><span class=ln>3</span><span class=cl><span class=nx>mat4</span><span class=p>.</span><span class=nx>rotateZ</span><span class=p>(</span><span class=nx>modelMatrix</span><span class=p>,</span> <span class=nx>modelMatrix</span><span class=p>,</span> <span class=k>this</span><span class=p>.</span><span class=nx>mesh</span><span class=p>.</span><span class=nx>transform</span><span class=p>.</span><span class=nx>rotate</span><span class=p>[</span><span class=mi>2</span><span class=p>]);</span>
</span></span></code></pre></div><p>å¯¹æ—‹è½¬çš„æ”¯æŒåˆ°è¿™é‡Œå°±å·®ä¸å¤šäº†ï¼Œç°åœ¨æˆ‘ä»¬éœ€è¦è®©æ¨¡å‹éšç€æ—¶é—´æŒ‰ Y è½´æ—‹è½¬ï¼Œæˆ‘ä»¬å¯ä»¥ä»å¾ªç¯é‡Œæ‹¿åˆ°å½“å‰æ—¶é—´ï¼Œç„¶åä¸ä¿å­˜çš„æ—¶é—´ç›¸å‡å¾—åˆ°å·®å€¼ï¼Œå‘ <code>render</code> å‡½æ•°ä¼ å…¥è¿™ä¸ªå·®å€¼ç„¶åæ¯å¸§ç´¯åŠ ä¸€ä¸ªæ—‹è½¬è§’åº¦å³å¯ã€‚</p><p><img loading=lazy src=https://raw.gitmirror.com/congyuxiaoyoudao/Picgo-ImageBed/main/Assignments/Assignment%204.GAMES202HW1/202504152100714.png></p><p>æœ€åï¼Œåœ¨ WebGLRenderer.jsï¼Œ<code>render</code> å‡½æ•°ä¸­æ¯å¸§éœ€è¦æ›´æ–°å…‰æºå¯¹åº”çš„ FBOï¼ˆå¸§ç¼“å†²åŒºï¼‰ï¼Œå¦åˆ™ ShadowMap çš„å†…å®¹ä¼šæ¯å¸§å åŠ ï¼Œä»¥åŠæ›´æ–°ä¼ å…¥ Shader çš„ <code>uniform</code> å˜é‡ã€‚</p><p><img loading=lazy src=https://raw.gitmirror.com/congyuxiaoyoudao/Picgo-ImageBed/main/Assignments/Assignment%204.GAMES202HW1/202504152125258.png></p><p>è¿™é‡Œ <code>updateMVP</code> æ˜¯æˆ‘è‡ªå®šä¹‰çš„ä¸€ä¸ªå‡½æ•°ï¼š</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=ln>1</span><span class=cl>    <span class=nx>updateMVP</span><span class=p>(</span><span class=nx>mesh</span><span class=p>,</span> <span class=nx>lightEntity</span><span class=p>){</span>
</span></span><span class=line><span class=ln>2</span><span class=cl>        <span class=kd>let</span> <span class=nx>translate</span> <span class=o>=</span> <span class=nx>mesh</span><span class=p>.</span><span class=nx>transform</span><span class=p>.</span><span class=nx>translate</span><span class=p>;</span>
</span></span><span class=line><span class=ln>3</span><span class=cl>        <span class=kd>let</span> <span class=nx>rotate</span> <span class=o>=</span> <span class=nx>mesh</span><span class=p>.</span><span class=nx>transform</span><span class=p>.</span><span class=nx>rotate</span><span class=p>;</span>
</span></span><span class=line><span class=ln>4</span><span class=cl>        <span class=kd>let</span> <span class=nx>scale</span> <span class=o>=</span> <span class=nx>mesh</span><span class=p>.</span><span class=nx>transform</span><span class=p>.</span><span class=nx>scale</span><span class=p>;</span>
</span></span><span class=line><span class=ln>5</span><span class=cl>        <span class=kd>let</span> <span class=nx>MVP</span> <span class=o>=</span> <span class=nx>lightEntity</span><span class=p>.</span><span class=nx>CalcLightMVP</span><span class=p>(</span><span class=nx>translate</span><span class=p>,</span> <span class=nx>rotate</span><span class=p>,</span> <span class=nx>scale</span><span class=p>);</span>
</span></span><span class=line><span class=ln>6</span><span class=cl>        <span class=k>return</span> <span class=nx>MVP</span><span class=p>;</span>
</span></span><span class=line><span class=ln>7</span><span class=cl>    <span class=p>}</span>
</span></span></code></pre></div><p>å®Œæˆä¹‹åå°±å¯ä»¥è½¬<del>åœˆ</del>åœˆ~</p><p><img alt="è½¬<del>åœˆ</del>åœˆ~" loading=lazy src=https://raw.gitmirror.com/congyuxiaoyoudao/Picgo-ImageBed/main/Assignments/Assignment%204.GAMES202HW1/202504152139014.gif></p></div><footer class=post-footer><ul class=post-tags></ul><nav class=paginav><a class=next href=https://congyuxiaoyoudao.github.io/posts/assignments/assignment-3.-games202-homework-0/><span class=title>ä¸‹ä¸€é¡µ Â»</span><br><span></span></a></nav></footer><div id=tw-comment></div><script>const getStoredTheme=()=>localStorage.getItem("pref-theme")==="light"?"light":"noborder_dark",setGiscusTheme=()=>{const e=e=>{const t=document.querySelector("iframe.giscus-frame");t&&t.contentWindow.postMessage({giscus:e},"https://giscus.app")};e({setConfig:{theme:getStoredTheme()}})};document.addEventListener("DOMContentLoaded",()=>{const s={src:"https://giscus.app/client.js","data-repo":"congyuxiaoyoudao/congyuxiaoyoudao.github.io","data-repo-id":"","data-category":"Announcements","data-category-id":"","data-mapping":"pathname","data-strict":"0","data-reactions-enabled":"","data-emit-metadata":"","data-input-position":"","data-theme":getStoredTheme(),"data-lang":"zh-CN","data-loading":"lazy",crossorigin:"anonymous"},e=document.createElement("script");Object.entries(s).forEach(([t,n])=>e.setAttribute(t,n)),document.querySelector("#tw-comment").appendChild(e);const t=document.querySelector("#theme-toggle");t&&t.addEventListener("click",setGiscusTheme);const n=document.querySelector("#theme-toggle-float");n&&n.addEventListener("click",setGiscusTheme)})</script></article></main><footer class=footer><span>&copy; 2025 <a href=https://congyuxiaoyoudao.github.io/>The Only Problem's Blog</a></span> Â·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
<a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentColor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="å¤åˆ¶";function s(){t.innerHTML="å·²å¤åˆ¶ï¼",setTimeout(()=>{t.innerHTML="å¤åˆ¶"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>